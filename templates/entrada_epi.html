<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Entrada de Estoque - Sistema Recic3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .filter-section { background-color: #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 5px solid #198754; }
        .label-admin { color: #0d6efd; font-weight: bold; font-size: 0.8em; }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-7">
                <div class="card p-4">
                    <h4 class="mb-4 text-success"><i class="fas fa-boxes"></i> Nova Entrada de EPI</h4>
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="filter-section">
                        <small class="text-muted fw-bold d-block mb-2 text-uppercase"><i class="fas fa-filter"></i> 1. Encontre o item no catálogo</small>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <select class="form-select" id="busca_categoria" onchange="atualizarListaEPIs()">
                                    <option value="">Todas as Categorias</option>
                                    <option value="Alta Visibilidade / Sinalização">Alta Visibilidade</option>
                                    <option value="Proteção Auditiva">Proteção Auditiva</option>
                                    <option value="Proteção das Mãos e Braços">Proteção das Mãos</option>
                                    <option value="Proteção do Tronco e Corpo">Proteção do Tronco</option>
                                    <option value="Proteção dos Olhos e Face">Proteção Olhos/Face</option>
                                    <option value="Proteção dos Pés e Pernas">Proteção Pés/Pernas</option>
                                    <option value="Proteção Respiratória">Proteção Respiratória</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="busca_texto" 
                                           placeholder="Nome ou C.A..." onkeyup="atualizarListaEPIs()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('entrada_epi') }}">
                        
                        {% if usuario and usuario.role == 'admin' %}
                        <div class="mb-3 p-2 border border-primary rounded bg-light">
                            <label for="uvr_destino" class="label-admin"><i class="fas fa-user-shield"></i> DESTINO DA ENTRADA (ADMIN)</label>
                            <select class="form-select form-select-sm" name="uvr_destino" id="uvr_destino">
                                <option value="UVR 01" {% if usuario.uvr_acesso == 'UVR 01' %}selected{% endif %}>UVR 01</option>
                                <option value="UVR 02" {% if usuario.uvr_acesso == 'UVR 02' %}selected{% endif %}>UVR 02</option>
                                <option value="ADM">Administração Central</option>
                            </select>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="id_item" class="form-label fw-bold">Item do Catálogo *</label>
                            <select class="form-select form-select-lg border-success" name="id_item" id="id_item" required>
                                <option value="">-- Use os filtros acima --</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="marca" class="form-label">Marca / Fabricante</label>
                                <input type="text" class="form-control" name="marca" id="marca" placeholder="Ex: Volk, Kalipso...">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="unidade" class="form-label">Unidade de Medida</label>
                                <select class="form-select" name="unidade" id="unidade">
                                    <option value="par">Par</option>
                                    <option value="un" selected>Unidade (Peça)</option>
                                    <option value="kit">Kit</option>
                                    <option value="cx">Caixa</option>
                                    <option value="pct">Pacote</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="quantidade" class="form-label fw-bold">Quantidade Recebida *</label>
                            <input type="number" class="form-control form-control-lg" name="quantidade" id="quantidade" min="1" step="0.001" required placeholder="0">
                        </div>

                        <div class="mb-3">
                            <label for="observacao" class="form-label">Origem / Observação</label>
                            <textarea class="form-control" name="observacao" rows="2" placeholder="Ex: Compra NF 123 ou Doação"></textarea>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-plus-circle"></i> Confirmar Entrada no Estoque
                            </button>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Voltar ao Menu</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function atualizarListaEPIs() {
            const categoria = document.getElementById('busca_categoria').value;
            const texto = document.getElementById('busca_texto').value;
            const selectEpi = document.getElementById('id_item');

            selectEpi.innerHTML = '<option value="">Buscando itens...</option>';

            fetch(`/api/get_epis_filtrados?q=${encodeURIComponent(texto)}&categoria=${encodeURIComponent(categoria)}`)
                .then(response => response.json())
                .then(data => {
                    selectEpi.innerHTML = '<option value="">-- Selecione o item correto --</option>';
                    
                    if (data.length === 0) {
                        selectEpi.innerHTML = '<option value="">Nenhum item encontrado</option>';
                        return;
                    }

                    data.forEach(epi => {
                        const option = document.createElement('option');
                        option.value = epi.id;
                        option.textContent = `${epi.nome} (CA: ${epi.ca || 'N/A'})`;
                        selectEpi.appendChild(option);
                    });
                })
                .catch(err => {
                    console.error("Erro ao buscar EPIs:", err);
                    selectEpi.innerHTML = '<option value="">Erro ao carregar lista</option>';
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            atualizarListaEPIs();
        });
    </script>
</body>
</html>