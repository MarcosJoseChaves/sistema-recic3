<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Cadastros e Transações</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* --- ESTILO GERAL --- */
        body { padding: 20px; background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        
        /* --- FORM CONTAINERS --- */
        .form-container { 
            max-width: 1200px; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.1); 
            margin-top: 20px; 
            display: none; /* Começa oculto */
        }

        h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .required-field::after { content: "*"; color: red; margin-left: 5px; }
        
        /* --- ESTILO DO DASHBOARD --- */
        .dashboard-card {
            transition: transform 0.2s;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .card-header-custom {
            border-radius: 12px 12px 0 0 !important;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            padding: 15px;
        }
        .btn-dashboard {
            text-align: left;
            margin-bottom: 8px;
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: 500;
        }
        .btn-dashboard i {
            width: 25px;
            text-align: center;
            margin-right: 8px;
        }
        .btn-group-dashboard {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .btn-group-dashboard .btn {
            flex: 1;
        }

        /* --- UTILITÁRIOS --- */
        .item-row { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #dee2e6; position: relative; }
        .remover-item { position: absolute; top: 10px; right: 10px; }
        .valor-monetario { font-weight: bold; color: #2980b9; }
        .tabela-container { overflow-x: auto; margin-top: 20px; }
        #tabelaRelatorio th { white-space: nowrap; }
        .status-alert { cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <h3>Sistema de Gestão - {{ usuario.nome_completo if usuario else 'Visitante' }} 
            <small class="text-muted fs-6">({{ usuario.uvr_acesso if usuario and usuario.uvr_acesso else 'Admin' }})</small>
        </h3>
        <div>
            <a href="/alterar_senha" class="btn btn-outline-secondary btn-sm me-2"><i class="fas fa-key"></i> Alterar Senha</a>
            <a href="/logout" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>
    </div>

    {% if status_resumo %}
        {% if current_user.role != 'admin' %}
        {% if status_resumo.aprovados %}
          <div class="alert alert-success shadow-sm status-alert" role="alert" data-alert-key="status-aprovados">
            Você tem {{ status_resumo.aprovados }} documento(s) aprovado(s). Confira a lista em Documentos.
          </div>
        {% endif %}
        {% if status_resumo.reprovados %}
          <div class="alert alert-warning shadow-sm status-alert" role="alert" data-alert-key="status-reprovados">
            Você tem {{ status_resumo.reprovados }} documento(s) com correções pendentes. Veja o motivo em Documentos.
          </div>
        {% endif %}
      {% else %}
        {% if status_resumo.pendentes %}
          <div class="alert alert-info shadow-sm status-alert" role="alert" data-alert-key="status-pendentes">
            Existem {{ status_resumo.pendentes }} documento(s) aguardando conferência dos usuários.
          </div>
        {% endif %}
      {% endif %}
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.status-alert[data-alert-key]');
            let storageAvailable = false;

            try {
                const testKey = '__status_alert_test__';
                localStorage.setItem(testKey, '1');
                localStorage.removeItem(testKey);
                storageAvailable = true;
            } catch (error) {
                storageAvailable = false;
            }

            alerts.forEach(function(alertEl) {
                const key = alertEl.dataset.alertKey;
                if (storageAvailable && localStorage.getItem(key) === 'dismissed') {
                    alertEl.remove();
                    return;
                }

                alertEl.addEventListener('click', function() {
                    if (storageAvailable) {
                        localStorage.setItem(key, 'dismissed');
                    }
                    alertEl.remove();
                });
            });
        });
    </script>

    <div class="d-flex flex-wrap gap-2 mb-4">
        
        <button class="btn btn-primary" onclick="mostrarFormulario('associadoForm')">
            <i class="fas fa-user-plus"></i> Novo Cadastro
        </button>
        
        <button class="btn btn-success" onclick="mostrarFormulario('formTransacao')">
            <i class="fas fa-dollar-sign"></i> Financeiro
        </button>

        <a href="/documentos" class="btn btn-info text-white">
            <i class="fas fa-folder"></i> Documentos
        </a>

        {% if current_user.role == 'admin' %}
        <button class="btn btn-warning position-relative shadow-sm fw-bold" onclick="carregarPendenciasDoc()">
            <i class="fas fa-file-signature"></i> Docs Pendentes
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="badgePendenciasDoc" style="display:none;">0</span>
        </button>
        {% endif %}
        
    </div>
    
    <div class="container mb-5" id="menuPrincipal">
    <div class="row g-4">
        
        <div class="col-md-4">
            <div class="card h-100 dashboard-card">
                <div class="card-header card-header-custom bg-primary text-white">
                    <i class="fas fa-users me-2"></i> Cadastros Gerais
                </div>
                <div class="card-body">
                    <small class="text-muted d-block mb-2">PESSOAS & ENTIDADES</small>
                    <div class="btn-group-dashboard">
                        <button type="button" class="btn btn-success" 
                            onclick="mostrarFormulario('clienteFornecedorForm');
                                    let agora = new Date(); 
                                    let strData = agora.toLocaleDateString('pt-BR') + ' ' + agora.toLocaleTimeString('pt-BR'); 
                                    document.getElementById('visualDataCadastroCliente').value = strData; 
                                    document.getElementById('inputDataCadastroCliente').value = strData;">
                            <i class="fas fa-plus"></i> Novo
                        </button>
                        <button id="btnGestaoCadastros" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Pesquisar</button>
                    </div>

                    <div class="btn-group-dashboard">
                        <button id="btnAssociado" class="btn btn-outline-primary btn-sm" onclick="mostrarFormulario('associadoForm')">
                            <i class="fas fa-user-plus"></i> Associado
                        </button>
                        <button id="btnGestaoAssociados" class="btn btn-primary btn-sm" onclick="mostrarFormulario('gestaoAssociadosContainer'); buscarAssociados();">
                            <i class="fas fa-users"></i> Gerenciar
                        </button>
                    </div>

                    <hr>
                    <small class="text-muted d-block mb-2">PATRIMÔNIO & ESTRUTURA</small>
                    <button class="btn btn-outline-secondary w-100 btn-dashboard btn-sm" onclick="mostrarFormulario('gestaoPatrimonioContainer')">
                        <i class="fas fa-truck-moving"></i> Frota & Equipamentos
                    </button>

                    <hr>
                    <small class="text-muted d-block mb-2">GESTÃO DE EPIs</small>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('cadastrar_epi') }}" class="btn btn-outline-secondary btn-dashboard btn-sm text-start">
                            <i class="fas fa-helmet-safety me-2"></i> 1. Cadastrar Tipos de EPI
                        </a>
                        <a href="{{ url_for('entrada_epi') }}" class="btn btn-outline-success btn-dashboard btn-sm text-start">
                            <i class="fas fa-boxes-packing me-2"></i> 2. Entrada de Estoque
                        </a>
                        <a href="{{ url_for('saldo_epis') }}" class="btn btn-outline-primary btn-dashboard btn-sm text-start">
                            <i class="fas fa-list-check me-2"></i> 3. Saldo em Estoque
                        </a>
                        <a href="{{ url_for('controle_entrega_epi') }}" class="btn btn-outline-warning btn-dashboard btn-sm text-start">
                            <i class="fas fa-clipboard-check me-2"></i> 4. Controle de Entrega de EPIs
                        </a>
                    </div>

                    <hr>
                    <small class="text-muted d-block mb-2">REGULARIDADE & ARQUIVOS</small>
                    <a href="/documentos" class="btn btn-info w-100 btn-dashboard text-white mb-2">
                        <i class="fas fa-folder-open"></i> Documentos & Certidões
                    </a>

                    {% if usuario and usuario.role == 'admin' %}
                    <hr>
                    <small class="text-muted d-block mb-2">ITENS DE COMERCIALIZAÇÃO</small>
                    <button id="btnGestaoProdutosServicos" class="btn btn-outline-secondary w-100 btn-dashboard btn-sm">
                        <i class="fas fa-box-open"></i> Catálogo de Produtos
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 dashboard-card">
                <div class="card-header card-header-custom bg-success text-white">
                    <i class="fas fa-wallet me-2"></i> Operacional Financeiro
                </div>
                <div class="card-body">
                    <small class="text-muted d-block mb-2">LANÇAMENTOS (Dia a Dia)</small>
                    <button id="btnReceitaDespesa" class="btn btn-success w-100 btn-dashboard shadow-sm"><i class="fas fa-plus-circle"></i> Nova Receita / Despesa</button>
                    <button id="btnGestaoTransacoes" class="btn btn-outline-success w-100 btn-dashboard"><i class="fas fa-search-dollar"></i> Pesquisar Transações</button>

                    <hr>
                    <small class="text-muted d-block mb-2">BANCÁRIO</small>
                    <div class="btn-group-dashboard">
                        <button id="btnContaCorrente" class="btn btn-outline-dark btn-sm"><i class="fas fa-landmark"></i> Nova Conta</button>
                        <button id="btnGestaoContas" class="btn btn-dark btn-sm"><i class="fas fa-list"></i> Listar Contas</button>
                    </div>
                </div>
            </div>
        </div>

        {% if usuario and usuario.role == 'admin' %}
        <div class="col-md-4">
            <div class="card h-100 dashboard-card">
                <div class="card-header card-header-custom bg-warning text-dark">
                    <i class="fas fa-chart-line me-2"></i> Gestão & Controle
                </div>
                <div class="card-body">
                    <small class="text-muted d-block mb-2">FLUXO DE CAIXA</small>
                    <button id="btnFluxoCaixa" class="btn btn-danger w-100 btn-dashboard mb-3 text-white"><i class="fas fa-exchange-alt"></i> Baixas & Conciliação</button>
                    
                    <small class="text-muted d-block mb-2">RELATÓRIOS</small>
                    <div class="btn-group-dashboard">
                        <button id="btnExtratoBancario" class="btn btn-outline-dark btn-sm"><i class="fas fa-file-invoice-dollar"></i> Extrato</button>
                        <button id="btnRelatorios" class="btn btn-outline-dark btn-sm"><i class="fas fa-file-alt"></i> Financeiro</button>
                    </div>
                    
                    <hr>
                    <small class="text-muted d-block mb-2">ADMINISTRAÇÃO</small>
                    <button id="btnAprovacoes" class="btn btn-warning w-100 btn-dashboard position-relative">
                        <i class="fas fa-check-double"></i> Aprovações Pendentes
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>
</div>

 <div class="container d-flex justify-content-center flex-column align-items-center">
     
<div id="associadoForm" class="form-container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-id-card text-primary"></i> Ficha de Associado</h2>
        <button type="button" class="btn-close" onclick="$('.form-container').hide(); $('#menuPrincipal').fadeIn();"></button>
    </div>

    <form action="/cadastrar_associado" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="id_associado" id="idAssociadoHidden">
        
        <div class="row mb-3 p-2 bg-light border rounded mx-0">
            <div class="col-md-3">
                <label class="form-label small text-muted">Data/Hora Cadastro</label>
                <input type="text" class="form-control form-control-sm fw-bold text-primary" id="visualDataCadastroAssociado" readonly>
                <input type="hidden" name="data_hora_cadastro" id="inputDataCadastroAssociado">
            </div>
            <div class="col-md-9 d-flex align-items-end">
                <span class="text-muted small"><i class="fas fa-info-circle"></i> Gerado automaticamente pelo servidor.</span>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label required-field">UVR</label>
                        {% set valor_uvr = usuario.uvr_acesso if usuario else '' %}
                        {% if valor_uvr in ['ADMIN', 'Gestão', '', None] %}
                            <select class="form-select" name="uvr" id="uvrSelectAssociado" required>
                                <option value="">Selecione...</option>
                                <option value="UVR 01">UVR 01</option>
                                <option value="UVR 02">UVR 02</option>
                                <option value="UVR 03">UVR 03</option>
                            </select>
                        {% else %}
                            <input type="text" class="form-control" name="uvr" id="uvrInputAssociado" value="{{ valor_uvr }}" readonly>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Associação</label>
                        <input type="text" class="form-control bg-light" name="associacao" id="associacaoInput" readonly placeholder="Automático">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label required-field">Nome Completo</label>
                        <input type="text" class="form-control" name="nome" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label required-field">CPF</label>
                        <input type="text" class="form-control cpf-mask" name="cpf" placeholder="000.000.000-00" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">RG</label>
                        <input type="text" class="form-control" name="rg">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label required-field">Data Nascimento</label>
                        <input type="date" class="form-control" name="data_nascimento" required>
                    </div>
                </div>
            </div>

            <div class="col-md-3 text-center border-start">
                <label class="form-label fw-bold">Foto (Crachá)</label>
                <div class="d-flex justify-content-center align-items-center flex-column">
                    <div class="position-relative mb-2 border bg-white shadow-sm" style="width: 135px; height: 180px; overflow: hidden; border-radius: 4px;">
                        <img id="previewFoto" src="" class="w-100 h-100" style="object-fit: cover; display: none;">
                        <div id="iconSemFotoAssociado" class="w-100 h-100 d-flex align-items-center justify-content-center">
                            <i class="fas fa-user text-light fa-5x"></i>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removerFoto()" style="border-radius: 0 0 0 5px; padding: 2px 6px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm w-100" style="max-width: 135px;">
                        <label class="btn btn-outline-secondary" for="inputFotoArquivo"><i class="fas fa-upload"></i></label>
                        <button type="button" class="btn btn-outline-primary" onclick="abrirCamera()"><i class="fas fa-camera"></i></button>
                    </div>
                    <input type="file" id="inputFotoArquivo" accept="image/*" class="d-none" onchange="processarArquivoFoto(this)">
                    <input type="hidden" name="foto_base64" id="fotoBase64">
                </div>
                
                <div id="areaCamera" class="mt-2 p-2 border rounded bg-dark shadow" style="display: none; position: absolute; z-index: 1000; width: 250px;">
                    <video id="videoCamera" autoplay playsinline class="w-100 rounded mb-2"></video>
                    <button type="button" class="btn btn-success btn-sm w-100 mb-1" onclick="tirarFoto()">Capturar</button>
                    <button type="button" class="btn btn-light btn-sm w-100" onclick="fecharCamera()">Fechar</button>
                </div>
                <canvas id="canvasProcessamento" style="display: none;"></canvas>
            </div>
        </div>

        <hr>
        <h5 class="text-muted"><i class="fas fa-map-marked-alt"></i> Endereço e Contato</h5>

        <div class="row mb-3">
            <div class="col-md-2">
                <label class="form-label required-field">CEP</label>
                <input type="text" class="form-control cep-mask" name="cep" id="cepAssociado" required>
            </div>
            <div class="col-md-5">
                <label class="form-label required-field">Logradouro</label>
                <input type="text" class="form-control" name="logradouro" id="logradouroAssociado" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Número</label>
                <input type="text" class="form-control" name="endereco_numero">
            </div>
            <div class="col-md-3">
                <label class="form-label required-field">Bairro</label>
                <input type="text" class="form-control" name="bairro" id="bairroAssociado" required>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-5">
                <label class="form-label required-field">Cidade</label>
                <input type="text" class="form-control" name="cidade" id="cidadeAssociado" required>
            </div>
            <div class="col-md-2">
                <label class="form-label required-field">UF</label>
                <input type="text" class="form-control" name="uf" id="ufAssociado" maxlength="2" required>
            </div>
            <div class="col-md-5">
                <label class="form-label required-field">Telefone</label>
                <input type="text" class="form-control phone-mask" name="telefone" required>
            </div>
        </div>

        <div class="row mb-3 p-2 bg-light border rounded mx-0">
             <div class="col-md-3">
                <label class="form-label required-field">Data de Admissão</label>
                <input type="date" class="form-control" name="data_admissao" required>
            </div>
            <div class="col-md-3">
                <label class="form-label required-field">Status</label>
                <select class="form-select" name="status" required>
                    <option value="Ativo" selected>Ativo</option>
                    <option value="Inativo">Inativo</option>
                    <option value="Suspenso">Suspenso</option>
                    <option value="Afastado">Afastado</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label required-field">Função Exercida</label>
                <select class="form-select" name="funcao" required>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Auxiliar de Ecoponto">Auxiliar de Ecoponto</option>
                    <option value="Coletor">Coletor</option>
                    <option value="Cozinha / Copa">Cozinha / Copa</option>
                    <option value="Educador Ambiental">Educador Ambiental</option>
                    <option value="Manutenção">Manutenção</option>
                    <option value="Motorista">Motorista</option>
                    <option value="Operador de Empilhadeira">Operador de Empilhadeira</option>
                    <option value="Operador de Prensa">Operador de Prensa</option>
                    <option value="Serviços Gerais">Serviços Gerais</option>
                    <option value="Triador">Triador</option>
                    <option value="Visitante">Visitante</option>
                </select>
            </div>
        </div>

        <div class="text-end mt-4">
            <button type="button" class="btn btn-secondary me-2" onclick="$('.form-container').hide(); $('#menuPrincipal').fadeIn();">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btnSalvarAssociado"><i class="fas fa-save"></i> Salvar Associado</button>
        </div>
    </form>
</div>

<div id="gestaoAssociadosContainer" class="form-container" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-users"></i> Gerenciamento de Associados</h2>
            <button type="button" class="btn-close" onclick="$('#gestaoAssociadosContainer').hide(); $('#menuPrincipal').fadeIn();"></button>
        </div>

        <div class="row mb-3 p-3 bg-light rounded border align-items-end g-2">
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted mb-1">Buscar</label>
                <input type="text" id="inputBuscaAssociado" class="form-control" placeholder="Nome ou CPF...">
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted mb-1">Status</label>
                <select id="filtroStatusAssociado" class="form-select">
                    <option value="">Todos</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                    <option value="Afastado">Afastado</option>
                    <option value="Suspenso">Suspenso</option>
                </select>
            </div>

            {% if current_user.role == 'admin' %}
            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted mb-1">UVR</label>
                <select id="filtroUvrAssociado" class="form-select">
                    <option value="">Todas</option>
                    <option value="UVR 01">UVR 01</option>
                    <option value="UVR 02">UVR 02</option>
                    <option value="UVR 03">UVR 03</option>
                </select>
            </div>
            {% endif %}

            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted mb-1">Função</label>
                <select id="filtroFuncaoAssociado" class="form-select">
                    <option value="">Todas as Funções</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Auxiliar de Ecoponto">Auxiliar de Ecoponto</option>
                    <option value="Coletor">Coletor</option>
                    <option value="Cozinha / Copa">Cozinha / Copa</option>
                    <option value="Educador Ambiental">Educador Ambiental</option>
                    <option value="Manutenção">Manutenção</option>
                    <option value="Motorista">Motorista</option>
                    <option value="Operador de Empilhadeira">Operador de Empilhadeira</option>
                    <option value="Operador de Prensa">Operador de Prensa</option>
                    <option value="Serviços Gerais">Serviços Gerais</option>
                    <option value="Triador">Triador</option>
                    <option value="Visitante">Visitante</option>
                </select>
            </div>

            <div class="col-md-2 d-grid">
                <button class="btn btn-primary" onclick="buscarAssociados()">
                    <i class="fas fa-search"></i> Filtrar
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle" id="tabelaAssociados">
                <thead class="table-dark">
                    <tr>
                        <th>Nome Completo</th>
                        <th>CPF</th>
                        <th>Status</th>
                        <th>Função</th> <th>UVR</th>
                        <th>Admissão</th>
                        <th class="text-center" style="width: 150px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaAssociadosBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modalVisualizarAssociado" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-id-card-alt"></i> Detalhes do Associado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center border-end">
                            <div class="mb-3 d-flex justify-content-center align-items-center" style="min-height: 200px;">
                                <img id="verAssocFoto" src="" class="img-fluid rounded border p-1" 
                                     style="width: 200px; height: 200px; object-fit: cover; display:none;">
                                <i id="verAssocIcone" class="fas fa-user-circle text-muted" style="font-size: 8rem;"></i>
                            </div>
                            
                            <span id="verAssocStatus" class="badge bg-secondary fs-6 mb-2">Status</span>
                            <h5 id="verAssocUvr" class="text-primary fw-bold">UVR</h5>
                        </div>

                        <div class="col-md-8">
                            <h4 id="verAssocNome" class="fw-bold mb-1">Nome do Associado</h4>
                            
                            <div class="mb-3">
                                <span class="badge bg-warning text-dark p-2">
                                    <i class="fas fa-hard-hat"></i> <span id="verAssocFuncao">---</span>
                                </span>
                            </div>

                            <div class="row mb-2">
                                <div class="col-6"><strong>CPF:</strong> <span id="verAssocCpf"></span></div>
                                <div class="col-6"><strong>RG:</strong> <span id="verAssocRg"></span></div>
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-6"><strong>Nascimento:</strong> <span id="verAssocNasc"></span></div>
                                <div class="col-6"><strong>Admissão:</strong> <span id="verAssocAdm"></span></div>
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-12"><strong>Telefone:</strong> <span id="verAssocTel"></span></div>
                            </div>
                            
                            <hr>
                            
                            <p class="mb-1"><i class="fas fa-map-marker-alt text-danger"></i> <strong>Endereço Completo:</strong></p>
                            <p id="verAssocEndereco" class="text-muted bg-light p-2 rounded">...</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnImprimirNoModal"><i class="fas fa-print"></i> Imprimir Ficha</button>
                    <button type="button" class="btn btn-warning text-white" id="btnEditarNoModal" data-bs-dismiss="modal"><i class="fas fa-edit"></i> Editar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Webcam (Genérico) -->
    <div class="modal fade" id="modalWebcam" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-camera"></i> Capturar Foto</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="fecharModalWebcam()"></button>
                </div>
                <div class="modal-body text-center p-0 bg-black">
                    <div class="position-relative" style="width: 100%; height: 350px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <video id="videoWebcam" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                        <canvas id="canvasWebcam" style="display:none;"></canvas>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalWebcam()">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-lg rounded-circle p-3" onclick="tirarFotoWebcam()" title="Capturar">
                        <i class="fas fa-camera fa-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

    <!-- Outros Formulários (Mantidos da sua estrutura original) -->
    <div id="contaCorrenteForm" class="form-container">
        <h2><i class="fas fa-landmark"></i> Cadastro de Contas Correntes</h2>
        <form method="POST" action="/cadastrar_conta_corrente" id="cadastroContaCorrenteForm">
            <input type="hidden" name="id_conta" id="idContaHidden">
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label required-field">UVR</label><select class="form-select" name="uvr_conta" id="uvrSelectConta" required><option value="">Selecione...</option><option value="UVR 01">UVR 01</option><option value="UVR 02">UVR 02</option></select></div><div class="col-md-6 mb-3"><label class="form-label">Associação</label><input type="text" class="form-control" name="associacao_conta" id="associacaoInputConta" readonly></div></div>
            <div class="mb-3"><label class="form-label required-field">Banco</label><select class="form-select" name="banco_conta" id="bancoContaSelect" required><option value="">Carregando bancos...</option></select></div>
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label required-field">Agência</label><input type="text" class="form-control" name="agencia_conta" id="agenciaContaInput" required></div><div class="col-md-6 mb-3"><label class="form-label required-field">Conta</label><input type="text" class="form-control" name="conta_corrente_conta" id="contaCorrenteContaInput" required></div></div>
            <div class="mb-3"><label class="form-label">Descrição</label><input type="text" class="form-control" name="descricao_apelido_conta" id="descricaoApelidoContaInput"></div>
            <div class="d-grid gap-2"><button type="submit" class="btn btn-primary btn-lg" id="btnSalvarConta">CADASTRAR CONTA</button><button type="button" class="btn btn-secondary" id="btnCancelarEdicaoConta" style="display:none;" onclick="cancelarEdicaoConta()">CANCELAR EDIÇÃO</button></div>
        </form>
    </div>

    <div id="receitaDespesaForm" class="form-container">
    <h2><i class="fas fa-file-invoice-dollar"></i> Registro de Transação (NF/Recibo)</h2>
    <form method="POST" action="/registrar_transacao_financeira" id="transacaoForm" enctype="multipart/form-data">
        
        <input type="hidden" id="dataHoraCadastroTransacao" name="data_hora_cadastro_transacao">
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label required-field">UVR</label>
                <select class="form-select" name="uvr_transacao" id="uvrSelectTransacao" required>
                    <option value="">Selecione...</option>
                    <option value="UVR 01">UVR 01</option>
                    <option value="UVR 02">UVR 02</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Associação</label>
                <input type="text" class="form-control" name="associacao_transacao" id="associacaoInputTransacao" readonly>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label required-field">Tipo</label>
                <select class="form-select" name="tipo_transacao" id="tipoTransacaoSelect" required>
                    <option value="">Selecione...</option>
                    <option value="Despesa">Despesa</option>
                    <option value="Receita">Receita</option>
                </select>
            </div>
            <div class="col-md-8 mb-3">
                <label class="form-label required-field">Atividade</label>
                <select class="form-select" name="tipo_atividade_transacao" id="tipoAtividadeTransacaoSelect" required>
                    <option value="">Selecione Tipo Primeiro</option>
                </select>
            </div>
        </div>
        
        <div class="mb-3 p-3 bg-light rounded border">
            <label class="form-label required-field" id="labelFornecedorPrestadorCliente">Fornecedor / Cliente</label>
            <select class="form-select" name="fornecedor_prestador_transacao" id="fornecedorPrestadorTransacaoSelect" required>
                <option value="">Selecione...</option>
            </select>
            <input type="hidden" name="nome_fornecedor_prestador_transacao" id="nomeFornecedorPrestadorTransacaoInput">
        </div>

        <div class="mb-3 p-3 bg-light rounded border" id="patrimonioToggleContainer" style="display:none;">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="vincularPatrimonioTransacaoToggle">
                <label class="form-check-label" for="vincularPatrimonioTransacaoToggle">Vincular patrimônio (frota/equipamento)</label>
            </div>
        </div>

        <div class="mb-3 p-3 bg-light rounded border" id="patrimonioTransacaoSection" style="display:none;">
            <label class="form-label">Patrimônio (Veículo/Máquina/Equipamento)</label>
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="patrimonioBuscaInput" placeholder="Digite placa, descrição ou código">
                <button class="btn btn-outline-secondary" type="button" id="btnBuscarPatrimonioTransacao"><i class="fas fa-search"></i> Buscar</button>
            </div>
            <div class="mb-2">
                <select class="form-select" id="patrimonioCategoriaSelect">
                    <option value="Todos">Todas Categorias</option>
                    <option value="Frota">Frota (Veículos)</option>
                    <option value="Equipamento">Equipamentos/Máquinas</option>
                    <option value="Mobiliario">Mobiliário/TI</option>
                </select>
            </div>
            <select class="form-select" name="id_patrimonio_transacao" id="patrimonioTransacaoSelect">
                <option value="">Selecione...</option>
            </select>
            <small class="text-muted">Opcional. Use para controlar custos por KM e manutenção preventiva.</small>

            <div class="row mt-3 g-2">
                <div class="col-md-6">
                    <label class="form-label required-field" id="labelMedidorAtualTransacao">KM Atual</label>
                    <input type="number" step="0.01" class="form-control" name="medidor_atual_transacao" id="medidorAtualTransacaoInput" placeholder="Informe o KM ou Horímetro">
                    <input type="hidden" name="tipo_medidor_transacao" id="tipoMedidorTransacaoInput">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Motorista Responsável</label>
                    <select class="form-select" name="motorista_transacao" id="motoristaTransacaoSelect">
                        <option value="">Selecione...</option>
                    </select>
                    <input type="hidden" name="nome_motorista_transacao" id="nomeMotoristaTransacaoInput">
                </div>
            </div>

            <div class="mt-3">
                <label class="form-label">Categoria da Despesa (Patrimônio)</label>
                <select class="form-select" name="categoria_despesa_patrimonio" id="categoriaDespesaPatrimonioSelect">
                    <option value="">Selecione...</option>
                    <option value="Combustivel">Combustível</option>
                    <option value="Manutencao">Manutenção</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>

            <div id="combustivelFields" class="mt-3" style="display:none;">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Litros (Quantidade)</label>
                        <input type="number" step="0.001" class="form-control" name="litros_transacao" id="litrosTransacaoInput">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Combustível</label>
                        <select class="form-select" name="tipo_combustivel_transacao" id="tipoCombustivelTransacaoSelect">
                            <option value="">Selecione...</option>
                            <option value="Diesel S10">Diesel S10</option>
                            <option value="Diesel S500">Diesel S500</option>
                            <option value="Gasolina">Gasolina</option>
                            <option value="Etanol">Etanol</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="manutencaoFields" class="mt-3" style="display:none;">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Manutenção</label>
                        <select class="form-select" name="tipo_manutencao_transacao" id="tipoManutencaoTransacaoSelect">
                            <option value="">Selecione...</option>
                            <option value="Preventiva">Preventiva</option>
                            <option value="Corretiva">Corretiva</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Garantia (KM)</label>
                        <input type="number" class="form-control" name="garantia_km_transacao" id="garantiaKmTransacaoInput">
                    </div>
                </div>
                <div class="row g-2 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">Garantia (Data)</label>
                        <input type="date" class="form-control" name="garantia_data_transacao" id="garantiaDataTransacaoInput">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Próxima Revisão (KM)</label>
                        <input type="number" class="form-control" name="proxima_revisao_km_transacao" id="proximaRevisaoKmTransacaoInput">
                    </div>
                </div>
                <div class="mt-1">
                    <label class="form-label">Próxima Revisão (Data)</label>
                    <input type="date" class="form-control" name="proxima_revisao_data_transacao" id="proximaRevisaoDataTransacaoInput">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Nº Documento</label>
                <input type="text" class="form-control" name="numero_documento_transacao">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label required-field">Data</label>
                <input type="date" class="form-control" name="data_documento_transacao" id="dataDocumentoTransacao" required>
            </div>
        </div>
        
        <hr>
        <h4>Itens</h4>
        <div id="itensDocumentoContainer"></div>
        <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="btnAdicionarItem"><i class="fas fa-plus"></i> Adicionar Item</button>
        
        <div class="row mt-3">
            <div class="col-md-6 offset-md-6">
                <label class="form-label fw-bold">TOTAL (R$)</label>
                <input type="text" class="form-control form-control-lg text-end fw-bold text-primary" name="valor_total_documento" id="valorTotalDocumentoCalculado" readonly>
            </div>
        </div>

        <div class="mb-3 mt-3">
            <label class="form-label required-field" id="labelNotaFiscalTransacao">Anexar Nota Fiscal</label>
            <input type="file" class="form-control" name="nota_fiscal_upload" id="notaFiscalTransacaoUpload" accept="application/pdf,image/jpeg,image/png" required>
            <small class="text-muted">Anexe a nota fiscal em PDF ou imagem (JPG/PNG).</small>
        </div>
        
        <input type="hidden" name="id_transacao" id="idTransacaoHidden">
        
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg" id="btnSalvarTransacao">REGISTRAR TRANSAÇÃO</button>
            <button type="button" class="btn btn-secondary" id="btnCancelarEdicaoTransacao" style="display:none;" onclick="cancelarEdicaoTransacao()">CANCELAR EDIÇÃO</button>
        </div>
    </form>
</div>

<div id="gestaoCadastrosContainer" class="form-container">
    <h2><i class="fas fa-search"></i> Pesquisar Clientes/Fornecedores</h2>
    
    <div class="card p-3 mb-4 bg-light">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Nome ou CNPJ</label>
                <input type="text" id="inputBuscaCadastro" class="form-control" placeholder="Digite...">
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Tipo</label>
                <select class="form-select" id="filtroTipoCadastro">
                    <option value="">Todos</option>
                    <option value="Fornecedor">Fornecedor</option>
                    <option value="Comprador">Cliente</option>
                    <option value="Ambos">Ambos (Cliente e Fornecedor)</option>
                </select>
            </div>
            
            <div class="col-md-3 text-end align-self-end">
                <button class="btn btn-primary" onclick="buscarCadastros()">
                    <i class="fas fa-search"></i> Pesquisar
                </button>
            </div>
        </div>
    </div>
    
    <div class="tabela-container">
        <table class="table table-hover table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Razão Social</th>
                    <th>CNPJ</th>
                    <th>Tipo</th>
                    <th>Cidade</th>
                    <th>UVR</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody id="tabelaCadastrosBody"></tbody>
        </table>
    </div>
</div>

    <div id="gestaoContasContainer" class="form-container">
        <h2><i class="fas fa-search-dollar"></i> Gerenciar Contas Correntes</h2>
        <div class="card p-3 mb-4 bg-light">
            <div class="row g-3">
                <div class="col-md-4"><label class="form-label">Nome/Descrição</label><input type="text" id="inputBuscaConta" class="form-control" placeholder="Digite..."></div>
                <div class="col-md-5 text-end align-self-end"><button class="btn btn-primary" onclick="buscarContasCorrentes()"><i class="fas fa-search"></i> Pesquisar</button></div>
            </div>
        </div>
        <div class="tabela-container"><table class="table table-hover table-bordered"><thead class="table-light"><tr><th>Banco</th><th>Agência / Conta</th><th>Descrição</th><th>UVR</th><th class="text-center">Ações</th></tr></thead><tbody id="tabelaContasBody"></tbody></table></div>
    </div>

    <div id="gestaoTransacoesContainer" class="form-container">
        <h2><i class="fas fa-search-dollar"></i> Gerenciar Transações</h2>
        <div class="card p-3 mb-4 bg-light">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">UVR</label>
                    <select class="form-select" id="filtroUvrTransacao" {% if usuario.role != 'admin' %}disabled{% endif %}>
                        {% if usuario.role == 'admin' %}
                            <option value="">Todas</option>
                        {% endif %}
                        <option value="UVR 01" {% if usuario.uvr_acesso == 'UVR 01' %}selected{% endif %}>UVR 01</option>
                        <option value="UVR 02" {% if usuario.uvr_acesso == 'UVR 02' %}selected{% endif %}>UVR 02</option>
                        <option value="UVR 03" {% if usuario.uvr_acesso == 'UVR 03' %}selected{% endif %}>UVR 03</option>
                    </select>
                </div>

                <div class="col-md-3"><label class="form-label">Data Inicial</label><input type="date" id="filtroDataIniTransacao" class="form-control"></div>
                <div class="col-md-3"><label class="form-label">Data Final</label><input type="date" id="filtroDataFimTransacao" class="form-control"></div>
                <div class="col-md-2"><label class="form-label">Tipo</label><select class="form-select" id="filtroTipoTransacao"><option value="">Todos</option><option value="Receita">Receita</option><option value="Despesa">Despesa</option></select></div>
                <div class="col-md-2" id="filtroFrotaTransacaoContainer" style="display:none;">
                    <label class="form-label">Frota</label>
                    <select class="form-select" id="filtroFrotaTransacao" disabled>
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end justify-content-end gap-2">
                    <button class="btn btn-primary w-100" onclick="buscarTransacoesGestao()"><i class="fas fa-search"></i> Pesquisar</button>
                </div>
                <div class="col-md-12 d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-success btn-sm" id="btnBaixarCsvTransacoes"><i class="fas fa-file-csv"></i> Baixar CSV</button>
                    <button class="btn btn-danger btn-sm" id="btnBaixarPdfTransacoes"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
                </div>
            </div>
        </div>
        <div class="tabela-container"><table class="table table-hover table-bordered table-sm"><thead class="table-light"><tr><th>Data</th><th>UVR</th><th>Tipo</th><th>Origem/Destino</th><th>Nº Doc.</th><th>Valor Total</th><th>Status Pag.</th><th class="text-center">Ações</th></tr></thead><tbody id="tabelaTransacoesBody"></tbody></table></div>
    </div>

    <div id="relatoriosFormContainer" class="form-container">
        <h2><i class="fas fa-chart-line"></i> Relatórios Financeiros</h2>
        
        <div class="card p-3 mb-3 bg-light">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">UVR</label>
                    <select class="form-select" id="relUvr" {% if usuario.role != 'admin' %}disabled{% endif %}>
                        {% if usuario.role == 'admin' %}<option value="">Todas</option>{% endif %}
                        <option value="UVR 01" {% if usuario.uvr_acesso == 'UVR 01' %}selected{% endif %}>UVR 01</option>
                        <option value="UVR 02" {% if usuario.uvr_acesso == 'UVR 02' %}selected{% endif %}>UVR 02</option>
                        <option value="UVR 03" {% if usuario.uvr_acesso == 'UVR 03' %}selected{% endif %}>UVR 03</option>
                    </select>
                </div>
                <div class="col-md-3"><label class="form-label">Inicio</label><input type="date" class="form-control" id="relDataInicial"></div>
                <div class="col-md-3"><label class="form-label">Fim</label><input type="date" class="form-control" id="relDataFinal"></div>
                <div class="col-md-2"><label class="form-label">Tipo</label><select class="form-select" id="relTipoTransacao"><option value="">Todas</option><option value="Receita">Receita</option><option value="Despesa">Despesa</option></select></div>
                <div class="col-md-2 d-flex align-items-end justify-content-end gap-2"><button class="btn btn-warning w-100" id="btnGerarRelatorio">Gerar</button></div>
            </div>
        </div>

        <div class="tabela-container" style="max-height: 500px;">
            <table class="table table-striped table-bordered table-sm" id="tabelaRelatorio">
                <thead class="table-dark" style="position: sticky; top: 0;"></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3" id="botoesExportacaoRelatorio" style="display: none;">
            <button class="btn btn-success" onclick="baixarRelatorio('csv')"><i class="fas fa-file-csv"></i> Baixar CSV</button>
            <button class="btn btn-danger" onclick="baixarRelatorio('pdf')"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
        </div>
    </div>

    <div id="aprovacoesContainer" class="form-container">
        <h2><i class="fas fa-check-double"></i> Aprovações Pendentes</h2>
        <div class="tabela-container"><table class="table table-hover table-bordered"><thead class="table-light"><tr><th>Data</th><th>Solicitante</th><th>Registro</th><th>Alteração</th><th class="text-center">Ação</th></tr></thead><tbody id="tabelaAprovacoesBody"></tbody></table><div id="msgSemAprovacoes" class="alert alert-info text-center" style="display:none;">Nenhuma solicitação pendente.</div></div>
    </div>

    <div id="fluxoCaixaForm" class="form-container">
        <h2><i class="fas fa-exchange-alt"></i> Fluxo de Caixa</h2>
        <div class="card p-3 mb-3 bg-light">
            <div class="row g-3">
                <div class="col-md-3"><label class="form-label required-field">UVR</label><select class="form-select" id="uvrFluxoCaixa"><option value="">Selecione...</option><option value="UVR 01">UVR 01</option><option value="UVR 02">UVR 02</option></select></div>
                <div class="col-md-3"><label class="form-label">Data Inicial</label><input type="date" class="form-control" id="fluxoDataInicialFiltro"></div>
                <div class="col-md-3"><label class="form-label">Data Final</label><input type="date" class="form-control" id="fluxoDataFinalFiltro"></div>
            </div>
        </div>
        <div id="painelFluxoResumo" style="display:none;" class="mb-4">
            <div class="row text-center">
                <div class="col-md-4"><div class="card text-white bg-success mb-3"><div class="card-header">Receitas</div><div class="card-body"><h4 class="card-title">R$ <span id="resumoReceitas">0,00</span></h4></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-danger mb-3"><div class="card-header">Despesas</div><div class="card-body"><h4 class="card-title">R$ <span id="resumoDespesas">0,00</span></h4></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-primary mb-3"><div class="card-header">Saldo</div><div class="card-body"><h4 class="card-title">R$ <span id="resumoSaldo">0,00</span></h4></div></div></div>
            </div>
        </div>
        <hr><h4>Registrar Movimentação</h4>
        
        <form id="formRegistrarFluxoCaixa" class="needs-validation" novalidate>
                <input type="hidden" id="dataHoraRegistroFluxo" name="data_hora_registro_fluxo">

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label class="form-label text-muted small">Data/Hora do Registro</label>
                        <input type="text" class="form-control bg-light" id="dataHoraFluxoVisual" readonly style="font-weight: bold; color: #555;">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label required-field">Tipo</label>
                        <select class="form-select" id="tipoMovimentacao" name="tipo_movimentacao" required>
                            <option value="">Selecione...</option>
                            <option value="Pagamento">Pagamento</option>
                            <option value="Recebimento">Recebimento</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label required-field">Entidade</label>
                        <select class="form-select" id="cadastroCFSelect" name="id_cadastro_cf_str" required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">Documentos em Aberto</div>
                    <div class="card-body" id="nfsEmAbertoContainer" style="max-height: 200px; overflow-y: auto;">
                        </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label required-field">Conta</label>
                        <select class="form-select" id="contaCorrenteSelect" name="id_conta_corrente" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nº Doc.</label>
                        <input type="text" class="form-control" id="numeroDocumentoBancario" name="numero_documento_bancario">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label required-field">Data Efetiva</label>
                        <input type="date" class="form-control" id="dataEfetivaFluxo" name="data_efetiva" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label required-field">Valor (R$)</label>
                        <input type="text" class="form-control valor-monetario" id="valorEfetivo" name="valor_efetivo" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Saldo Op.</label>
                        <input type="text" class="form-control" id="saldoOperacaoDisplay" readonly>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Observações</label>
                    <textarea class="form-control" id="observacoesFluxo" name="observacoes" rows="2"></textarea>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-danger btn-lg" id="btnConfirmarFluxo">CONFIRMAR MOVIMENTAÇÃO</button>
                </div>
            </form>
    </div>

    <div id="extratoBancarioContainer" class="form-container">
        <h2><i class="fas fa-file-invoice-dollar"></i> Extrato Bancário</h2>
        <div class="card p-3 mb-3 bg-light">
            <div class="row g-3"><div class="col-md-3"><label class="form-label">UVR</label><select class="form-select" id="extratoUvr"><option value="">Selecione...</option></select></div><div class="col-md-5"><label class="form-label required-field">Conta</label><select class="form-select" id="extratoContaCorrente" disabled><option value="">Selecione...</option></select></div><div class="col-md-2"><label class="form-label">Inicio</label><input type="date" class="form-control" id="extratoDataInicial"></div><div class="col-md-2"><label class="form-label">Fim</label><input type="date" class="form-control" id="extratoDataFinal"></div></div>
            <div class="row mt-3"><div class="col-12 text-end"><button class="btn btn-primary" id="btnGerarExtrato">Visualizar</button></div></div>
        </div>
        <div id="infoContaExtrato" class="alert alert-secondary mb-3" style="display:none;"><h5 class="alert-heading" id="extratoNomeConta"></h5><p class="mb-0">Período: <span id="extratoPeriodo"></span></p></div>
        <div id="saldoInicialExtrato" class="alert alert-info text-end" style="display:none; font-size: 1.1em;"></div>
        <div class="tabela-container"><table class="table table-hover table-striped" id="tabelaExtrato"><thead class="table-dark"></thead><tbody></tbody></table></div>
        <div id="saldoFinalExtrato" class="alert alert-primary text-end mt-3" style="display:none; font-size: 1.2em;"></div>
        <div class="d-flex justify-content-end gap-2 mt-3"><button class="btn btn-success" id="btnBaixarCsvExtrato" style="display:none;">CSV</button><button class="btn btn-danger" id="btnBaixarPdfExtrato" style="display:none;">PDF</button></div>
    </div>

    <div id="gestaoProdutosServicosContainer" class="form-container">
        <h2><i class="fas fa-box-open"></i> Gestão de Produtos e Serviços</h2>
        <div class="card p-3 mb-3 bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-md-2"><label class="form-label fw-bold">1. Tipo</label><select class="form-select form-select-sm" id="filtroTipoGestao"><option value="">Todos</option><option value="Receita">Receitas</option><option value="Despesa">Despesas</option></select></div>
                <div class="col-md-4"><label class="form-label fw-bold">2. Grupo</label><select class="form-select form-select-sm" id="filtroGrupoGestao"><option value="">Selecione...</option></select></div>
                <div class="col-md-3"><label class="form-label fw-bold">3. Subgrupo</label><select class="form-select form-select-sm" id="filtroSubgrupoGestao" disabled><option value="">Selecione...</option></select></div>
                <div class="col-md-3 text-end"><div class="btn-group w-100"><button class="btn btn-info text-white btn-sm" onclick="abrirModalSubgrupos()">Subgrupos</button><button class="btn btn-primary btn-sm" onclick="abrirModalProduto()">Produto</button></div></div>
            </div>
        </div>
        <div class="tabela-container"><table class="table table-hover table-bordered table-sm"><thead class="table-light"><tr><th>Item</th><th>Tipo</th><th>Subgrupo</th><th>Grupo</th><th class="text-center" style="width: 100px;">Ações</th></tr></thead><tbody id="tabelaProdutosBody"><tr><td colspan="4" class="text-center">Selecione um filtro...</td></tr></tbody></table></div>
    </div>

<div id="clienteFornecedorForm" class="form-container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-handshake text-primary"></i> Cadastro de Cliente / Fornecedor</h2>
        <button type="button" class="btn-close" onclick="$('.form-container').hide(); $('#menuPrincipal').fadeIn();"></button>
    </div>

    <form action="/cadastrar" method="POST">
        <input type="hidden" name="id" id="idClienteHidden">
        
        <div class="row mb-3 p-2 bg-light border rounded mx-0">
            <div class="col-md-3">
                <label class="form-label small text-muted">Data Cadastro</label>
                <input type="text" class="form-control form-control-sm fw-bold text-primary" id="visualDataCadastroCliente" readonly>
                <input type="hidden" name="data_hora_cadastro" id="inputDataCadastroCliente">
            </div>
            <div class="col-md-9 d-flex align-items-end">
                <span class="text-muted small"><i class="fas fa-info-circle"></i> Dados obrigatórios.</span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-2">
                <label class="form-label required-field">Tipo</label>
                <select class="form-select" name="tipo_cadastro" required>
                    <option value="Comprador">Comprador (Cliente)</option>
                    <option value="Fornecedor">Fornecedor</option>
                    <option value="Ambos">Ambos (Cliente e Fornecedor)</option>                 
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label required-field">CNPJ / CPF</label>
                <input type="text" class="form-control cnpj-mask" name="cnpj" id="cnpjCliente" placeholder="Apenas números" required>
            </div>

            <div class="col-md-3">
                <label class="form-label">Telefone</label>
                <input type="text" class="form-control phone-mask" name="telefone">
            </div>

            <div class="col-md-4">
                {% if current_user.role == 'admin' %}
                    <label class="form-label required-field text-danger fw-bold">Vincular à UVR</label>
                    <select class="form-select border-danger" name="uvr" required>
                        <option value="">Selecione a UVR...</option>
                        <option value="UVR 01">UVR 01</option>
                        <option value="UVR 02">UVR 02</option>
                        <option value="UVR 03">UVR 03</option>
                    </select>
                {% else %}
                    <label class="form-label">UVR</label>
                    <input type="text" class="form-control bg-light" value="{{ current_user.uvr_acesso }}" readonly>
                    <input type="hidden" name="uvr" value="{{ current_user.uvr_acesso }}">
                {% endif %}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <label class="form-label required-field">Razão Social / Nome</label>
                <input type="text" class="form-control" name="razao_social" required style="text-transform: uppercase;">
            </div>
        </div>

        <h5 class="text-muted mt-4"><i class="fas fa-map-marker-alt"></i> Endereço</h5>
        
        <div class="row mb-3">
            <div class="col-md-2">
                <label class="form-label">CEP</label>
                <input type="text" class="form-control cep-mask" name="cep" id="cepCliente" onblur="buscarEndereco('cepCliente', 'logCliente', 'bairroCliente', 'cidadeCliente', 'ufCliente')">
            </div>
            <div class="col-md-6">
                <label class="form-label">Logradouro</label>
                <input type="text" class="form-control" name="logradouro" id="logCliente">
            </div>
            <div class="col-md-2">
                <label class="form-label">Nº</label>
                <input type="text" class="form-control" name="numero">
            </div>
            <div class="col-md-2">
                <label class="form-label">Bairro</label>
                <input type="text" class="form-control" name="bairro" id="bairroCliente">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-10">
                <label class="form-label">Cidade</label>
                <input type="text" class="form-control" name="cidade" id="cidadeCliente">
            </div>
            <div class="col-md-2">
                <label class="form-label">UF</label>
                <input type="text" class="form-control" name="uf" id="ufCliente">
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" onclick="$('.form-container').hide(); $('#menuPrincipal').fadeIn();">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
    </form>
</div>
    <div id="gestaoPatrimonioContainer" class="form-container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-truck-pickup"></i> Gestão de Patrimônio e Frota</h5>
                <button class="btn btn-light btn-sm" onclick="mostrarFormulario('menuPrincipal')">Voltar</button>
            </div>
            <div class="card-body p-0 pt-3">
                
                <ul class="nav nav-tabs mb-3 px-3" id="tabPatrimonio" role="tablist">
                    <li class="nav-item"><button class="nav-link active" id="tab-lista-patrimonio" data-bs-toggle="tab" data-bs-target="#content-lista-patrimonio" type="button">Lista de Bens</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-novo-patrimonio" data-bs-toggle="tab" data-bs-target="#content-novo-patrimonio" type="button">Novo Cadastro</button></li>
                </ul>

                <div class="tab-content px-3 pb-3">
                    
                    <div class="tab-pane fade show active" id="content-lista-patrimonio">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="filtroCategoriaPatrimonio">
                                    <option value="Todos">Todas Categorias</option>
                                    <option value="Frota">Frota (Veículos)</option>
                                    <option value="Equipamento">Equipamentos/Máquinas</option>
                                    <option value="Mobiliario">Mobiliário/TI</option>
                                </select>
                            </div>
                            <div class="col-md-6"><input type="text" class="form-control" id="buscaPatrimonioInput" placeholder="Buscar por nome, placa ou código..."></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="buscarPatrimonio()">Buscar</button></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="tabelaPatrimonio">
                                <thead class="table-light"><tr><th>Descrição</th><th>Tipo/Categoria</th><th>Placa/Ref.</th><th>Medidor Atual</th><th>Responsável</th><th>Status</th><th>Ações</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-novo-patrimonio">
                        <form id="formPatrimonio" action="/cadastrar_patrimonio" method="POST" enctype="multipart/form-data">
                            
                            <h6 class="text-primary border-bottom pb-2 mb-3">1. Localização e Identificação</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label required-field">UVR</label>
                                    <select class="form-select" name="uvr_patrimonio" id="uvrPatrimonioSelect" required>
                                        <option value="">Selecione...</option>
                                        <option value="UVR 01">UVR 01</option>
                                        <option value="UVR 02">UVR 02</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Associação</label>
                                    <input type="text" class="form-control" name="associacao_patrimonio" id="associacaoPatrimonioInput" readonly>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label required-field">Descrição / Nome do Bem</label>
                                    <input type="text" class="form-control" name="descricao_bem" placeholder="Ex: Caminhão Volvo 270 ou Prensa Vertical" required>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label required-field">Categoria</label>
                                    <select class="form-select" name="categoria_bem" id="categoriaBem" required onchange="ajustarCamposPatrimonio()">
                                        <option value="Frota">Frota (Veículos)</option>
                                        <option value="Equipamento">Equipamento/Máquina</option>
                                        <option value="Mobiliario">Mobiliário/Informática</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label required-field">Tipo de Bem</label>
                                    <select class="form-select" name="tipo_bem" required>
                                        <optgroup label="Frota">
                                            <option value="Caminhão">Caminhão</option>
                                            <option value="Carro">Carro/Utilitário</option>
                                            <option value="Moto">Moto</option>
                                            <option value="Trator">Trator</option>
                                            <option value="Empilhadeira">Empilhadeira</option>
                                        </optgroup>
                                        <optgroup label="Equipamentos">
                                            <option value="Prensa">Prensa Hidráulica</option>
                                            <option value="Esteira">Esteira</option>
                                            <option value="Balança">Balança</option>
                                            <option value="Triturador">Triturador</option>
                                            <option value="Outros">Outros</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Marca</label>
                                    <input type="text" class="form-control" name="marca_bem">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Modelo</label>
                                    <input type="text" class="form-control" name="modelo_bem">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <label class="form-label">Ano Fab.</label>
                                    <input type="number" class="form-control" name="ano_fabricacao" placeholder="AAAA">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Nº Série / Chassi</label>
                                    <input type="text" class="form-control" name="serie_chassi">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Cód. Patrimônio / Interno</label>
                                    <input type="text" class="form-control" name="codigo_patrimonio">
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" name="eh_bem_publico" id="checkBemPublico">
                                        <label class="form-check-label" for="checkBemPublico">É um Bem Público?</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="uso_compartilhado">
                                        <label class="form-check-label">Uso Compartilhado</label>
                                    </div>
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">2. Situação de Propriedade</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Situação</label>
                                    <select class="form-select" name="situacao_propriedade" id="situacaoPropriedade" onchange="ajustarCamposPropriedade()">
                                        <option value="Proprio">Próprio</option>
                                        <option value="Comodato">Comodato / Cedido</option>
                                        <option value="Alugado">Alugado</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Entidade Proprietária</label>
                                    <select class="form-select" name="entidade_proprietaria">
                                        <option value="Associacao">A Própria Associação</option>
                                        <option value="Prefeitura">Prefeitura Municipal</option>
                                        <option value="Estado">Governo do Estado</option>
                                        <option value="Itaipu">Itaipu Binacional</option>
                                        <option value="Privado">Empresa Privada/Outro</option>
                                    </select>
                                </div>
                                <div class="col-md-5 div-comodato" style="display:none;">
                                    <label class="form-label">Órgão Cedente</label>
                                    <input type="text" class="form-control" name="orgao_cedente">
                                </div>
                            </div>
                            <div class="row mb-3 div-comodato" style="display:none;">
                                <div class="col-md-4">
                                    <label class="form-label">Nº Termo Comodato</label>
                                    <input type="text" class="form-control" name="num_termo">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Data Início</label>
                                    <input type="date" class="form-control" name="data_inicio_comodato">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Data Fim (Vencimento)</label>
                                    <input type="date" class="form-control" name="data_fim_comodato">
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">3. Dados Operacionais</h6>
                            <div id="divDadosVeiculo">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Placa</label>
                                        <input type="text" class="form-control" name="placa" placeholder="ABC-1234">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Renavam</label>
                                        <input type="text" class="form-control" name="renavam">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Combustível</label>
                                        <select class="form-select" name="combustivel">
                                            <option value="Diesel">Diesel</option>
                                            <option value="Gasolina">Gasolina</option>
                                            <option value="Etanol">Etanol</option>
                                            <option value="Flex">Flex</option>
                                            <option value="Eletrico">Elétrico</option>
                                            <option value="NaoAplica">N/A</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Capacidade Carga</label>
                                        <input type="text" class="form-control" name="capacidade_carga" placeholder="Ex: 5 ton">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label required-field">Controle de Uso Por</label>
                                    <select class="form-select" name="controle_por">
                                        <option value="km">Quilometragem (Km)</option>
                                        <option value="horas">Horímetro (Horas)</option>
                                        <option value="nenhum">Não Controlado</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Medidor Inicial</label>
                                    <input type="number" step="0.01" class="form-control" name="medidor_inicial" placeholder="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Local Instalação</label>
                                    <select class="form-select" name="local_instalacao">
                                        <option value="Galpao">Galpão Principal</option>
                                        <option value="Patio">Pátio Externo</option>
                                        <option value="Administrativo">Escritório/Adm</option>
                                        <option value="EmTransito">Em Trânsito</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Setor</label>
                                    <select class="form-select" name="setor_uso">
                                        <option value="Triagem">Linha de Triagem</option>
                                        <option value="Prensagem">Prensagem</option>
                                        <option value="Logistica">Coleta/Logística</option>
                                        <option value="Geral">Geral</option>
                                    </select>
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">4. Responsáveis (Associados da UVR)</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Responsável pelo Bem (Coordenação)</label>
                                    <select class="form-select select-associado-uvr" name="nome_responsavel">
                                        <option value="">Selecione a UVR acima primeiro...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Operador/Motorista Principal</label>
                                    <select class="form-select select-associado-uvr" name="nome_operador">
                                        <option value="">Selecione a UVR acima primeiro...</option>
                                    </select>
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">5. Status e Integração Financeira</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Status Atual</label>
                                    <select class="form-select" name="status_bem">
                                        <option value="Ativo" selected>Ativo / Em Uso</option>
                                        <option value="Manutencao">Em Manutenção</option>
                                        <option value="Inativo">Inativo / Parado</option>
                                        <option value="Baixado">Baixado / Vendido</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Estado Conservação</label>
                                    <select class="form-select" name="estado_conservacao">
                                        <option value="Otimo">Ótimo</option>
                                        <option value="Bom" selected>Bom</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Ruim">Ruim</option>
                                        <option value="Sucata">Sucata</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Alerta Manutenção</label>
                                    <input type="number" class="form-control" name="alerta_preventiva" placeholder="Ex: 10000">
                                </div>
                                <div class="col-md-3 pt-4">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="permite_abastecimento" checked>
                                        <label class="form-check-label">Abastecer</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="permite_manutencao" checked>
                                        <label class="form-check-label">Manutenção</label>
                                    </div>
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">6. Observações e Foto</h6>
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Observações Gerais</label>
                                    <textarea class="form-control" name="observacoes_gerais" rows="5"></textarea>
                                </div>
                                
                                <div class="col-md-4 text-center">
                                    <label class="form-label d-block">Foto do Bem / Equipamento</label>
                                    
                                    <div class="foto-patrimonio-container mb-2" style="height: 150px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; background-color: #f8f9fa; border-radius: 8px;">
                                        <img id="previewFotoPatrimonio" src="" alt="Preview" class="img-fluid" style="display: none; max-height: 100%;">
                                        <span id="textoSemFotoPatrimonio" class="text-muted text-center">
                                            <i class="fas fa-truck-moving fa-3x mb-2"></i><br>Sem foto
                                        </span>
                                    </div>

                                    <input type="hidden" id="fotoPatrimonioWebcamBase64" name="foto_bem_base64_webcam">
                                    <input type="file" id="inputFotoPatrimonioArquivo" name="foto_bem_upload" accept="image/*" style="display: none;" onchange="previewImagemPatrimonio(this)">

                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="$('#inputFotoPatrimonioArquivo').click()" title="Buscar foto no computador">
                                            <i class="fas fa-upload"></i> Carregar Arquivo
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="abrirModalWebcam('patrimonio')" title="Tirar foto agora">
                                            <i class="fas fa-camera"></i> Usar Webcam
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-success btn-lg"><i class="fas fa-save"></i> Salvar Cadastro</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- Modais -->

<div class="modal fade" id="modalVisualizarPatrimonio" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-truck-pickup"></i> Detalhes do Bem</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center border-end">
                        <div class="mb-3 d-flex align-items-center justify-content-center bg-light border rounded" style="height: 200px; overflow: hidden;">
                            <img id="viewPatrimonioFoto" src="" class="img-fluid" style="display:none; max-height: 100%;">
                            <i id="viewPatrimonioIcone" class="fas fa-image fa-4x text-muted"></i>
                        </div>
                        <h5 id="viewPatrimonioDescricao" class="fw-bold mb-1"></h5>
                        <span id="viewPatrimonioStatus" class="badge bg-secondary mb-2"></span>
                        <p class="text-muted small" id="viewPatrimonioCodigo"></p>
                    </div>
                    
                    <div class="col-md-8">
                        <ul class="nav nav-tabs" id="tabViewPatrimonio" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-view-geral">Geral</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-view-tec">Técnico</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-view-resp">Responsáveis</button></li>
                        </ul>
                        <div class="tab-content p-3 border border-top-0 rounded-bottom">
                            <div class="tab-pane fade show active" id="tab-view-geral">
                                <p><strong>UVR:</strong> <span id="viewPatrimonioUvr"></span></p>
                                <p><strong>Tipo/Categoria:</strong> <span id="viewPatrimonioTipo"></span></p>
                                <p><strong>Propriedade:</strong> <span id="viewPatrimonioPropriedade"></span></p>
                                <p><strong>Placa/Identificação:</strong> <span id="viewPatrimonioPlaca"></span></p>
                            </div>
                            <div class="tab-pane fade" id="tab-view-tec">
                                <p><strong>Marca/Modelo:</strong> <span id="viewPatrimonioMarca"></span></p>
                                <p><strong>Ano/Série:</strong> <span id="viewPatrimonioAno"></span></p>
                                <p><strong>Combustível:</strong> <span id="viewPatrimonioCombustivel"></span></p>
                                <p><strong>Medidor Atual:</strong> <span id="viewPatrimonioMedidor"></span></p>
                            </div>
                            <div class="tab-pane fade" id="tab-view-resp">
                                <p><strong>Responsável:</strong> <span id="viewPatrimonioResp"></span></p>
                                <p><strong>Operador:</strong> <span id="viewPatrimonioOp"></span></p>
                                <p><strong>Setor/Local:</strong> <span id="viewPatrimonioLocal"></span></p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <strong>Observações:</strong>
                            <p class="text-muted small border p-2 rounded bg-light" id="viewPatrimonioObs"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-warning" id="btnEditarPatrimonioModal" data-bs-dismiss="modal">Editar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalVisualizarAssociado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-user"></i> Detalhes do Associado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-1 d-flex align-items-center justify-content-center bg-light" style="height: 160px; width: 100%; overflow: hidden;">
                            <img id="verAssocFoto" src="" alt="Foto" class="img-fluid" style="max-height: 100%; display: none;">
                            <i id="verAssocIcone" class="fas fa-user fa-4x text-secondary"></i>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-secondary" id="verAssocStatus">Status</span>
                        </div>
                    </div>
                    
                    <div class="col-md-9">
                        <h4 id="verAssocNome" class="text-primary mb-1">Nome do Associado</h4>
                        <p class="text-muted mb-3"><i class="fas fa-id-card"></i> CPF: <span id="verAssocCpf"></span> | RG: <span id="verAssocRg"></span></p>
                        
                        <div class="row g-2">
                            <div class="col-md-6"><strong><i class="fas fa-calendar"></i> Nascimento:</strong> <span id="verAssocNasc"></span></div>
                            <div class="col-md-6"><strong><i class="fas fa-briefcase"></i> Admissão:</strong> <span id="verAssocAdm"></span></div>
                            <div class="col-md-6"><strong><i class="fas fa-phone"></i> Telefone:</strong> <span id="verAssocTel"></span></div>
                            <div class="col-md-6"><strong><i class="fas fa-building"></i> UVR:</strong> <span id="verAssocUvr"></span></div>
                            <div class="col-md-12 mt-2">
                                <div class="p-2 bg-light border rounded">
                                    <strong><i class="fas fa-hard-hat text-warning"></i> Função:</strong> <span id="verAssocFuncao" class="fw-bold text-dark"></span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <p class="mb-0"><strong><i class="fas fa-map-marker-alt"></i> Endereço:</strong> <br>
                        <span id="verAssocEndereco"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btnImprimirNoModal"><i class="fas fa-print"></i> Imprimir Ficha</button>
                <button type="button" class="btn btn-warning" id="btnEditarNoModal" data-bs-dismiss="modal"><i class="fas fa-edit"></i> Editar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalDetalhesTransacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-invoice"></i> Detalhes da Transação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h5 class="text-primary" id="detalheTransacaoOrigem">Nome da Origem</h5>
                        <p class="text-muted mb-0">
                            <strong><i class="fas fa-file-alt"></i> Doc:</strong> <span id="detalheTransacaoDoc"></span> | 
                            <strong><i class="fas fa-calendar"></i> Data:</strong> <span id="detalheTransacaoData"></span>
                        </p>
                        <p class="text-muted">
                            <strong>Tipo:</strong> <span id="detalheTransacaoTipo"></span> | 
                            <strong>Atividade:</strong> <span id="detalheTransacaoAtividade"></span>
                        </p>
                        <p class="text-muted mb-0">
                            <strong>ID:</strong> <span id="detalheTransacaoId"></span> |
                            <strong>UVR:</strong> <span id="detalheTransacaoUvr"></span>
                        </p>

                        <p class="text-muted mb-0" id="detalheTransacaoPatrimonioContainer" style="display:none;">
                            <strong>Patrimônio:</strong> <span id="detalheTransacaoPatrimonio"></span>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <h3 class="text-success fw-bold" id="detalheTransacaoValor">R$ 0,00</h3>
                        <span class="badge bg-secondary" id="detalheTransacaoStatus">Status</span>
                    </div>
                </div>

                <hr>

                <h6><i class="fas fa-list"></i> Itens do Documento</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Descrição</th>
                                <th class="text-center">Unid.</th>
                                <th class="text-center">Qtd.</th>
                                <th class="text-end">Vlr. Unit.</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaItensDetalheBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-warning" id="btnEditarNoModalTransacao" data-bs-dismiss="modal">
                    <i class="fas fa-edit"></i> Editar / Excluir Itens
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVisualizarCadastro" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-id-card"></i> Detalhes do Cadastro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h3 id="verCadRazao" class="fw-bold text-primary mb-0">---</h3>
                        <span id="verCadTipo" class="badge bg-secondary">---</span>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">UVR de Acesso:</small><br>
                        <span class="badge bg-info text-dark" id="verCadUvr">---</span>
                    </div>
                </div>
                
                <hr>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-2 border rounded bg-light">
                            <label class="small text-muted fw-bold">CNPJ / CPF</label>
                            <div id="verCadCnpj" class="fs-5">---</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-2 border rounded bg-light">
                            <label class="small text-muted fw-bold">Telefone</label>
                            <div id="verCadTel" class="fs-5">---</div>
                        </div>
                    </div>
                </div>

                <h6 class="text-muted mt-4 mb-2"><i class="fas fa-map-marker-alt"></i> Localização</h6>
                <div class="p-3 border rounded bg-light">
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Logradouro:</strong> <span id="verCadLogradouro">---</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Bairro:</strong> <span id="verCadBairro">---</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>CEP:</strong> <span id="verCadCep">---</span>
                        </div>
                        <div class="col-12">
                            <strong>Cidade/UF:</strong> <span id="verCadCidadeUF" class="fw-bold">---</span>
                        </div>
                    </div>
                </div>
                
                <div class="text-end mt-2">
                    <small class="text-muted">Cadastrado em: <span id="verCadData">---</span></small>
                </div>
            </div>

            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-warning" id="btnEditarCadNoModal" style="display:none;">Editar</button>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="modalDetalhesAprovacao" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning"><h5 class="modal-title text-dark">Análise de Solicitação</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Solicitante:</strong> <span id="detalheSolicitante"></span> <br>
                        <strong>Data:</strong> <span id="detalheData"></span>
                    </div>
                    <div id="areaComparacaoFoto" class="mb-3 text-center" style="display:none;">
                        <h6>Nova Foto Proposta:</h6>
                        <img id="imgFotoNovaProposta" src="" class="img-thumbnail" style="max-height: 200px;">
                    </div>
                    <h6>Alterações Realizadas:</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light"><tr><th>Campo</th><th>Valor Atual (Banco)</th><th>Valor Novo (Proposto)</th></tr></thead>
                            <tbody id="tabelaComparacaoBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnRejeitarModal"><i class="fas fa-times"></i> Rejeitar</button>
                    <button type="button" class="btn btn-success" id="btnAprovarModal"><i class="fas fa-check"></i> Aprovar</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="modalSubgrupos" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Gerenciar Subgrupos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Selecione o Grupo (Pai)</label>
                        <select class="form-select" id="selectGrupoPaiSubgrupo" onchange="listarSubgruposNoModal()">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <hr>
                    <h6>Adicionar / Editar Subgrupo</h6>
                    <div class="input-group mb-3">
                        <input type="hidden" id="idSubgrupoEdicao">
                        <input type="text" class="form-control" id="inputNomeSubgrupo" placeholder="Nome do Subgrupo (ex: Papel)">
                        <button class="btn btn-success" type="button" onclick="salvarSubgrupo()">Salvar</button>
                        <button class="btn btn-secondary" type="button" id="btnCancelarEdicaoSub" onclick="limparFormSubgrupo()" style="display:none;">X</button>
                    </div>
                    <hr>
                    <h6>Lista de Subgrupos Existentes</h6>
                    <ul class="list-group" id="listaSubgruposExistentes">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalProdutoEdicao" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="tituloModalProduto">Novo Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="idProdutoEdicao">
                    <div class="mb-3">
                        <label class="form-label required-field">Grupo (Atividade)</label>
                        <select class="form-select" id="selectGrupoProduto" required onchange="carregarSubgruposParaProduto()">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subgrupo</label>
                        <select class="form-select" id="selectSubgrupoProduto">
                            <option value="">Selecione Grupo Primeiro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">Item (Nome do Produto/Serviço)</label>
                        <input type="text" class="form-control" id="inputNomeProduto" required placeholder="Ex: Papelão Ondulado">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarProduto()">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="modalWebcam" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-camera"></i> Tirar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="pararWebcam()"></button>
            </div>
            <div class="modal-body text-center p-0 bg-dark">
                <video id="videoWebcam" autoplay playsinline style="width: 100%; height: auto;"></video>
                <canvas id="canvasWebcam" style="display:none;"></canvas>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="pararWebcam()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="tirarFotoWebcam()"><i class="fas fa-camera"></i> CAPTURAR FOTO</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalEditarCaixa" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark"><i class="fas fa-edit"></i> Editar Lançamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/editar_movimentacao" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="id" id="editCaixaId">
                    
                    <div class="mb-3">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-control" name="data" id="editCaixaData" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <input type="text" class="form-control" name="descricao" id="editCaixaDescricao" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" name="categoria" id="editCaixaCategoria" required>
                            <option value="Receita de Vendas">Receita de Vendas</option>
                            <option value="Aporte">Aporte</option>
                            <option value="Pagamento Fornecedor">Pagamento Fornecedor</option>
                            <option value="Despesas Operacionais">Despesas Operacionais</option>
                            <option value="Impostos e Taxas">Impostos e Taxas</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Valor (R$)</label>
                        <input type="text" class="form-control" id="editCaixaValor" readonly style="background-color: #e9ecef;">
                        <small class="text-muted">* O valor não pode ser alterado na edição rápida. Para corrigir valor, exclua e lance novamente.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="modalVisualizarCaixa" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-eye"></i> Detalhes do Lançamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Data do Lançamento</label>
                    <input type="text" class="form-control" id="viewCaixaData" readonly>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Número do Documento</label>
                    <input type="text" class="form-control" id="viewCaixaDoc" readonly>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Atividade de Transação (Grupo)</label>
                    <input type="text" class="form-control" id="viewCaixaAtividade" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Valor (R$)</label>
                    <input type="text" class="form-control fw-bold" id="viewCaixaValor" readonly style="background-color: #e9ecef;">
                </div>

                <div class="mb-3" id="viewCaixaInfoExtra" style="display:none;">
                    <div class="alert alert-success py-2 small">
                        <i class="fas fa-link"></i> Lançamento vinculado a Transação/NF.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
<script>
// 1. VARIÁVEIS GLOBAIS DE PERMISSÃO
    const usuarioLogadoUvr = "{{ usuario.uvr_acesso if usuario and usuario.uvr_acesso else '' }}";
    const usuarioIsAdmin = "{{ 'true' if usuario and usuario.role == 'admin' else 'false' }}" === 'true';

    // 2. LISTA DE BANCOS E FUNÇÃO
    const bancosBrasil = [ 
        { codigo: "001", nome: "Banco do Brasil S.A." }, 
        { codigo: "104", nome: "Caixa Econômica Federal" }, 
        { codigo: "237", nome: "Bradesco S.A." }, 
        { codigo: "341", nome: "Itaú Unibanco S.A." }, 
        { codigo: "033", nome: "Santander (Brasil) S.A." }, 
        { codigo: "745", nome: "Citibank S.A." }, 
        { codigo: "399", nome: "HSBC Bank Brasil S.A. - Banco Múltiplo" },  
        { codigo: "077", nome: "Banco Inter S.A." }, 
        { codigo: "260", nome: "Nu Pagamentos S.A. (Nubank)" }, 
        { codigo: "212", nome: "Banco Original S.A." }, 
        { codigo: "655", nome: "Banco Votorantim S.A." }, 
        { codigo: "070", nome: "BRB - Banco de Brasília S.A." }, 
        { codigo: "041", nome: "Banrisul - Banco do Estado do Rio Grande do Sul S.A." }, 
        { codigo: "756", nome: "Sicoob - Banco Cooperativo do Brasil S.A." }, 
        { codigo: "085", nome: "Ailos (Viacredi, CredCrea, etc)" }, 
        { codigo: "099", nome: "Uniprime Central CCC Ltda" }, 
        { codigo: "748", nome: "Sicredi - Banco Cooperativo Sicredi S.A." }, 
        { codigo: "000", nome: "Outro (especificar no apelido)" } 
    ];

    function popularBancos() {
        const selectBanco = $('#bancoContaSelect');
        if (selectBanco.find('option').length <= 1 || selectBanco.val() === "") {
            selectBanco.empty().append('<option value="">Selecione o Banco...</option>');
            bancosBrasil.forEach(function(banco) { 
                selectBanco.append(`<option value="${banco.codigo}|${banco.nome}">${banco.codigo} - ${banco.nome}</option>`); 
            });
        }
    }

    // 3. MAPA GLOBAL DE GRUPOS E SUBGRUPOS (ATUALIZADO PELO CSV)
    // Usado em: Cadastro de Clientes, Produtos, Transações e Catálogo.
    // Usamos 'var' para evitar erro de redeclaração se o script rodar 2x
    var MAPA_GRUPOS_SISTEMA = {
        "Receita": [
            "Comercialização de Materiais Recicláveis",
            "Outras Receitas",
            "Prestação de Serviços e Parcerias",
            "Gestão Associativa"
            


        ],
        "Despesa": [
            "Operação e Produção",
            "Gestão Administrativa e Financeira",
            "Despesas de manutenção",
            "Rateio dos Associados"
        ]
    };

    // Lista unificada para telas que não filtram por tipo (ex: filtros gerais)
    var TODOS_GRUPOS_UNIFICADOS = [...MAPA_GRUPOS_SISTEMA["Receita"], ...MAPA_GRUPOS_SISTEMA["Despesa"]].sort();

    // --- FUNÇÕES ATUALIZADAS PARA USAR O NOVO MAPA ---

    function atualizarAtividadesCadastroClienteFornecedor() {
        var tipoCadastro = $('#tipoCadastroCF').val(); 
        var selectAtividade = $('#tipoAtividadeCF'); 
        selectAtividade.empty().append('<option value="">Selecione...</option>');
        
        let lista = [];
        // Fornecedor/Prestador -> Usa lista de DESPESAS
        if (tipoCadastro === "Fornecedor/Prestador") {
            lista = MAPA_GRUPOS_SISTEMA["Despesa"];
        } 
        // Cliente -> Usa lista de RECEITAS
        else if (tipoCadastro === "Cliente") {
            lista = MAPA_GRUPOS_SISTEMA["Receita"];
        }

        if (lista) {
            lista.sort().forEach(function(item) { selectAtividade.append(`<option value="${item}">${item}</option>`); });
        }
    }

    function atualizarAtividadesProdutoServico() {
        var tipoPS = $('#tipoProdutoServicoSelect').val(); 
        var selectAtividadePS = $('#tipoAtividadeProdutoServicoSelect'); 
        selectAtividadePS.empty().append('<option value="">Selecione...</option>');
        
        let lista = [];
        if (tipoPS === "Despesa") lista = MAPA_GRUPOS_SISTEMA["Despesa"];
        else if (tipoPS === "Receita") lista = MAPA_GRUPOS_SISTEMA["Receita"];

        if (lista) {
            lista.sort().forEach(function(item) { selectAtividadePS.append(`<option value="${item}">${item}</option>`); });
        }
    }

    function atualizarAtividadesTransacao() { 
        var tipo = $('#tipoTransacaoSelect').val(); 
        var selectAtividade = $('#tipoAtividadeTransacaoSelect'); 
        var currentAtividade = selectAtividade.val(); 
        selectAtividade.empty().append('<option value="">Selecione...</option>');
        
        let lista = [];
        if (tipo === "Despesa") lista = MAPA_GRUPOS_SISTEMA["Despesa"];
        else if (tipo === "Receita") lista = MAPA_GRUPOS_SISTEMA["Receita"];
        
        if (lista) {
            lista.sort().forEach(function(item) { selectAtividade.append(`<option value="${item}">${item}</option>`); });
        }

        // Mantém seleção se possível
        if (currentAtividade && lista.includes(currentAtividade)) { 
            selectAtividade.val(currentAtividade); 
        } else { 
            selectAtividade.val(''); 
        }
    }

    function atualizarDataHora(selector) {
        const now = new Date();
        
        // Pega as partes da data e garante que tenham 2 dígitos (ex: 05 em vez de 5)
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        
        // Monta a string no formato exato que o Python espera: DD/MM/AAAA HH:MM:SS
        const str = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        
        $(selector).val(str);
    }

    
// --- INÍCIO DO DOCUMENT READY (CARREGAMENTO DA PÁGINA) ---
    $(document).ready(function() {
        // --- 1. MÁSCARAS DE INPUT ---
        $('.valor-monetario').mask('#.##0,00', {reverse: true});
        $('#cnpj').mask('00.000.000/0000-00', {reverse: true});
        $('#cepCF, #cepAssociado').mask('00000-000');
        $('#telefoneCF, #telAssociado').mask('(00) 00000-0000');
        $('#cpfAssociado').mask('000.000.000-00');

        // --- 2. ATUALIZAR LISTA DE ENTIDADES (Apenas com saldo pendente) ---
        // Monitora mudanças nas datas ou na UVR do relatório
        $('#data_inicio_relatorio, #data_fim_relatorio, #filtro_uvr_relatorio').on('change', function() {
            atualizarListaEntidades();
        });

        function atualizarListaEntidades() {
            let dtIni = $('#data_inicio_relatorio').val();
            let dtFim = $('#data_fim_relatorio').val();
            let uvr = $('#filtro_uvr_relatorio').val();
            
            // ID CORRETO DO SELECT NO RELATÓRIO
            let selectEntidade = $('#filtro_entidade_relatorio'); 

            // Se não tiver datas preenchidas, não faz nada
            if (!dtIni || !dtFim) return;

            // Mostra "Carregando..."
            selectEntidade.html('<option value="">Carregando...</option>');

            $.ajax({
                url: '/api/entidades_com_saldo',
                method: 'GET',
                data: { 
                    data_inicio: dtIni, 
                    data_fim: dtFim,
                    uvr: uvr 
                },
                success: function(nomes) {
                    selectEntidade.empty(); // Limpa a lista antiga
                    
                    // Adiciona a opção padrão "Todas"
                    selectEntidade.append('<option value="">Todas</option>');

                    if (nomes.length === 0) {
                        selectEntidade.append('<option value="" disabled>Nenhuma pendência no período</option>');
                    } else {
                        // Preenche apenas com quem tem saldo
                        nomes.forEach(function(nome) {
                            selectEntidade.append(`<option value="${nome}">${nome}</option>`);
                        });
                    }
                },
                error: function() {
                    selectEntidade.html('<option value="">Erro ao carregar</option>');
                    console.log("Erro ao buscar entidades com saldo.");
                }
            });
        }

        // --- 3. FUNÇÕES AUXILIARES DE DATA ---
        function preencherDataAtual(selector) {
            const now = new Date();
            const day = ("0" + now.getDate()).slice(-2);
            const month = ("0" + (now.getMonth() + 1)).slice(-2);
            const today = now.getFullYear() + "-" + (month) + "-" + (day);
            $(selector).val(today);
        }

        function preencherDatasPadraoFluxo() {
            const now = new Date();
            const day = ("0" + now.getDate()).slice(-2);
            const month = ("0" + (now.getMonth() + 1)).slice(-2);
            const today = now.getFullYear() + "-" + (month) + "-" + (day);
            
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const fDay = ("0" + firstDay.getDate()).slice(-2);
            const fMonth = ("0" + (firstDay.getMonth() + 1)).slice(-2);
            const firstDate = firstDay.getFullYear() + "-" + (fMonth) + "-" + (fDay);

            $('#fluxoDataInicialFiltro').val(firstDate);
            $('#fluxoDataFinalFiltro').val(today);
        }

        // --- 4. PREENCHIMENTO AUTOMÁTICO DE ASSOCIAÇÃO ---
        const mapUvrAssociacao = { "UVR 01": "ASCAMAR", "UVR 02": "ACAN" };
        
        function preencherAssociacao(selectId, inputId) {
            const uvr = $('#' + selectId).val();
            $('#' + inputId).val(mapUvrAssociacao[uvr] || "");
            
            // Caso específico do Fluxo de Caixa (se necessário manter a lógica original)
            if(selectId === 'uvrFluxoCaixa') {
                $('#associacaoFluxoCaixa').val(mapUvrAssociacao[uvr] || "");
            }    
        }

// --- FUNÇÃO mostrarFormulario (ATUALIZADA) ---
        window.mostrarFormulario = function(formId) {
            // 1. Esconde todas as telas e mostra a selecionada
            $('.form-container').hide();
            $('#' + formId).show();

            // 2. Lógica específica para cada tela
            if (formId === 'clienteFornecedorForm') { 
                atualizarDataHora('#dataHoraCadastroCF'); 
                atualizarAtividadesCadastroClienteFornecedor(); 
            }
            else if (formId === 'associadoForm') { 
                atualizarDataHora('#dataHoraCadastroAssociado'); 
            }
            else if (formId === 'produtoServicoForm') { 
                atualizarDataHora('#dataHoraCadastroPS'); 
                atualizarAtividadesProdutoServico(); 
            }
            else if (formId === 'contaCorrenteForm') { 
                atualizarDataHora('#dataHoraCadastroConta'); 
                popularBancos(); 
            }
            else if (formId === 'epiCadastroContainer') {
                atualizarDataHora('#dataHoraCadastroEpi');
            }
            else if (formId === 'receitaDespesaForm') { 
                atualizarDataHora('#dataHoraCadastroTransacao'); 
                preencherDataAtual('#dataDocumentoTransacao'); 
                
                // Força atualização da lista de grupos
                atualizarAtividadesTransacao(); 

                if ($('#itensDocumentoContainer .item-row').length === 0) { adicionarItemLinha(); } 
                $('#uvrSelectTransacao').trigger('change'); 
            }
            else if (formId === 'fluxoCaixaForm') { 
                atualizarDataHora('#dataHoraRegistroFluxo'); 
                preencherDataAtual('#dataEfetivaFluxo'); 
                if(!$('#fluxoDataInicialFiltro').val()) preencherDatasPadraoFluxo();
                $('#uvrFluxoCaixa').trigger('change'); 
            }
            else if (formId === 'relatoriosFormContainer') { 
                loadRelatorioUVRs(); 
                preencherDataAtual('#relDataInicial'); 
                preencherDataAtual('#relDataFinal'); 
                // Zera os filtros de catálogo do relatório
                $('#relTipoTransacao').val('Todas').trigger('change');
                $('#relUvr').trigger('change'); 
            }
            else if (formId === 'extratoBancarioContainer') { 
                loadExtratoUVRs(); 
                preencherDataAtual('#extratoDataInicial'); 
                preencherDataAtual('#extratoDataFinal'); 
            }
            else if (formId === 'gestaoAssociadosContainer') { 
                $('#inputBuscaAssociado').focus(); 
            }
            else if (formId === 'gestaoContasContainer') {
                $('#inputBuscaConta').focus();
                buscarContasCorrentes(); 
            } 
            else if (formId === 'gestaoTransacoesContainer') { 
                if(!$('#filtroDataIniTransacao').val()) preencherDatasPadraoFluxo(); 
                buscarTransacoesGestao(); 
            }
            else if (formId === 'gestaoCadastrosContainer') {
                 // Apenas abre
            }
            
            // --- NOVA TELA (ADICIONADA AQUI) ---
            else if (formId === 'gestaoProdutosServicosContainer') {
                // Inicializa o filtro de Grupo ao abrir a tela
                const filtroGrupo = $('#filtroGrupoGestao');
                // Garante que o select existe antes de tentar preencher
                if (filtroGrupo.length > 0) {
                    filtroGrupo.empty().append('<option value="">Todos os Grupos</option>');
                    if (typeof TODOS_GRUPOS_UNIFICADOS !== 'undefined') {
                        TODOS_GRUPOS_UNIFICADOS.forEach(g => filtroGrupo.append(`<option value="${g}">${g}</option>`));
                    }
                }
                $('#filtroTipoGestao').val(''); // Reseta filtro de tipo
                carregarTabelaProdutos('');     // Carrega todos os produtos
            }
        }

        $('#btnClienteFornecedor').click(() => mostrarFormulario('clienteFornecedorForm'));
        $('#btnAssociado').click(() => mostrarFormulario('associadoForm'));
        $('#btnProdutoServico').click(() => mostrarFormulario('produtoServicoForm'));
        $('#btnContaCorrente').click(() => mostrarFormulario('contaCorrenteForm'));
        $('#btnGestaoTransacoes').click(() => mostrarFormulario('gestaoTransacoesContainer'));
        $('#btnFluxoCaixa').click(() => mostrarFormulario('fluxoCaixaForm'));
        $('#btnRelatorios').click(() => mostrarFormulario('relatoriosFormContainer'));
        $('#btnExtratoBancario').click(() => mostrarFormulario('extratoBancarioContainer'));
        $('#btnGestaoAssociados').click(() => mostrarFormulario('gestaoAssociadosContainer'));
        $('#btnGestaoCadastros').click(() => mostrarFormulario('gestaoCadastrosContainer'));
        $('#btnGestaoContas').click(() => mostrarFormulario('gestaoContasContainer'));
        $('#btnReceitaDespesa').click(() => mostrarFormulario('receitaDespesaForm'));
        $('#btnGestaoProdutosServicos').click(() => mostrarFormulario('gestaoProdutosServicosContainer'));
        
        $('#inputBuscaAssociado').keypress(function(e) { if(e.which == 13) buscarAssociados(); });

        $('#uvrSelect').change(() => preencherAssociacao('uvrSelect', 'associacaoInput'));
        $('#uvrSelectAssociado').change(() => preencherAssociacao('uvrSelectAssociado', 'associacaoInputAssociado'));
        $('#uvrSelectConta').change(() => preencherAssociacao('uvrSelectConta', 'associacaoInputConta'));
        
        $('#uvrSelectTransacao').change(() => {
            preencherAssociacao('uvrSelectTransacao', 'associacaoInputTransacao');
            carregarOrigemTransacao(); 
            atualizarPatrimonioTransacao(); 
            $('#itensDocumentoContainer').empty(); 
            adicionarItemLinha(); 
        });
        
        $('#uvrFluxoCaixa').change(() => {
            preencherAssociacao('uvrFluxoCaixa', 'associacaoFluxoCaixa');
            carregarResumoFinanceiroFluxo();
            carregarContasCorrentesFluxo($('#uvrFluxoCaixa').val(), '#contaCorrenteSelect'); 
            atualizarCadastrosComNotasFluxo(); 
        });

        $('#fluxoDataInicialFiltro, #fluxoDataFinalFiltro').change(function() {
            carregarResumoFinanceiroFluxo(); 
            const idCadastro = $('#idCadastroCfStrHidden').val();
            const isRateio = $('#isAssociadoRateioHidden').val() === 'true';
            if(idCadastro) carregarNotasEmAbertoFluxo(idCadastro, isRateio);
        });

        $('#extratoUvr').change(() => { carregarContasCorrentesFluxo($('#extratoUvr').val(), '#extratoContaCorrente'); });

        function atualizarAtividadesCadastroClienteFornecedor() {
            var tipoCadastro = $('#tipoCadastroCF').val(); 
            var selectAtividade = $('#tipoAtividadeCF'); 
            selectAtividade.empty().append('<option value="">Selecione...</option>');
            
            let lista = [];
            if (tipoCadastro === "Fornecedor/Prestador") {
                lista = MAPA_GRUPOS_SISTEMA["Despesa"];
            } else if (tipoCadastro === "Cliente") {
                lista = MAPA_GRUPOS_SISTEMA["Receita"];
            }

            if (lista) {
                lista.sort().forEach(function(item) { selectAtividade.append(`<option value="${item}">${item}</option>`); });
            }
        }
        $('#tipoCadastroCF').change(atualizarAtividadesCadastroClienteFornecedor);
        
        function atualizarAtividadesProdutoServico() {
            var tipoPS = $('#tipoProdutoServicoSelect').val(); 
            var selectAtividadePS = $('#tipoAtividadeProdutoServicoSelect'); 
            selectAtividadePS.empty().append('<option value="">Selecione...</option>');
            
            let lista = [];
            if (tipoPS === "Despesa") { 
                lista = MAPA_GRUPOS_SISTEMA["Despesa"];
            } else if (tipoPS === "Receita") {
                lista = MAPA_GRUPOS_SISTEMA["Receita"];
            }

            if (lista) {
                lista.sort().forEach(function(item) { selectAtividadePS.append(`<option value="${item}">${item}</option>`); });
            }
        }
        $('#tipoProdutoServicoSelect').change(atualizarAtividadesProdutoServico);

        // --- BANCOS E CONTAS ---
        $('#cadastroContaCorrenteForm').on('submit', function(e) {
            const agencia = $('#agenciaContaInput').val().replace(/[^0-9]/g, '');
            const conta = $('#contaCorrenteContaInput').val(); 
            if (agencia.length === 0) { alert("O campo Agência é obrigatório e deve conter apenas números."); e.preventDefault(); return; }
            if (conta.length === 0) { alert("O campo Conta Corrente é obrigatório."); e.preventDefault(); return; }
        });

        function carregarOrigemTransacao() {
    const selectDropdown = $('#fornecedorPrestadorTransacaoSelect');
    const uvr = $('#uvrSelectTransacao').val();
    const tipoTransacao = $('#tipoTransacaoSelect').val(); 
    const tipoAtividade = $('#tipoAtividadeTransacaoSelect').val(); 
    const labelOrigem = $('#labelFornecedorPrestadorCliente');
    window.ultimaCargaOrigemTransacao = $.Deferred().resolve().promise();

    // Limpa o campo e limpa o input de nome oculto
    selectDropdown.empty().append('<option value="">Carregando...</option>');
    $('#nomeFornecedorPrestadorTransacaoInput').val(''); 

    // Validação de UVR
    if (!uvr) {
        selectDropdown.empty().append('<option value="">Selecione a UVR...</option>');
        labelOrigem.text('Fornecedor / Prestador / Cliente / Associado');
        selectDropdown.prop('required', true); 
        return window.ultimaCargaOrigemTransacao;
    }

    let url = '';
    const params = [`uvr=${encodeURIComponent(uvr)}`];
    let tipoOrigemDesc = ''; 
    let isRequired = true; 

    // LÓGICA DE DEFINIÇÃO DE ROTA E FILTRO
    if (tipoAtividade === "Rateio dos Associados") {
        url = '/get_associados_ativos'; 
        tipoOrigemDesc = 'Associado (para Rateio)';
        isRequired = false; 
    } else { 
        let tipoCadastroFiltro = '';
        
        // AJUSTE PARA O PYTHON ENTENDER O FILTRO 'AMBOS'
        if (tipoTransacao === 'Despesa') {
            tipoCadastroFiltro = 'Fornecedor'; // O Python buscará Fornecedor + Ambos
            tipoOrigemDesc = 'Fornecedor / Prestador';
        } else if (tipoTransacao === 'Receita') {
            tipoCadastroFiltro = 'Comprador'; // O Python buscará Comprador + Ambos
            tipoOrigemDesc = 'Cliente / Comprador';
        }

        if (!tipoCadastroFiltro) { 
            selectDropdown.empty().append('<option value="">Selecione Tipo de Transação...</option>');
            labelOrigem.text('Fornecedor / Prestador / Cliente');
            selectDropdown.prop('required', true);
            return window.ultimaCargaOrigemTransacao;
        }
        
        url = '/get_cadastros_ativos'; 
        params.push(`tipo_cadastro_filtro=${encodeURIComponent(tipoCadastroFiltro)}`);
    }

    labelOrigem.text(tipoOrigemDesc);
    selectDropdown.prop('required', isRequired); 

    // Monta a URL final com os parâmetros
    if (params.length > 0) { url += `?${params.join('&')}`; }

    // CHAMADA AJAX AO SERVIDOR
    const request = $.getJSON(url, function(data) {
        selectDropdown.empty();
        
        if (tipoAtividade === "Rateio dos Associados") {
            selectDropdown.append('<option value="">Rateio Geral (Nenhum Associado Específico)</option>'); 
        } else {
            selectDropdown.append(`<option value="">Selecione ${tipoOrigemDesc}...</option>`);
        }

        if (data && data.length > 0) {
            data.forEach(function(item) {
                // Compatibilidade: tenta pegar .nome (associado) ou .razao_social (cadastro)
                const idVal = item.id; 
                const nomeVal = item.razao_social || item.nome || 'Sem Nome'; 
                const tipoVal = item.tipo_cadastro || item.tipo || 'Geral'; 
                
                // Armazena o nome puro no data-nome para o input oculto
                selectDropdown.append(`<option value="${idVal}" data-nome="${nomeVal}">${nomeVal} (${tipoVal})</option>`);
            });
        } else if (tipoAtividade !== "Rateio dos Associados") { 
             selectDropdown.append(`<option value="">Nenhum ${tipoOrigemDesc} encontrado</option>`);
        }
    }).fail(function() { 
        selectDropdown.empty().append('<option value="">Erro ao carregar dados</option>'); 
    });
    window.ultimaCargaOrigemTransacao = request;
    return request;
}

function formatarDescricaoPatrimonio(item) {
    const descricao = item.descricao || 'Sem descrição';
    const identificador = item.placa || item.codigo_patrimonio || '';
    return identificador ? `${descricao} (${identificador})` : descricao;
}

function carregarPatrimonioTransacao() {
    const selectPatrimonio = $('#patrimonioTransacaoSelect');
    const uvr = $('#uvrSelectTransacao').val();
    const termo = $('#patrimonioBuscaInput').val().trim();
    const categoria = $('#patrimonioCategoriaSelect').val();

    if (!uvr) {
        selectPatrimonio.empty().append('<option value="">Selecione uma UVR primeiro</option>');
        return;
    }

    const params = [`uvr=${encodeURIComponent(uvr)}`];
    if (termo) {
        params.push(`q=${encodeURIComponent(termo)}`);
    }
    if (categoria) {
        params.push(`categoria=${encodeURIComponent(categoria)}`);
    }

    selectPatrimonio.empty().append('<option value="">Carregando...</option>');
    $.getJSON(`/buscar_patrimonio?${params.join('&')}`, function(data) {
        selectPatrimonio.empty().append('<option value="">Selecione...</option>');
        if (data && data.length > 0) {
            data.forEach(function(item) {
                const texto = formatarDescricaoPatrimonio(item);
                const controle = item.controle_por || '';
                const medidor = item.medidor_atual != null ? item.medidor_atual : '';
                selectPatrimonio.append(`<option value="${item.id}" data-controle="${controle}" data-medidor="${medidor}">${texto}</option>`);
            });
        } else {
            selectPatrimonio.append('<option value="">Nenhum patrimônio encontrado</option>');
        }
    }).fail(function() {
        selectPatrimonio.empty().append('<option value="">Erro ao carregar patrimônio</option>');
    });
}

function carregarMotoristasTransacao() {
    const selectMotorista = $('#motoristaTransacaoSelect');
    const uvr = $('#uvrSelectTransacao').val();

    selectMotorista.empty().append('<option value="">Carregando...</option>');
    $('#nomeMotoristaTransacaoInput').val('');

    if (!uvr) {
        selectMotorista.empty().append('<option value="">Selecione a UVR primeiro</option>');
        return;
    }

    $.getJSON(`/buscar_associados?status=Ativo&uvr=${encodeURIComponent(uvr)}`, function(data) {
        selectMotorista.empty().append('<option value="">Selecione...</option>');
        if (data && data.length > 0) {
            data.forEach(function(item) {
                selectMotorista.append(`<option value="${item.id}" data-nome="${item.nome}">${item.nome}</option>`);
            });
        } else {
            selectMotorista.append('<option value="">Nenhum associado ativo encontrado</option>');
        }
    }).fail(function() {
        selectMotorista.empty().append('<option value="">Erro ao carregar motoristas</option>');
    });
}

function atualizarCamposPatrimonioDespesa() {
    const selectedOption = $('#patrimonioTransacaoSelect option:selected');
    const controle = (selectedOption.data('controle') || '').toString().toLowerCase();
    const medidorAtual = selectedOption.data('medidor');
    const label = controle === 'horas' ? 'Horímetro Atual' : 'KM Atual';

    $('#labelMedidorAtualTransacao').text(label);
    $('#tipoMedidorTransacaoInput').val(controle || 'km');

    if (medidorAtual !== '' && medidorAtual !== undefined) {
        $('#medidorAtualTransacaoInput').attr('placeholder', `Último: ${medidorAtual}`);
    } else {
        $('#medidorAtualTransacaoInput').attr('placeholder', 'Informe o KM ou Horímetro');
    }

    const hasPatrimonio = $('#patrimonioTransacaoSelect').val();
    $('#medidorAtualTransacaoInput').prop('required', Boolean(hasPatrimonio));
}

function atualizarCamposCategoriaDespesa() {
    const categoria = $('#categoriaDespesaPatrimonioSelect').val();
    $('#combustivelFields').toggle(categoria === 'Combustivel');
    $('#manutencaoFields').toggle(categoria === 'Manutencao');

    if (categoria !== 'Combustivel') {
        $('#litrosTransacaoInput').val('');
        $('#tipoCombustivelTransacaoSelect').val('');
    }
    if (categoria !== 'Manutencao') {
        $('#tipoManutencaoTransacaoSelect').val('');
        $('#garantiaKmTransacaoInput').val('');
        $('#garantiaDataTransacaoInput').val('');
        $('#proximaRevisaoKmTransacaoInput').val('');
        $('#proximaRevisaoDataTransacaoInput').val('');
    }
}

function resetarCamposPatrimonio() {
    const selectPatrimonio = $('#patrimonioTransacaoSelect');
    selectPatrimonio.val('');
    $('#patrimonioBuscaInput').val('');
    $('#patrimonioCategoriaSelect').val('Todos');
    $('#categoriaDespesaPatrimonioSelect').val('');
    $('#medidorAtualTransacaoInput').val('').prop('required', false);
    $('#tipoMedidorTransacaoInput').val('');
    $('#motoristaTransacaoSelect').val('');
    $('#nomeMotoristaTransacaoInput').val('');
    $('#litrosTransacaoInput').val('');
    $('#tipoCombustivelTransacaoSelect').val('');
    $('#tipoManutencaoTransacaoSelect').val('');
    $('#garantiaKmTransacaoInput').val('');
    $('#garantiaDataTransacaoInput').val('');
    $('#proximaRevisaoKmTransacaoInput').val('');
    $('#proximaRevisaoDataTransacaoInput').val('');
    atualizarCamposCategoriaDespesa();
}

function atualizarVisibilidadePatrimonio() {
    const deveVincular = $('#vincularPatrimonioTransacaoToggle').is(':checked');
    const section = $('#patrimonioTransacaoSection');
    const selectPatrimonio = $('#patrimonioTransacaoSelect');

    if (deveVincular) {
        section.show();
        if (selectPatrimonio.children().length <= 1) {
            carregarPatrimonioTransacao();
        }
        carregarMotoristasTransacao();
        atualizarCamposPatrimonioDespesa();
        atualizarCamposCategoriaDespesa();
    } else {
        section.hide();
        resetarCamposPatrimonio();
    }
}
window.atualizarVisibilidadePatrimonio = atualizarVisibilidadePatrimonio;

function atualizarPatrimonioTransacao() {
    const tipoTransacao = $('#tipoTransacaoSelect').val();
    const toggleContainer = $('#patrimonioToggleContainer');
    const toggle = $('#vincularPatrimonioTransacaoToggle');

    if (tipoTransacao === 'Despesa') {
        toggleContainer.show();
        if (!toggle.is(':checked')) {
            resetarCamposPatrimonio();
            $('#patrimonioTransacaoSection').hide();
        } else {
            atualizarVisibilidadePatrimonio();
        }
    } else {
        toggleContainer.hide();
        toggle.prop('checked', false);
        $('#patrimonioTransacaoSection').hide();
        resetarCamposPatrimonio();
    }
}

function atualizarLabelNotaFiscalTransacao() {
    const tipoTransacao = $('#tipoTransacaoSelect').val();
    const label = $('#labelNotaFiscalTransacao');
    const input = $('#notaFiscalTransacaoUpload');
    let textoLabel = 'Anexar Nota Fiscal';

    if (tipoTransacao === 'Despesa') {
        textoLabel = 'Anexar Nota Fiscal de Despesa ou recibo de rateio assinado';
    } else if (tipoTransacao === 'Receita') {
        textoLabel = 'Anexar Nota Fiscal de Receita';
    }

    label.text(textoLabel);
    const isCadastro = $('#transacaoForm').attr('action') === '/registrar_transacao_financeira';
    input.prop('required', Boolean(tipoTransacao) && isCadastro);
    if (!tipoTransacao) {
        input.val('');
    }
}

$('#btnBuscarPatrimonioTransacao').click(function() {
    carregarPatrimonioTransacao();
});

$('#patrimonioCategoriaSelect').change(function() {
    carregarPatrimonioTransacao();
});

$('#patrimonioTransacaoSelect').change(function() {
    atualizarCamposPatrimonioDespesa();
});

$('#vincularPatrimonioTransacaoToggle').change(function() {
    atualizarVisibilidadePatrimonio();
});

$('#categoriaDespesaPatrimonioSelect').change(function() {
    atualizarCamposCategoriaDespesa();
});

$('#motoristaTransacaoSelect').change(function() {
    const selectedOption = $(this).find('option:selected');
    $('#nomeMotoristaTransacaoInput').val(selectedOption.data('nome') || '');
});

$('#patrimonioBuscaInput').keypress(function(e) {
    if (e.which === 13) {
        e.preventDefault();
        carregarPatrimonioTransacao();
    }
});


// EVENTO: Quando o usuário seleciona um item no dropdown
$('#fornecedorPrestadorTransacaoSelect').change(function() {
    const selectedOption = $(this).find('option:selected');
    // Pega o nome limpo do atributo data-nome
    const nomeSelecionado = selectedOption.data('nome') || "";
    // Preenche o input oculto que o Python usa para salvar a transação
    $('#nomeFornecedorPrestadorTransacaoInput').val(nomeSelecionado);
});
        
        function atualizarAtividadesTransacao() { 
        var tipo = $('#tipoTransacaoSelect').val(); // Pega "Receita" ou "Despesa"
        var selectAtividade = $('#tipoAtividadeTransacaoSelect'); // O campo "Atividade/Grupo"
        
        // Limpa as opções atuais
        selectAtividade.empty().append('<option value="">Selecione o Grupo...</option>');
        
        // Se não tiver tipo selecionado, para por aqui
        if (!tipo) return;

        let lista = [];
        
        // Pega a lista correta do MAPA GLOBAL
        if (tipo === "Despesa") {
            lista = MAPA_GRUPOS_SISTEMA["Despesa"];
        } else if (tipo === "Receita") {
            lista = MAPA_GRUPOS_SISTEMA["Receita"];
        }
        
        // Preenche o select com os Grupos
        if (lista && lista.length > 0) {
            lista.sort().forEach(function(item) { 
                selectAtividade.append(`<option value="${item}">${item}</option>`); 
            });
        }
    }
        
        $('#tipoTransacaoSelect').change(function(){ atualizarAtividadesTransacao(); atualizarPatrimonioTransacao(); atualizarLabelNotaFiscalTransacao(); });
        atualizarLabelNotaFiscalTransacao();

        $('#tipoAtividadeTransacaoSelect').change(function() { 
            carregarOrigemTransacao(); 
            $('#itensDocumentoContainer .item-row').each(function() { populateGrupos($(this)); });
        });

        function populateGrupos(rowElement) {
            const tipoTransacao = $('#tipoTransacaoSelect').val(); 
            const tipoAtividade = $('#tipoAtividadeTransacaoSelect').val(); 
            const grupoSelect = $(rowElement).find('.grupo-select');
            
            grupoSelect.empty().append('<option value="">Carregando Grupos...</option>');
            $(rowElement).find('.subgrupo-select').empty().append('<option value="">Selecione Grupo</option>').prop('disabled', true);
            $(rowElement).find('.item-select').empty().append('<option value="">Selecione Subgrupo</option>').prop('disabled', true);

            if (!tipoTransacao || !tipoAtividade) {
                grupoSelect.empty().append('<option value="">Selecione Tipo e Atividade da Transação</option>');
                return;
            }

            let url = '/get_distinct_grupos'; 
            let params = [];
            if (tipoTransacao) params.push(`tipo=${encodeURIComponent(tipoTransacao)}`); 
            if (tipoAtividade) params.push(`tipo_atividade=${encodeURIComponent(tipoAtividade)}`);
            if (params.length > 0) url += `?${params.join('&')}`;

            $.getJSON(url, function(data) {
                grupoSelect.empty().append('<option value="">Selecione Grupo...</option>');
                if (data && data.length > 0) {
                    data.forEach(function(grupo) { grupoSelect.append(`<option value="${grupo}">${grupo}</option>`); });
                } else { grupoSelect.append('<option value="">Nenhum grupo encontrado</option>'); }
            }).fail(function() { grupoSelect.empty().append('<option value="">Erro ao carregar grupos</option>'); });
        }

        function populateSubgrupos(rowElement, selectedGrupo) {
            const tipoTransacao = $('#tipoTransacaoSelect').val();
            const tipoAtividade = $('#tipoAtividadeTransacaoSelect').val(); 
            const subgrupoSelect = $(rowElement).find('.subgrupo-select');

            subgrupoSelect.empty().append('<option value="">Carregando Subgrupos...</option>').prop('disabled', true);
            $(rowElement).find('.item-select').empty().append('<option value="">Selecione Subgrupo</option>').prop('disabled', true);

            if (!selectedGrupo) {
                subgrupoSelect.empty().append('<option value="">Selecione Grupo Primeiro</option>').prop('disabled', true);
                return;
            }
            if (!tipoTransacao || !tipoAtividade) {
                subgrupoSelect.empty().append('<option value="">Selecione Tipo e Atividade da Transação</option>').prop('disabled', true);
                return;
            }

            let url = `/get_distinct_subgrupos?grupo=${encodeURIComponent(selectedGrupo)}`;
            let params = [];
            if (tipoTransacao) params.push(`tipo=${encodeURIComponent(tipoTransacao)}`); 
            if (tipoAtividade) params.push(`tipo_atividade=${encodeURIComponent(tipoAtividade)}`);
            if (params.length > 0) url += `&${params.join('&')}`;
            
            $.getJSON(url, function(data) {
                subgrupoSelect.empty().append('<option value="">Selecione Subgrupo...</option>');
                subgrupoSelect.append('<option value="">(Nenhum)</option>'); 
                if (data && data.length > 0) {
                    data.forEach(function(subgrupo) { subgrupoSelect.append(`<option value="${subgrupo}">${subgrupo}</option>`); });
                }
                subgrupoSelect.prop('disabled', false);
            }).fail(function() { subgrupoSelect.empty().append('<option value="">Erro ao carregar subgrupos</option>').prop('disabled', false); });
        }

        function populateItems(rowElement, selectedGrupo, selectedSubgrupo) {
            const tipoTransacao = $('#tipoTransacaoSelect').val();
            const tipoAtividade = $('#tipoAtividadeTransacaoSelect').val(); 
            const itemSelect = $(rowElement).find('.item-select');

            itemSelect.empty().append('<option value="">Carregando Itens...</option>').prop('disabled', true);

            if (!selectedGrupo) { 
                itemSelect.empty().append('<option value="">Selecione Grupo</option>').prop('disabled', true);
                return;
            }
            if (!tipoTransacao || !tipoAtividade) {
                itemSelect.empty().append('<option value="">Selecione Tipo e Atividade da Transação</option>').prop('disabled', true);
                return;
            }

            let url = `/get_items_for_filters?grupo=${encodeURIComponent(selectedGrupo)}&subgrupo=${encodeURIComponent(selectedSubgrupo === null ? "" : selectedSubgrupo)}`;
            let params = [];
            if (tipoTransacao) params.push(`tipo=${encodeURIComponent(tipoTransacao)}`); 
            if (tipoAtividade) params.push(`tipo_atividade=${encodeURIComponent(tipoAtividade)}`);
            if (params.length > 0) url += `&${params.join('&')}`;

            $.getJSON(url, function(data) {
                itemSelect.empty().append('<option value="">Selecione Item...</option>');
                if (data && data.length > 0) {
                    data.forEach(function(item) { itemSelect.append(`<option value="${item}">${item}</option>`); });
                } else { itemSelect.append('<option value="">Nenhum item encontrado</option>'); }
                itemSelect.prop('disabled', false);
            }).fail(function() { itemSelect.empty().append('<option value="">Erro ao carregar itens</option>').prop('disabled', false); });
        }
        
        const unidadesMedida = ["UN", "PC", "CX", "KG", "G", "L", "ML", "M", "M2", "M3", "H", "SV", "PCT", "RL", "FD", "GL", "LT", "DZ", "PAR", "JG", "KIT", "OUTRO"];
        let itemCounter = 0;

        function adicionarItemLinha(carregarListas = true) {
        itemCounter++;
        
        // Gera as options de unidade (mantendo sua lógica original)
        let unidadeOptions = "";
        if (typeof unidadesMedida !== 'undefined') {
            unidadeOptions = unidadesMedida.map(u => `<option value="${u}">${u}</option>`).join('');
        } else {
            // Fallback caso a variável não exista
            unidadeOptions = '<option value="UN">UN</option><option value="KG">KG</option><option value="HR">HR</option>';
        }

        const itemHtml = `
            <div class="item-row" id="itemRow${itemCounter}">
                <div class="item-fields-grid">
                    <div class="form-group">
                        <label for="grupo${itemCounter}">Grupo</label>
                        <select class="form-select grupo-select" id="grupo${itemCounter}" name="produto_servico_grupo[]">
                            <option value="">Selecione Grupo...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subgrupo${itemCounter}">Subgrupo</label>
                        <select class="form-select subgrupo-select" id="subgrupo${itemCounter}" name="produto_servico_subgrupo[]" disabled>
                            <option value="">Selecione Grupo Primeiro</option>
                        </select>
                    </div>
                    <div class="form-group desc-produto-servico"> 
                        <label for="desc${itemCounter}" class="required-field">Descrição Prod./Serv.</label>
                        <select class="form-select item-select" id="desc${itemCounter}" name="produto_servico_descricao[]" required disabled>
                            <option value="">Selecione Subgrupo Primeiro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="un${itemCounter}" class="required-field">UN</label>
                        <select class="form-select" id="un${itemCounter}" name="produto_servico_unidade[]" required>${unidadeOptions}</select>
                    </div>
                    <div class="form-group">
                        <label for="qtd${itemCounter}" class="required-field">Qtd.</label>
                        <input type="number" class="form-control item-calculavel" id="qtd${itemCounter}" name="produto_servico_quantidade[]" placeholder="Qtd." step="any" min="0.001" required>
                    </div>
                    <div class="form-group">
                        <label for="vu${itemCounter}" class="required-field">Vl. Unit. (R$)</label>
                        <input type="text" class="form-control item-calculavel valor-monetario" id="vu${itemCounter}" name="produto_servico_valor_unitario[]" placeholder="Unitário" required>
                    </div>
                    <div class="form-group">
                        <label for="vt${itemCounter}">Vl. Total Item (R$)</label>
                        <input type="text" class="form-control valor-total-item-input valor-monetario" id="vt${itemCounter}" name="produto_servico_valor_total_item[]" readonly>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remover-item" data-item="${itemCounter}"><i class="fas fa-times"></i></button>
                </div>
            </div>
        `;
        
        $('#itensDocumentoContainer').append(itemHtml);

        // --- AQUI ESTÁ A CORREÇÃO PRINCIPAL ---
        // Só carrega a lista via AJAX se carregarListas for true.
        // Na edição, passamos false para preencher manualmente e não resetar os campos.
        if (carregarListas) {
            populateGrupos($(`#itemRow${itemCounter}`)); 
        }

        $(`#vu${itemCounter}`).mask('#.##0,00', {reverse: true});
        $(`#vt${itemCounter}`).mask('#.##0,00', {reverse: true}); 
    }

    // Torna a função acessível globalmente (importante para o botão de Editar chamar)
    window.adicionarItemLinha = adicionarItemLinha;

    // --- EVENT LISTENERS ---

    // Botão Adicionar (Passa true para carregar listas)
    $('#btnAdicionarItem').off('click').on('click', function() {
        adicionarItemLinha(true);
    });

    // Remover Item
    $('#itensDocumentoContainer').on('click', '.remover-item', function() {
        $(this).closest('.item-row').remove();
        calcularValorTotalDocumento();
    });
    
    // Mudança de Grupo -> Carrega Subgrupo
    $('#itensDocumentoContainer').on('change', '.grupo-select', function() {
        const selectedGrupo = $(this).val();
        const rowElement = $(this).closest('.item-row');
        populateSubgrupos(rowElement, selectedGrupo);
    });

    // Mudança de Subgrupo -> Carrega Item
    $('#itensDocumentoContainer').on('change', '.subgrupo-select', function() {
        const selectedSubgrupo = $(this).val(); 
        const rowElement = $(this).closest('.item-row');
        const selectedGrupo = $(rowElement).find('.grupo-select').val();
        populateItems(rowElement, selectedGrupo, selectedSubgrupo);
    });

    // Cálculo Automático
    $('#itensDocumentoContainer').on('input change keyup', '.item-calculavel', function() { 
        let row = $(this).closest('.item-row');
        
        // Pega QTD (Input Number usa ponto)
        let qtdVal = row.find('input[name="produto_servico_quantidade[]"]').val();
        let qtd = parseFloat(qtdVal) || 0;

        // Pega Valor Unitário (Input Text usa Vírgula e Máscara)
        let vuStr = row.find('input[name="produto_servico_valor_unitario[]"]').val();
        let vu = parseFloat(vuStr.replace("R$", "").replace(/\./g, '').replace(',', '.')) || 0;

        let totalItem = qtd * vu;
        
        // Formata e coloca no total
        row.find('input[name="produto_servico_valor_total_item[]"]').val(totalItem.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        
        calcularValorTotalDocumento();
    });

        function calcularValorTotalDocumento() {
            let totalDocumento = 0;
            $('#itensDocumentoContainer .item-row').each(function() {
                let valorTotalItemStr = $(this).find('input[name="produto_servico_valor_total_item[]"]').val().replace("R$", "").replace(/\./g, '').replace(',', '.');
                if (valorTotalItemStr) {
                    totalDocumento += parseFloat(valorTotalItemStr) || 0;
                }
            });
            $('#valorTotalDocumentoCalculado').val(totalDocumento.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        }
        
        $('#transacaoForm').on('submit', function(e) { 
            if ($('#itensDocumentoContainer .item-row').length === 0) {
                alert("Adicione pelo menos um produto/serviço à transação.");
                e.preventDefault(); 
                return false;
            }
            let itemValido = true;
            $('#itensDocumentoContainer .item-row').each(function(index) {
                const itemSelect = $(this).find('.item-select');
                const grupoSelect = $(this).find('.grupo-select'); 
                if (!itemSelect.val() && grupoSelect.val()) { 
                    alert(`Por favor, selecione a Descrição do Produto/Serviço para o item ${index + 1}.`);
                    itemSelect.focus();
                    itemValido = false;
                    return false; 
                }
            });
            if (!itemValido) {
                e.preventDefault();
                return false;
            }

            const tipoAtividade = $('#tipoAtividadeTransacaoSelect').val();
            const origemSelecionada = $('#fornecedorPrestadorTransacaoSelect').val(); 
            const nomeOrigemInputHidden = $('#nomeFornecedorPrestadorTransacaoInput');

            if (tipoAtividade === "Rateio dos Associados") {
                if (!origemSelecionada) { 
                     nomeOrigemInputHidden.val("Rateio Geral Associados");
                } else { 
                    if (!nomeOrigemInputHidden.val()) { 
                         nomeOrigemInputHidden.val($('#fornecedorPrestadorTransacaoSelect option:selected').data('nome'));
                    }
                }
            } else { 
                if (!origemSelecionada) {
                    alert("O campo '" + $('#labelFornecedorPrestadorCliente').text() + "' é obrigatório para este Tipo de Atividade.");
                    $('#fornecedorPrestadorTransacaoSelect').focus();
                    e.preventDefault();
                    return false;
                }
                 if (!nomeOrigemInputHidden.val()) { 
                     nomeOrigemInputHidden.val($('#fornecedorPrestadorTransacaoSelect option:selected').data('nome'));
                 }
            }
            if (!nomeOrigemInputHidden.val() && tipoAtividade !== "Rateio dos Associados" && !origemSelecionada) {
                 alert("O campo 'Nome do Fornecedor/Prestador/Cliente/Associado' é obrigatório.");
                 e.preventDefault();
                 return false;
            }
        });
// --- FUNÇÃO BLINDADA: Preenchimento de Associação ---
    function atualizarNomeAssociacao() {
        console.log("Tentando atualizar associação..."); // Para debug no console (F12)

        // Tenta buscar os elementos pelo ID
        var campoUvrSelect = document.getElementById('uvrSelectAssociado');
        var campoUvrInput = document.getElementById('uvrInputAssociado');
        var campoAssociacao = document.getElementById('associacaoInput');

        if (!campoAssociacao) {
            console.error("Campo Associação não encontrado!");
            return;
        }

        // Descobre qual valor usar
        var valorUvr = "";
        
        // Se o select existe e tem valor, usa ele
        if (campoUvrSelect && campoUvrSelect.value) {
            valorUvr = campoUvrSelect.value;
        } 
        // Se não, tenta o input (caso seja usuário comum)
        else if (campoUvrInput && campoUvrInput.value) {
            valorUvr = campoUvrInput.value;
        }

        // Limpa e padroniza o texto (remove espaços e poe em maiúsculo)
        var uvrLimpo = valorUvr.trim().toUpperCase().replace(/\s/g, '');

        console.log("Valor lido da UVR:", valorUvr, "Valor limpo:", uvrLimpo);

        // Define a associação
        if (uvrLimpo === 'UVR01') {
            campoAssociacao.value = 'ASCAMAR';
        } else if (uvrLimpo === 'UVR02') {
            campoAssociacao.value = 'ACAN';
        } else {
            // Se não encontrou nada, deixa vazio (ou mantém o que estava)
            if(uvrLimpo === '') campoAssociacao.value = '';
        }
    }

    // --- GARANTIA EXTRA: Executa ao carregar a página ---
    document.addEventListener('DOMContentLoaded', function() {
        // Aguarda 500ms para garantir que o navegador preencheu os campos automáticos
        setTimeout(atualizarNomeAssociacao, 500);
    });
        
// --- LÓGICA PARA FLUXO DE CAIXA ---
        function carregarResumoFinanceiroFluxo() {
            const uvr = $('#uvrFluxoCaixa').val();
            const dataIni = $('#fluxoDataInicialFiltro').val();
            const dataFim = $('#fluxoDataFinalFiltro').val();

            if (!uvr || !dataIni || !dataFim) {
                $('#painelFluxoResumo').hide();
                return;
            }

            $.get(`/get_resumo_fluxo_caixa?uvr=${uvr}&data_inicial=${dataIni}&data_final=${dataFim}`, function(resumo) {
                $('#resumoReceitas').text(parseFloat(resumo.receitas_a_receber || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                $('#resumoDespesas').text(parseFloat(resumo.despesas_a_pagar || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                $('#resumoSaldo').text(parseFloat(resumo.saldo_projetado || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                $('#painelFluxoResumo').show();
            }).fail(function() {
                $('#painelFluxoResumo').hide();
            });
        }

        function carregarContasCorrentesFluxo(uvr, selectId) {
            const select = $(selectId); 
            select.empty().append('<option value="">Carregando...</option>');
            if (!uvr) {
                select.empty().append('<option value="">Selecione a UVR...</option>');
                select.prop('disabled', true); 
                return;
            }
            $.get(`/get_contas_correntes?uvr=${uvr}`, function(data) { 
                select.empty().append('<option value="">Selecione a Conta...</option>');
                if (data && data.length > 0) {
                    data.forEach(c => { select.append(`<option value="${c.id}" data-uvr-conta="${c.uvr}">${c.display_name}</option>`); });
                    select.prop('disabled', false); 
                } else {
                    select.append('<option value="">Nenhuma conta encontrada para esta UVR</option>');
                    select.prop('disabled', true); 
                }
            }).fail(function() {
                select.empty().append('<option value="">Erro ao carregar contas</option>');
                select.prop('disabled', true);
            });
        }

        // --- FUNÇÃO ATUALIZADA: LISTA CLIENTES/FORNECEDORES FILTRADA POR DATA ---
        function atualizarCadastrosComNotasFluxo() {
            const uvr = $('#uvrFluxoCaixa').val();
            const tipoMov = $('#tipoMovimentacao').val();
            const dataIni = $('#fluxoDataInicialFiltro').val(); // PEGA DATA INICIAL
            const dataFim = $('#fluxoDataFinalFiltro').val();   // PEGA DATA FINAL
            
            const select = $('#cadastroCFSelect');
            select.empty().append('<option value="">Carregando...</option>');
            $('#nfsEmAbertoContainer').html('<small class="text-muted">Selecione para listar documentos.</small>');
            $('#idCadastroCfStrHidden').val('');
            $('#isAssociadoRateioHidden').val('');
            $('#nomeCadastroCfDisplayHidden').val('');

            if (!uvr || !tipoMov || !dataIni || !dataFim) {
                select.empty().append('<option value="">Preencha UVR, Tipo e Datas...</option>');
                return;
            }
            
            $('#labelClienteFornecedorFluxo').text(tipoMov === 'Recebimento' ? 'Cliente com Pendências' : 'Fornecedor/Associado com Pendências');
            
            // Agora enviamos as datas na requisição
            const params = new URLSearchParams({
                uvr: uvr,
                tipo_movimentacao: tipoMov,
                data_inicial: dataIni,
                data_final: dataFim
            });

            $.get(`/get_clientes_fornecedores_com_pendencias?${params.toString()}`, function(data) {
                select.empty().append(`<option value="">Selecione ${tipoMov === 'Recebimento' ? 'Cliente' : 'Fornecedor/Associado'}...</option>`);
                
                if (data && data.length > 0) {
                    data.forEach(c => {
                        const isRateio = c.is_associado_rateio || false;
                        select.append(`<option value="${c.id}" 
                            data-nome="${c.razao_social}" 
                            data-is-associado-rateio="${isRateio}">
                            ${c.razao_social}${isRateio ? " (Rateio)" : ""}
                        </option>`);
                    });
                } else {
                    select.append(`<option value="">Nenhuma pendência neste período</option>`);
                }
            }).fail(function() { select.empty().append('<option value="">Erro ao carregar</option>'); });
        }

        // --- LISTENER PARA RECARREGAR QUANDO MUDA A DATA ---
        $('#fluxoDataInicialFiltro, #fluxoDataFinalFiltro').change(function() {
            atualizarCadastrosComNotasFluxo();
            carregarResumoFinanceiroFluxo(); // Atualiza o painel de resumo também
        });

        $('#tipoMovimentacao').change(function() { atualizarCadastrosComNotasFluxo(); });

        $('#cadastroCFSelect').change(function() {
            const selectedOption = $(this).find('option:selected');
            const idCadastroCfOriginal = selectedOption.val(); 
            const nomeCadastroCfDisplay = selectedOption.data('nome') || selectedOption.text().split(' (')[0];
            const isAssociadoRateio = selectedOption.data('is-associado-rateio') || false;
            
            $('#idCadastroCfStrHidden').val(idCadastroCfOriginal);
            $('#isAssociadoRateioHidden').val(isAssociadoRateio);
            $('#nomeCadastroCfDisplayHidden').val(nomeCadastroCfDisplay);

            carregarNotasEmAbertoFluxo(idCadastroCfOriginal, isAssociadoRateio);
        });

        function carregarNotasEmAbertoFluxo(idCadastroOuNome, isRateio) { 
            const uvr = $('#uvrFluxoCaixa').val();
            const tipoMov = $('#tipoMovimentacao').val();
            const dataIni = $('#fluxoDataInicialFiltro').val();
            const dataFim = $('#fluxoDataFinalFiltro').val();
            const container = $('#nfsEmAbertoContainer');

            container.empty();

            if (!idCadastroOuNome || !uvr || !tipoMov || !dataIni || !dataFim) {
                container.html('<small class="text-muted">Informações insuficientes (Datas/Cadastro) para carregar documentos.</small>');
                calcularSaldoOperacaoFluxo(); 
                return;
            }
            
            container.html('<small class="text-muted">Carregando documentos...</small>');

            const params = new URLSearchParams({
                uvr: uvr,
                id_cadastro_cf: idCadastroOuNome, 
                tipo_movimentacao: tipoMov,
                is_associado_rateio: isRateio,
                data_inicial: dataIni,
                data_final: dataFim 
            });
            
            $.get(`/get_notas_em_aberto?${params.toString()}`, function(notas) {
                container.empty();
                if (notas && notas.length > 0) {
                    notas.forEach(nf => {
                        let dataDocFormatada = new Date(nf.data_documento + 'T00:00:00').toLocaleDateString('pt-BR');
                        container.append(`
                            <div class="form-check">
                                <input class="form-check-input nf-checkbox" type="checkbox" 
                                    value="${nf.id}" 
                                    id="fluxo_nf_${nf.id}" 
                                    data-valor-pendente="${nf.valor_restante}">
                                <label class="form-check-label" for="fluxo_nf_${nf.id}">
                                    ${nf.numero_documento || 'Sem doc'} (${dataDocFormatada}) - 
                                    R$ ${parseFloat(nf.valor_restante).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                </label>
                            </div>
                        `);
                    });
                } else { container.html('<small class="text-muted">Nenhum documento em aberto encontrado neste período.</small>'); }
                calcularSaldoOperacaoFluxo(); 
            }).fail(function() { container.html('<small class="text-danger">Erro ao carregar documentos.</small>'); calcularSaldoOperacaoFluxo(); });
        }
        
        function calcularSaldoOperacaoFluxo() {
            let valorEfetivo = parseFloat($('#valorEfetivo').val().replace(/\./g, '').replace(',', '.')) || 0;
            let totalNfsSelecionadas = 0;
            
            $('.nf-checkbox:checked').each(function() {
                totalNfsSelecionadas += parseFloat($(this).data('valor-pendente')) || 0;
            });
            
            let saldo = totalNfsSelecionadas - valorEfetivo;
            $('#saldoOperacaoDisplay').val('R$ ' + saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
        }

        $('#valorEfetivo').on('input change keyup paste', calcularSaldoOperacaoFluxo);
        $('#nfsEmAbertoContainer').on('change', '.nf-checkbox', calcularSaldoOperacaoFluxo);


        $('#formRegistrarFluxoCaixa').off('submit').on('submit', function(e) {
            e.preventDefault();
            
            // 1. Gera Data/Hora no formato exato que o Python exige (dd/mm/aaaa HH:MM:SS)
            const d = new Date();
            const strAgora = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
            
            if($('#dataHoraRegistroFluxo').length) $('#dataHoraRegistroFluxo').val(strAgora);

            // Coleta valores diretos dos campos para garantir
            const uvr = $('#uvrFluxoCaixa').val();
            const tipoMov = $('#tipoMovimentacao').val();
            const idCadastroCfStr = $('#cadastroCFSelect').val(); 
            const idConta = $('#contaCorrenteSelect').val();
            const dataEfetiva = $('#dataEfetivaFluxo').val();
            const valorEfetivo = $('#valorEfetivo').val(); 
            
            // Validação Explícita
            if (!uvr) return alert("Erro: UVR não selecionada.");
            if (!tipoMov) return alert("Erro: Tipo de Movimentação não selecionado.");
            if (!idCadastroCfStr) return alert("Erro: Entidade (Cliente/Fornecedor) não selecionada.");
            if (!idConta) return alert("Erro: Conta Bancária não selecionada.");
            if (!dataEfetiva) return alert("Erro: Data Efetiva não preenchida.");
            if (!valorEfetivo) return alert("Erro: Valor não preenchido.");
            
            // Validação de Notas Selecionadas
            const nfsSelecionadas = $('.nf-checkbox:checked');
            if (nfsSelecionadas.length === 0) {
                alert("Atenção: Selecione pelo menos uma nota/fatura na lista para dar baixa.");
                return;
            }
            
            // Monta o objeto JSON
            const formData = {
                uvr: uvr,
                associacao: $('#associacaoFluxoCaixa').val() || "", 
                tipo_movimentacao: tipoMov,
                id_cadastro_cf_str: idCadastroCfStr,
                is_associado_rateio: $('#cadastroCFSelect').find(':selected').data('is-associado-rateio') || false, 
                nome_cadastro_cf_display: $('#cadastroCFSelect').find(':selected').text().trim(),
                id_conta_corrente: idConta,
                numero_documento_bancario: $('input[name="numero_documento_bancario"]').val(),
                data_efetiva: dataEfetiva,
                valor_efetivo: valorEfetivo.replace(/\./g, '').replace(',', '.'), 
                data_hora_registro_fluxo: strAgora, 
                observacoes: $('textarea[name="observacoes"]').val(),
                ids_nfs_selecionadas: nfsSelecionadas.map(function() { return this.value; }).get()
            };
            
            $.ajax({
                url: '/registrar_fluxo_caixa',
                type: 'POST',
                contentType: 'application/json', 
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.status === 'sucesso') {
                        alert("Movimentação de Fluxo de Caixa registrada com sucesso!");
                        
                        // Limpa tudo
                        $('#formRegistrarFluxoCaixa')[0].reset(); 
                        $('#nfsEmAbertoContainer').empty().html('<small class="text-muted">Selecione para listar documentos.</small>');
                        $('#saldoOperacaoDisplay').val('');
                        
                        // Atualiza data/hora para o próximo registro
                        if(typeof atualizarRelogio === 'function') atualizarRelogio();
                        
                        // Atualiza as listas se possível
                        if (uvr) {
                            carregarResumoFinanceiroFluxo();
                            atualizarCadastrosComNotasFluxo(); 
                        }
                    } else {
                        alert("Erro ao registrar: " + (response.error || "Erro desconhecido."));
                    }
                },
                error: function(xhr) {
                    let errorMsg = "Erro ao registrar Fluxo de Caixa.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += " Detalhes: " + xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                    console.error("Erro AJAX:", xhr);
                }
            });
        });

        // --- LÓGICA PARA RELATÓRIOS FINANCEIROS ---
        function loadRelatorioUVRs() { 
            $.getJSON('/get_relatorio_uvrs', function(data) {
                const selects = $('#relUvr, #extratoUvr'); 
                selects.find('option:not(:first)').remove(); // Limpa opções anteriores, exceto a primeira ("Todas" ou "Selecione")
                data.forEach(uvr => selects.append(`<option value="${uvr}">${uvr}</option>`));
            }).fail(() => console.error("Erro ao carregar UVRs para relatórios/extratos."));
        }
        function loadExtratoUVRs() { loadRelatorioUVRs(); } // Reutiliza a função

        function loadRelatorioTiposAtividadeTransacao(tipoTransacao) {
            const select = $('#relTipoAtividadeTransacao');
            select.find('option:not(:first)').remove().end().val(''); 
            select.prop('disabled', true);
            $('#relGrupo').find('option:not(:first)').remove().end().val('').prop('disabled', true); 
            $('#relSubgrupo').find('option:not(:first)').remove().end().val('').prop('disabled', true);
            $('#relItem').find('option:not(:first)').remove().end().val('').prop('disabled', true);

            if (!tipoTransacao) { 
                 loadRelatorioCatalogOptions('grupo', {}); 
                 return;
            }

            $.getJSON(`/get_relatorio_tipos_atividade_transacao?tipo_transacao=${tipoTransacao}`, function(data) {
                if (data && data.length > 0) {
                    data.forEach(atv => select.append(`<option value="${atv}">${atv}</option>`));
                    select.prop('disabled', false);
                }
                loadRelatorioCatalogOptions('grupo', { tipo_transacao: tipoTransacao, tipo_atividade_catalogo: select.val() }); 
            }).fail(() => console.error("Erro ao carregar Tipos de Atividade da Transação para relatório."));
        }
        
        function loadRelatorioCatalogOptions(optionType, filters = {}) {
            const selectMap = {
                'grupo': $('#relGrupo'),
                'subgrupo': $('#relSubgrupo'),
                'item': $('#relItem')
            };
            const currentSelect = selectMap[optionType];
            currentSelect.find('option:not(:first)').remove().end().val(''); 
            currentSelect.prop('disabled', true);

            if (optionType === 'grupo') {
                $('#relSubgrupo').find('option:not(:first)').remove().end().val('').prop('disabled', true);
                $('#relItem').find('option:not(:first)').remove().end().val('').prop('disabled', true);
            } else if (optionType === 'subgrupo') {
                $('#relItem').find('option:not(:first)').remove().end().val('').prop('disabled', true);
            }

            if (optionType === 'subgrupo' && !filters.grupo) { return; }
            if (optionType === 'item' && !filters.grupo ) { return; } 

            let queryParams = `option_type=${optionType}`;
            if (filters.tipo_transacao) queryParams += `&tipo_transacao=${encodeURIComponent(filters.tipo_transacao)}`;
            if (filters.tipo_atividade_catalogo) queryParams += `&tipo_atividade_catalogo=${encodeURIComponent(filters.tipo_atividade_catalogo)}`;
            if (filters.grupo) queryParams += `&grupo=${encodeURIComponent(filters.grupo)}`;
            if (filters.subgrupo) queryParams += `&subgrupo=${encodeURIComponent(filters.subgrupo)}`;

            $.getJSON(`/get_relatorio_catalog_options?${queryParams}`, function(data) {
                if (data && data.length > 0) {
                    data.forEach(opt => currentSelect.append(`<option value="${opt}">${opt}</option>`));
                    if(optionType === 'subgrupo') { 
                        currentSelect.append('<option value="(Nenhum)">(Nenhum)</option>'); 
                    }
                    currentSelect.prop('disabled', false);
                } else if (optionType === 'subgrupo') { 
                     currentSelect.append('<option value="(Nenhum)">(Nenhum)</option>');
                     currentSelect.prop('disabled', false);
                }
            }).fail(() => console.error(`Erro ao carregar ${optionType} para relatório.`));
        }

        function loadRelatorioEntidades() {
            const tipoEntidade = $('#relTipoEntidade').val();
            const uvr = $('#relUvr').val();
            const tipoTransacao = $('#relTipoTransacao').val();
            const selectNomeEntidade = $('#relNomeEntidade');
            
            selectNomeEntidade.empty().append('<option value="">Carregando...</option>').prop('disabled', true);

            if (!tipoEntidade) {
                selectNomeEntidade.empty().append('<option value="">Selecione Tipo Entidade</option>').prop('disabled', true);
                return;
            }

            let queryParams = `tipo_entidade=${encodeURIComponent(tipoEntidade)}`;
            if (uvr) queryParams += `&uvr=${encodeURIComponent(uvr)}`;
            if (tipoTransacao) queryParams += `&tipo_transacao_rel=${encodeURIComponent(tipoTransacao)}`;


            $.getJSON(`/get_relatorio_entidades_para_filtro?${queryParams}`, function(data) {
                selectNomeEntidade.empty().append(`<option value="">Todos(as) os(as) ${tipoEntidade.toLowerCase()}s</option>`);
                if (data && data.length > 0) {
                    data.forEach(entidade => {
                        selectNomeEntidade.append(`<option value="${entidade.id}" data-nome-entidade="${entidade.nome}">${entidade.nome}</option>`);
                    });
                    selectNomeEntidade.prop('disabled', false);
                } else {
                    selectNomeEntidade.append(`<option value="">Nenhum(a) ${tipoEntidade.toLowerCase()} encontrado(a)</option>`);
                     selectNomeEntidade.prop('disabled', true); 
                }
            }).fail(function() {
                selectNomeEntidade.empty().append('<option value="">Erro ao carregar entidades</option>').prop('disabled', true);
                console.error(`Erro ao carregar entidades do tipo: ${tipoEntidade} com UVR: ${uvr} e Tipo Trans.: ${tipoTransacao}`);
            });
        }
        
        $('#relUvr, #relTipoTransacao, #relTipoEntidade').change(function() { loadRelatorioEntidades(); });

        $('#relTipoAtividadeTransacao').change(function() {
            const tipoTransacao = $('#relTipoTransacao').val();
            const tipoAtividadeTransacao = $(this).val(); 
            loadRelatorioCatalogOptions('grupo', { tipo_transacao: tipoTransacao, tipo_atividade_catalogo: tipoAtividadeTransacao });
        });

        $('#relGrupo').change(function() {
            const tipoTransacao = $('#relTipoTransacao').val();
            const tipoAtividadeTransacao = $('#relTipoAtividadeTransacao').val();
            const grupo = $(this).val();
            loadRelatorioCatalogOptions('subgrupo', { tipo_transacao: tipoTransacao, tipo_atividade_catalogo: tipoAtividadeTransacao, grupo: grupo });
        });

        $('#relSubgrupo').change(function() {
            const tipoTransacao = $('#relTipoTransacao').val();
            const tipoAtividadeTransacao = $('#relTipoAtividadeTransacao').val();
            const grupo = $('#relGrupo').val();
            const subgrupo = $(this).val();
            loadRelatorioCatalogOptions('item', { tipo_transacao: tipoTransacao, tipo_atividade_catalogo: tipoAtividadeTransacao, grupo: grupo, subgrupo: subgrupo });
        });

        let currentReportFilters = {}; 
    
    $('#btnGerarRelatorio').click(function() {
        const nomeEntidadeSelecionada = $('#relNomeEntidade option:selected').data('nome-entidade');

        // Captura todos os valores dos filtros
        currentReportFilters = {
            data_inicial: $('#relDataInicial').val(), 
            data_final: $('#relDataFinal').val(),
            uvr: $('#relUvr').val(), 
            tipo_transacao_rel: $('#relTipoTransacao').val(), 
            tipo_entidade: $('#relTipoEntidade').val(), 
            id_entidade: $('#relNomeEntidade').val(),  
            nome_entidade_display: nomeEntidadeSelecionada || $('#relNomeEntidade option:selected').text().split(" (")[0], // Para uso no PDF/CSV
            tipo_atividade_transacao_rel: $('#relTipoAtividadeTransacao').val(), 
            grupo_rel: $('#relGrupo').val(), 
            subgrupo_rel: $('#relSubgrupo').val(), 
            item_rel: $('#relItem').val(), 
            status_pagamento_rel: $('#relStatusPagamento').val(),
            listar_por: $('#relListarPor').val() 
        };
        
        // Validações básicas
        if (!currentReportFilters.data_inicial || !currentReportFilters.data_final) {
            alert("Por favor, selecione Data Inicial e Data Final."); return;
        }
        if (new Date(currentReportFilters.data_inicial) > new Date(currentReportFilters.data_final)) {
            alert("A Data Inicial não pode ser maior que a Data Final."); return;
        }

        // Prepara UI para carregamento
        $('#relatorioStatus').text('Gerando relatório...').show();
        $('#tabelaRelatorio thead').empty(); 
        $('#tabelaRelatorio tbody').empty();
        $('#btnBaixarCsv').hide(); 
        $('#btnBaixarPdfRelatorioFinanceiro').hide();

        // Chamada AJAX para o Backend
        $.ajax({
            url: '/gerar_relatorio', 
            type: 'POST', 
            contentType: 'application/json',
            data: JSON.stringify(currentReportFilters),
            success: function(data) {
                $('#relatorioStatus').hide();
                
                if (data.error) { 
                    alert(`Erro ao gerar relatório: ${data.error}`); 
                    return; 
                }
                if (data.length === 0) { 
                    $('#relatorioStatus').text('Nenhum dado encontrado para os filtros selecionados.').show(); 
                    return; 
                }

                // Definição das Colunas
                const headers = [
                    "UVR", "Associação", "Fornecedor/Cliente/Associado", "Nº Doc.", 
                    "Data Doc.", "Data Efetiva Pag./Rec.", 
                    "Tipo Trans.", "Tipo Ativ. Trans.", "Item Descrição", 
                    "Tipo Item (Cat.)", "Tipo Ativ. (Cat.)", "Grupo (Cat.)", "Subgrupo (Cat.)", 
                    "UN", "Qtd.", "Vl. Unit. (R$)", "Vl. Total Item (R$)", 
                    "Status Pag. NF", "Valor Pago/Rec. Item (R$)" 
                ];
                const headerKeys = [
                    "uvr", "associacao", "nome_cadastro_origem", "numero_documento", 
                    "data_documento", "data_efetiva_pag_rec", 
                    "tipo_transacao", "tipo_atividade_transacao", "item_descricao", 
                    "item_tipo_catalogo", "item_tipo_atividade_catalogo", "item_grupo_catalogo", "item_subgrupo_catalogo",
                    "unidade", "quantidade", "valor_unitario", "valor_total_item", 
                    "status_pagamento", "valor_pago_neste_item" 
                ];
                
                // Monta Cabeçalho
                let headerHtml = '<tr>'; 
                headers.forEach(h => headerHtml += `<th>${h}</th>`); 
                headerHtml += '</tr>';
                $('#tabelaRelatorio thead').html(headerHtml);

                // Monta Corpo da Tabela
                let tbodyHtml = '';
                data.forEach(row => {
                    tbodyHtml += '<tr>';
                    headerKeys.forEach(key => {
                        let value = row[key] !== null && row[key] !== undefined ? row[key] : '';
                        
                        // Formatação Condicional
                        if (key === 'data_documento' && value) { 
                            if (String(value).includes('-')) { 
                                 try { value = new Date(value + 'T00:00:00').toLocaleDateString('pt-BR'); } catch(e) { /* mantem original */ }
                            }
                        } else if (key === 'data_efetiva_pag_rec' && value) { 
                            if (String(value).includes('-')) {
                                 try { value = new Date(value + 'T00:00:00').toLocaleDateString('pt-BR'); } catch(e) { /* mantem original */ }
                            }
                        } else if (key === 'data_hora_registro' && value) { 
                            if (String(value).includes('T')) {
                                 try { value = new Date(value).toLocaleString('pt-BR'); } catch(e) { /* mantem original */ }
                            }
                        } else if (['valor_unitario', 'valor_total_item', 'valor_pago_neste_item'].includes(key) && value) { 
                            try { value = parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); } catch(e) { /* mantem original */ }
                        } else if (key === 'quantidade' && value) {
                            try { value = parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 }); } catch(e) { /* mantem original */ }
                        }
                        
                        tbodyHtml += `<td>${value}</td>`;
                    });
                    tbodyHtml += '</tr>';
                });
                
                $('#tabelaRelatorio tbody').html(tbodyHtml);
                $('#btnBaixarCsv').show();
                $('#btnBaixarPdfRelatorioFinanceiro').show();
            },
            error: function(xhr) { 
                $('#relatorioStatus').hide(); 
                alert(`Erro ao gerar relatório: ${xhr.responseText || 'Erro desconhecido'}`); 
            }
        });
    });

        function baixarArquivo(url, filters, defaultFilename) {
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            })
            .then(async resp => {
                if (resp.ok) {
                    const blob = await resp.blob();
                    let filename = defaultFilename;
                    const disposition = resp.headers.get('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) { filename = matches[1].replace(/['"]/g, '');}
                    }
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(link.href);
                } else {
                    const errorData = await resp.json().catch(() => null);
                    let errorMsg = "Erro ao baixar arquivo";
                    if (errorData && errorData.message) { errorMsg += `: ${errorData.message}`; }
                    else if (errorData && errorData.error) { errorMsg += `: ${errorData.error}`; }
                    else { errorMsg += `: ${resp.statusText}`; }
                    alert(errorMsg);
                }
            })
            .catch(err => {
                console.error("Falha na requisição de download:", err);
                alert("Erro ao baixar arquivo. Verifique o console.");
            });
        }

        $('#btnBaixarCsv').click(function() {
            if (Object.keys(currentReportFilters).length === 0) { alert("Gere um relatório financeiro primeiro."); return; }
            baixarArquivo('/baixar_csv_relatorio', currentReportFilters, 'relatorio_financeiro.csv');
        });
        $('#btnBaixarPdfRelatorioFinanceiro').click(function() {
            if (Object.keys(currentReportFilters).length === 0) { alert("Gere um relatório financeiro primeiro."); return; }
            baixarArquivo('/baixar_pdf_relatorio_financeiro', currentReportFilters, 'relatorio_financeiro.pdf');
        });
        
// --- LÓGICA PARA EXTRATO BANCÁRIO ---
        let currentExtratoFilters = {};
        
        $('#btnGerarExtrato').click(function() {
            currentExtratoFilters = {
                id_conta_corrente_extrato: $('#extratoContaCorrente').val(),
                data_inicial_extrato: $('#extratoDataInicial').val(),
                data_final_extrato: $('#extratoDataFinal').val(),
            };

            if (!currentExtratoFilters.id_conta_corrente_extrato || !currentExtratoFilters.data_inicial_extrato || !currentExtratoFilters.data_final_extrato) {
                alert("Por favor, selecione Conta Corrente, Data Inicial e Data Final para o extrato."); return;
            }
            if (new Date(currentExtratoFilters.data_inicial_extrato) > new Date(currentExtratoFilters.data_final_extrato)) {
                alert("A Data Inicial do extrato não pode ser maior que a Data Final."); return;
            }

            // Limpa a tela antes de buscar
            $('#extratoStatus').text('Gerando extrato...').show();
            $('#tabelaExtrato thead, #tabelaExtrato tbody').empty();
            $('#saldoInicialExtrato, #saldoFinalExtrato, #infoContaExtrato').hide().empty();
            $('#btnBaixarCsvExtrato, #btnBaixarPdfExtrato').hide();

            $.ajax({
                url: '/gerar_extrato_bancario', 
                type: 'POST', 
                contentType: 'application/json',
                data: JSON.stringify(currentExtratoFilters),
                success: function(data) {
                    $('#extratoStatus').hide();
                    if (data.error) { alert(`Erro ao gerar extrato: ${data.error}`); return; }
                    
                    // Preenche Info da Conta
                    const contaInfo = data.conta_info || {};
                    $('#extratoNomeConta').text(contaInfo.display_name || 'N/A');
                    $('#extratoPeriodo').text(contaInfo.periodo || 'N/A');
                    $('#infoContaExtrato').show();

                    // Saldo Inicial
                    $('#saldoInicialExtrato').html(`<strong>Saldo Inicial:</strong> R$ ${parseFloat(data.saldo_inicial || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).show();
                    
                    if (data.movimentacoes && data.movimentacoes.length === 0) {
                        $('#extratoStatus').text('Nenhuma movimentação encontrada para os filtros selecionados.').show();
                    } else if (data.movimentacoes) {
                        
                        // 1. Cabeçalho com a coluna "Ações"
                        const headers = ["Data", "Histórico", "Entrada (R$)", "Saída (R$)", "Saldo (R$)", "Ações"];
                        let headerHtml = '<tr>'; 
                        headers.forEach(h => headerHtml += `<th class="text-center">${h}</th>`); 
                        headerHtml += '</tr>';
                        $('#tabelaExtrato thead').html(headerHtml);
                        
                        let tbodyHtml = '';
                        data.movimentacoes.forEach(mov => {
                            // Proteção de strings para evitar erro no javascript ao clicar
                            const descSegura = (mov.descricao_simples || mov.historico).replace(/'/g, "\\'");

                            tbodyHtml += `<tr>
                                <td class="text-center">${mov.data}</td>
                                <td style="white-space: normal;">${mov.historico}</td>
                                <td class="text-end text-success">${parseFloat(mov.entrada || 0) > 0 ? parseFloat(mov.entrada).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}</td>
                                <td class="text-end text-danger">${parseFloat(mov.saida || 0) > 0 ? parseFloat(mov.saida).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}</td>
                                <td class="text-end fw-bold">${parseFloat(mov.saldo_parcial || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                
                                <td class="text-center">
                                    <button class="btn btn-sm btn-info me-1 text-white" onclick="visualizarMovimentacao(${mov.id})" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirMovimentacao(${mov.id}, '${descSegura}')" title="Excluir/Estornar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>`;
                        });
                        
                        $('#tabelaExtrato tbody').html(tbodyHtml);
                        $('#btnBaixarCsvExtrato, #btnBaixarPdfExtrato').show();
                    }
                    
                    // Saldo Final
                    $('#saldoFinalExtrato').html(`<strong>Saldo Final:</strong> R$ ${parseFloat(data.saldo_final || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).show();
                },
                error: function(xhr) { 
                    $('#extratoStatus').hide(); 
                    let msg = "Erro desconhecido";
                    if(xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
                    else if(xhr.responseText) msg = xhr.responseText;
                    alert(`Erro ao gerar extrato: ${msg}`); 
                }
            });
        });

        // Botões de Download
        $('#btnBaixarCsvExtrato').click(function() {
            if (Object.keys(currentExtratoFilters).length === 0 || !currentExtratoFilters.id_conta_corrente_extrato) { alert("Gere um extrato primeiro."); return; }
            baixarArquivo('/baixar_csv_extrato', currentExtratoFilters, 'extrato_bancario.csv');
        });
        
        $('#btnBaixarPdfExtrato').click(function() {
            if (Object.keys(currentExtratoFilters).length === 0 || !currentExtratoFilters.id_conta_corrente_extrato) { alert("Gere um extrato primeiro."); return; }
            baixarArquivo('/baixar_pdf_extrato', currentExtratoFilters, 'extrato_bancario.pdf');
        });

        // --- TRAVA DE SEGURANÇA (PERMISSÕES DE USUÁRIO) ---
        if (typeof usuarioLogadoUvr !== 'undefined' && usuarioLogadoUvr && typeof usuarioIsAdmin !== 'undefined' && !usuarioIsAdmin) {
            const uvrSelects = $('select[name="uvr"], select[name="uvr_conta"], select[name="uvr_transacao"], #extratoUvr, #relUvr, #uvrSelectAssociado, #uvrFluxoCaixa');
            uvrSelects.each(function() {
                const select = $(this);
                select.val(usuarioLogadoUvr);
                select.trigger('change'); 
                select.prop('disabled', true); 
                if (select.attr('name')) {
                    const hiddenName = select.attr('name');
                    $(`input[type="hidden"][name="${hiddenName}"]`).remove();
                    $('<input>').attr({ type: 'hidden', name: hiddenName, value: usuarioLogadoUvr }).insertAfter(select);
                }
            });
        }
    }); // Fim do $(document).ready

    // --- FUNÇÕES GLOBAIS (FORA DO READY) PARA FUNCIONAR NO ONCLICK ---
    
    // --- LÓGICA DE APROVAÇÕES (ADMIN) ---
    $(document).on('click', '#btnAprovacoes', function() {
        // CORREÇÃO: Fazemos a troca de tela manualmente, sem depender da função 'mostrarFormulario'
        $('.form-container').hide();
        $('#aprovacoesContainer').show();
        
        carregarAprovacoes();
    });

    function carregarAprovacoes() {
        const tbody = $('#tabelaAprovacoesBody');
        tbody.html('<tr><td colspan="5" class="text-center">Carregando...</td></tr>');
        $('#msgSemAprovacoes').hide();

        $.getJSON('/get_solicitacoes_pendentes', function(data) {
            tbody.empty();
            if (data.length === 0) {
                $('#msgSemAprovacoes').show();
                return;
            }

            data.forEach(item => {
                tbody.append(`
                    <tr>
                        <td>${item.data}</td>
                        <td>${item.solicitante}</td>
                        <td>${item.nome_atual}</td>
                        <td class="text-primary fw-bold">${item.nome_novo}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info text-white me-1" onclick="verDetalhesSolicitacao(${item.id})" title="Ver o que mudou">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </td>
                    </tr>
                `);
            });
        }).fail(function() {
            tbody.html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar solicitações.</td></tr>');
        });
    }

    function verDetalhesSolicitacao(id) {
        $('#tabelaComparacaoBody').html('<tr><td colspan="3" class="text-center">Carregando comparação...</td></tr>');
        $('#areaComparacaoFoto').hide();
        
        $('#btnAprovarModal').attr('onclick', `responderSolicitacao(${id}, 'aprovar')`);
        $('#btnRejeitarModal').attr('onclick', `responderSolicitacao(${id}, 'rejeitar')`);

        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesAprovacao'));
        modal.show();

        $.getJSON(`/get_detalhes_solicitacao/${id}`, function(data) {
            $('#detalheSolicitante').text(data.usuario);
            // Debug para ver se a data está chegando
console.log("Data recebida do servidor:", data.data); 

// Preenche o campo (ou coloca um traço se estiver vazio)
$('#detalheData').text(data.data || data.data_documento || "--/--/----");
            
            const tbody = $('#tabelaComparacaoBody');
            tbody.empty();

            data.comparacao.forEach(row => {
                const rowClass = row.mudou ? 'table-warning' : '';
                const iconChange = row.mudou ? '<i class="fas fa-exclamation-triangle text-warning"></i> ' : '';
                
                let valAntigo = row.valor_atual || '<span class="text-muted small">vazio</span>';
                let valNovo = row.valor_novo || '<span class="text-muted small">vazio</span>';

                if (row.mudou) valNovo = `<strong>${valNovo}</strong>`;

                tbody.append(`
                    <tr class="${rowClass}">
                        <td>${iconChange}${row.campo}</td>
                        <td class="text-muted">${valAntigo}</td>
                        <td>${valNovo}</td>
                    </tr>
                `);
            });

            if (data.foto_nova_base64 && data.foto_nova_base64.length > 100) {
                $('#imgFotoNovaProposta').attr('src', data.foto_nova_base64);
                $('#areaComparacaoFoto').show();
            }

        }).fail(function(xhr) {
            let msg = "Erro desconhecido ao buscar detalhes.";
            if(xhr.responseJSON && xhr.responseJSON.error) {
                msg = xhr.responseJSON.error;
            } else if (xhr.responseText) {
                msg = xhr.responseText;
            }
            alert("Erro do Sistema: " + msg);
            var modalEl = document.getElementById('modalDetalhesAprovacao');
            var modalInstance = bootstrap.Modal.getInstance(modalEl);
            if(modalInstance) modalInstance.hide();
        });
    }

    const modalDetalhesEl = document.getElementById('modalDetalhesAprovacao');
    if (modalDetalhesEl) {
        modalDetalhesEl.addEventListener('hide.bs.modal', () => {
            const activeElement = document.activeElement;
            if (activeElement && modalDetalhesEl.contains(activeElement)) {
                activeElement.blur();
            }
            document.body.setAttribute('tabindex', '-1');
            document.body.focus();
        });
    }

    function responderSolicitacao(id, acao) {
        if (!confirm(`Tem certeza que deseja ${acao.toUpperCase()} esta solicitação?`)) return;

        $.ajax({
            url: '/responder_solicitacao',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id: id, acao: acao }),
            success: function(response) {
                alert(response.message);
                const modalEl = document.getElementById('modalDetalhesAprovacao');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
                carregarAprovacoes(); 
            },
            error: function(xhr) {
                alert("Erro ao processar: " + (xhr.responseJSON?.error || "Erro desconhecido"));
            }
        });
    }

    // --- LÓGICA DE GESTÃO DE CLIENTES/FORNECEDORES ---
    function buscarCadastros() {
        const termo = $('#inputBuscaCadastro').val();
        const tipo = $('#filtroTipoCadastro').val();
        const uvr = $('#filtroUvrCadastro').val() || "";
        const tbody = $('#tabelaCadastrosBody');
        tbody.html('<tr><td colspan="6" class="text-center">Buscando...</td></tr>');
        
        const params = new URLSearchParams({ q: termo, tipo: tipo, uvr: uvr });
        
        $.getJSON(`/buscar_cadastros?${params.toString()}`, function(data) {
            tbody.empty();
            if(data.length === 0) { tbody.html('<tr><td colspan="6" class="text-center">Nenhum registro encontrado.</td></tr>'); return; }
            
            data.forEach(c => {
                tbody.append(`
                    <tr>
                        <td>${c.razao}</td><td>${c.cnpj}</td><td>${c.tipo}</td><td>${c.cidade}</td><td>${c.uvr}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info text-white" onclick="visualizarCadastro(${c.id})"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-success" onclick="imprimirFichaCadastro(${c.id})"><i class="fas fa-print"></i></button>
                            <button class="btn btn-sm btn-warning text-white" onclick="iniciarEdicaoCadastro(${c.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="solicitarExclusaoCadastro(${c.id}, '${c.razao}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }).fail(() => tbody.html('<tr><td colspan="6" class="text-center text-danger">Erro ao buscar.</td></tr>'));
    }
    // --- LÓGICA DE GESTÃO DE CONTAS CORRENTES ---
    function buscarContasCorrentes() {
        const termo = $('#inputBuscaConta').val();
        const uvr = $('#filtroUvrConta').val() || "";
        const tbody = $('#tabelaContasBody');
        tbody.html('<tr><td colspan="5" class="text-center">Buscando...</td></tr>');

        const params = new URLSearchParams({ q: termo, uvr: uvr });

        $.getJSON(`/buscar_contas_correntes_gestao?${params.toString()}`, function(data) {
            tbody.empty();
            if (data.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center">Nenhuma conta encontrada.</td></tr>');
                return;
            }

            data.forEach(c => {
                tbody.append(`
                    <tr>
                        <td>${c.banco}</td>
                        <td>Ag: ${c.agencia} | CC: ${c.conta}</td>
                        <td>${c.descricao || '-'}</td>
                        <td>${c.uvr}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning text-white" onclick="iniciarEdicaoConta(${c.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="excluirConta(${c.id}, '${c.descricao || c.banco}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }).fail(() => tbody.html('<tr><td colspan="5" class="text-center text-danger">Erro ao buscar contas.</td></tr>'));
    }

    function iniciarEdicaoConta(id) {
        $.getJSON(`/get_conta_corrente_detalhe/${id}`, function(data) {
            if(data.error) { alert(data.error); return; }

            $('.form-container').hide(); 
            $('#contaCorrenteForm').show();

            $('#cadastroContaCorrenteForm').attr('action', '/editar_conta_corrente');
            $('#idContaHidden').val(data.id);
            
            // --- AJUSTE DE SEGURANÇA NO BOTÃO ---
            const textoBotao = usuarioIsAdmin ? 'SALVAR ALTERAÇÕES' : 'SOLICITAR ALTERAÇÃO';
            $('#btnSalvarConta').text(textoBotao).removeClass('btn-primary').addClass('btn-warning');
            // -------------------------------------
            
            $('#btnCancelarEdicaoConta').show();

            $('#uvrSelectConta').val(data.uvr).trigger('change');
            $('#agenciaContaInput').val(data.agencia);
            $('#contaCorrenteContaInput').val(data.conta_corrente);
            $('#descricaoApelidoContaInput').val(data.descricao_conta);

            const valorBancoCombinado = `${data.banco_codigo}|${data.banco_nome}`;
            
            popularBancos();
            $('#bancoContaSelect').val(valorBancoCombinado);

            $('html, body').animate({ scrollTop: $("#contaCorrenteForm").offset().top - 100 }, 500);
        });
    }

    function cancelarEdicaoConta() {
        $('#cadastroContaCorrenteForm')[0].reset();
        $('#cadastroContaCorrenteForm').attr('action', '/cadastrar_conta_corrente');
        $('#idContaHidden').val('');
        $('#btnSalvarConta').text('CADASTRAR CONTA').removeClass('btn-warning').addClass('btn-primary');
        $('#btnCancelarEdicaoConta').hide();
        
        $('.form-container').hide(); 
        $('#gestaoContasContainer').show();
    }

    function excluirConta(id, nome) {
        if (confirm(`ATENÇÃO: Tem certeza que deseja excluir a conta "${nome}"?\n\nIsso só será possível se não houver lançamentos financeiros vinculados a ela.`)) {
            $.ajax({
                url: `/excluir_conta_corrente/${id}`,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'sucesso') {
                        alert(response.message);
                        buscarContasCorrentes();
                    } else {
                        alert("Erro: " + response.error);
                    }
                },
                error: function(xhr) {
                    let msg = "Erro ao excluir.";
                    if (xhr.responseJSON && xhr.responseJSON.error) msg += "\n" + xhr.responseJSON.error;
                    alert(msg);
                }
            });
        }
    }

// --- LÓGICA DE GESTÃO DE TRANSAÇÕES (ATUALIZADA) ---
function buscarTransacoesGestao() {
    const dataIni = $('#filtroDataIniTransacao').val();
    const dataFim = $('#filtroDataFimTransacao').val();
    const tipo = $('#filtroTipoTransacao').val();
    const uvr = $('#filtroUvrTransacao').val(); // Filtro de UVR
    const idPatrimonio = $('#filtroFrotaTransacao').val();
    // Se tiver um campo de busca por texto no HTML, descomente abaixo:
    // const q = $('#inputBuscaTransacao').val(); 

    const tbody = $('#tabelaTransacoesBody');
    tbody.html('<tr><td colspan="8" class="text-center">Buscando...</td></tr>');

    const params = new URLSearchParams({
        data_inicial: dataIni,
        data_final: dataFim,
        tipo: tipo,
        uvr: uvr,
        id_patrimonio: idPatrimonio
        // q: q 
    });

    $.getJSON(`/buscar_transacoes_gestao?${params.toString()}`, function(data) {
        tbody.empty();
        
        if (data.length === 0) {
            tbody.html('<tr><td colspan="8" class="text-center">Nenhuma transação encontrada.</td></tr>');
            return;
        }

        data.forEach(t => {
            // 1. Definição de Cores e Badges
            let badgeClass = 'bg-warning text-dark'; // Padrão Aberto
            let statusTexto = t.status_pagamento || 'Aberto';

            if (statusTexto === 'Pago' || statusTexto === 'Recebido') {
                badgeClass = 'bg-success';
            } else if (statusTexto === 'Cancelado') {
                badgeClass = 'bg-secondary';
            }

            const corValor = t.tipo_transacao === 'Receita' ? 'text-success' : 'text-danger';
            
            // 2. Formatação de Valores
            const valorFormatado = parseFloat(t.valor_total_documento).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            // 3. Tratamento de Strings para evitar erros no JS (aspas)
            const origemNome = t.nome_cadastro_origem || '-';
            const numDoc = t.numero_documento || '-';
            const origemSegura = origemNome.replace(/'/g, "\\'");
            const docSeguro = numDoc.replace(/'/g, "\\'");

            // 4. Construção da Linha HTML
            tbody.append(`
                <tr>
                    <td>${t.data_documento}</td>
                    <td><span class="badge bg-light text-dark border">${t.uvr}</span></td>
                    <td class="${t.tipo_transacao === 'Receita' ? 'text-primary' : 'text-danger'} fw-bold">${t.tipo_transacao}</td>
                    <td>
                        ${origemNome}
                    </td>
                    <td>${numDoc}</td>
                    <td class="text-end fw-bold ${corValor}">${valorFormatado}</td>
                    <td class="text-center"><span class="badge ${badgeClass}">${statusTexto}</span></td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info text-white" onclick="verDetalhesTransacao(${t.id})" title="Ver Itens">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirTransacao(${t.id}, '${docSeguro} - ${origemSegura}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        });
    }).fail(function() {
        tbody.html('<tr><td colspan="8" class="text-center text-danger">Erro ao buscar dados no servidor.</td></tr>');
    });
}

function getFiltrosTransacoesGestao() {
    const idPatrimonio = $('#filtroFrotaTransacao').val();
    let nomeFrota = '';
    if (idPatrimonio) {
        nomeFrota = $('#filtroFrotaTransacao option:selected').text().trim();
    }
    return {
        data_inicial: $('#filtroDataIniTransacao').val(),
        data_final: $('#filtroDataFimTransacao').val(),
        tipo: $('#filtroTipoTransacao').val(),
        uvr: $('#filtroUvrTransacao').val(),
        id_patrimonio: idPatrimonio,
        nome_frota: nomeFrota
    };
}

function carregarFrotasFiltroTransacao() {
    const select = $('#filtroFrotaTransacao');
    const uvr = $('#filtroUvrTransacao').val();

    select.empty().append('<option value="">Carregando...</option>');
    $.getJSON('/buscar_patrimonio', { uvr: uvr, categoria: 'Frota' }, function(data) {
        select.empty().append('<option value="">Todas</option>');
        if (Array.isArray(data) && data.length > 0) {
            data.forEach(item => {
                const identificacao = item.placa ? ` (${item.placa})` : '';
                select.append(`<option value="${item.id}">${item.descricao}${identificacao}</option>`);
            });
        } else {
            select.append('<option value="">Nenhuma frota encontrada</option>');
        }
    }).fail(function() {
        select.empty().append('<option value="">Erro ao carregar frota</option>');
    });
}

function atualizarFiltroFrotaTransacao() {
    const tipo = $('#filtroTipoTransacao').val();
    const container = $('#filtroFrotaTransacaoContainer');
    const select = $('#filtroFrotaTransacao');

    if (tipo !== 'Despesa') {
        select.val('').prop('disabled', true);
        container.hide();
        return;
    }

    container.show();
    select.prop('disabled', false);
    carregarFrotasFiltroTransacao();
}

$('#filtroTipoTransacao').on('change', atualizarFiltroFrotaTransacao);
$('#filtroUvrTransacao').on('change', function() {
    if ($('#filtroTipoTransacao').val() === 'Despesa') {
        carregarFrotasFiltroTransacao();
    }
});

$(document).ready(function() {
    atualizarFiltroFrotaTransacao();
});

if (typeof window.baixarArquivo !== 'function') {
    window.baixarArquivo = function(url, filters, defaultFilename) {
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filters)
        })
        .then(async resp => {
            if (resp.ok) {
                const blob = await resp.blob();
                let filename = defaultFilename;
                const disposition = resp.headers.get('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) { filename = matches[1].replace(/['"]/g, '');}
                }
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(link.href);
            } else {
                const errorData = await resp.json().catch(() => null);
                let errorMsg = "Erro ao baixar arquivo";
                if (errorData && errorData.message) { errorMsg += `: ${errorData.message}`; }
                else if (errorData && errorData.error) { errorMsg += `: ${errorData.error}`; }
                else { errorMsg += `: ${resp.statusText}`; }
                alert(errorMsg);
            }
        })
        .catch(err => {
            console.error("Falha na requisição de download:", err);
            alert("Erro ao baixar arquivo. Verifique o console.");
        });
    };
}

$('#btnBaixarCsvTransacoes').on('click', function() {
    const filtros = getFiltrosTransacoesGestao();
    window.baixarArquivo('/baixar_csv_transacoes', filtros, 'transacoes.csv');
});

$('#btnBaixarPdfTransacoes').on('click', function() {
    const filtros = getFiltrosTransacoesGestao();
    window.baixarArquivo('/baixar_pdf_transacoes', filtros, 'transacoes.pdf');
});

// --- LÓGICA DE GESTÃO DE PRODUTOS E SUBGRUPOS (CASCATA COMPLETA) ---

    // 1. Definição do Mapa de Grupos (Separação Receita vs Despesa - Baseado no CSV)
    const MAPA_GRUPOS = {
        "Receita": [
            "Comercialização de Materiais Recicláveis",
            "Outras Receitas",
            "Prestação de Serviços e Parcerias",
            "Gestão Associativa"
            

        ],
        "Despesa": [
            "Operação e Produção",
            "Gestão Administrativa e Financeira",
            "Despesas de manutenção",
            "Rateio dos Associados"
      
          
        ]
    };

    // Cria uma lista única ordenada para usar nos Modais de Cadastro (onde não tem filtro de Tipo)
    var TODOS_GRUPOS_UNIFICADOS = [...MAPA_GRUPOS["Receita"], ...MAPA_GRUPOS["Despesa"]].sort();

    // 2. Inicialização e Eventos dos Filtros
    $(document).ready(function() {
        // Inicializa o filtro de Grupo com tudo
        const filtroGrupo = $('#filtroGrupoGestao');
        filtroGrupo.empty().append('<option value="">Todos os Grupos</option>');
        TODOS_GRUPOS_UNIFICADOS.forEach(g => filtroGrupo.append(`<option value="${g}">${g}</option>`));

// --- EVENTO 1: Mudou o TIPO (Receita/Despesa) ---
        $('#filtroTipoGestao').change(function() {
            const tipo = $(this).val();
            const selectGrupo = $('#filtroGrupoGestao');
            const selectSub = $('#filtroSubgrupoGestao');

            // Limpa Grupos e Subgrupos
            selectGrupo.empty().append('<option value="">Todos os Grupos</option>');
            selectSub.empty().append('<option value="">Selecione o Grupo...</option>').prop('disabled', true);

            let listaParaExibir = [];
            
            if (tipo === "Receita") listaParaExibir = MAPA_GRUPOS_SISTEMA["Receita"];
            else if (tipo === "Despesa") listaParaExibir = MAPA_GRUPOS_SISTEMA["Despesa"];
            else listaParaExibir = TODOS_GRUPOS_UNIFICADOS; // Se "Todos", mostra tudo

            // Preenche o select de Grupos
            listaParaExibir.sort().forEach(g => selectGrupo.append(`<option value="${g}">${g}</option>`));
            
            // Recarrega a tabela
            carregarTabelaProdutos();
        });

        $('#filtroGrupoGestao').change(function() {
            const grupo = $(this).val();
            const selectSub = $('#filtroSubgrupoGestao');
            
            // Trava o select com a mensagem de carregamento
            selectSub.empty().append('<option value="">Carregando...</option>').prop('disabled', true);

            if (!grupo) {
                selectSub.empty().append('<option value="">Selecione o Grupo...</option>');
                carregarTabelaProdutos(); // Recarrega tabela sem filtro de subgrupo
                return;
            }

            // CORREÇÃO: Usamos /api/subgrupos para pegar ID e NOME
            $.getJSON(`/api/subgrupos?atividade=${encodeURIComponent(grupo)}`, function(data) {
                selectSub.empty().append('<option value="">Todos os Subgrupos</option>');
                
                if (data && data.length > 0) {
                    data.forEach(sub => {
                        // AQUI ESTÁ O TRUQUE: Usamos sub.id no value, e sub.nome no texto
                        selectSub.append(`<option value="${sub.id}">${sub.nome}</option>`);
                    });
                    selectSub.prop('disabled', false);
                } else {
                    selectSub.append('<option value="">(Sem subgrupos cadastrados)</option>');
                    selectSub.prop('disabled', true);
                }
                
                carregarTabelaProdutos(); // Atualiza a tabela de produtos
            }).fail(function() {
                selectSub.empty().append('<option value="">Erro ao carregar</option>');
                console.error("Falha ao carregar subgrupos para o grupo:", grupo);
            });
        });

        // --- EVENTO 3: Mudou o SUBGRUPO ---
        $('#filtroSubgrupoGestao').change(function() {
            carregarTabelaProdutos();
        });
    }); // FIM DO DOCUMENT READY

    // 3. Função Principal: Carregar a Tabela
    function carregarTabelaProdutos(grupoForcado = null) {
        const tbody = $('#tabelaProdutosBody');
        tbody.html('<tr><td colspan="5" class="text-center">Carregando...</td></tr>');

        // Pega valores dos selects
        let grupo = grupoForcado !== null ? grupoForcado : $('#filtroGrupoGestao').val();
        let tipo = $('#filtroTipoGestao').val();
        let idSubgrupo = $('#filtroSubgrupoGestao').val();

        let url = '/api/produtos_crud?';
        if (grupo) url += `&grupo=${encodeURIComponent(grupo)}`;
        if (tipo) url += `&tipo=${encodeURIComponent(tipo)}`;
        if (idSubgrupo) url += `&id_subgrupo=${encodeURIComponent(idSubgrupo)}`;

        $.getJSON(url, function(data) {
            tbody.empty();
            if (data.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center text-muted">Nenhum produto encontrado com esses filtros.</td></tr>');
                return;
            }
            data.forEach(p => {
                // Badge colorido para o Tipo
                let badge = p.tipo === 'Receita' 
                    ? '<span class="badge bg-success">Receita</span>' 
                    : (p.tipo === 'Despesa' ? '<span class="badge bg-danger">Despesa</span>' : '<span class="badge bg-secondary">-</span>');

                tbody.append(`
                    <tr>
                        <td class="fw-bold">${p.item}</td>
                        <td class="text-center">${badge}</td>
                        <td>${p.subgrupo_nome || '-'}</td>
                        <td><small>${p.grupo}</small></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning text-white" onclick="editarProduto(${p.id}, '${p.item}', ${p.id_subgrupo}, '${p.grupo}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="excluirProduto(${p.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }).fail(() => tbody.html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados.</td></tr>'));
    }

    // --- FUNÇÕES AUXILIARES E MODAIS ---

    function preencherSelectGrupos(selectId) {
        const sel = $('#' + selectId);
        sel.empty().append('<option value="">Selecione...</option>');
        // Usa a lista unificada para os Modais de Cadastro
        TODOS_GRUPOS_UNIFICADOS.forEach(g => {
            sel.append(`<option value="${g}">${g}</option>`);
        });
    }

    // --- GESTÃO DE SUBGRUPOS (MODAL) ---
    function abrirModalSubgrupos() {
        preencherSelectGrupos('selectGrupoPaiSubgrupo');
        limparFormSubgrupo();
        $('#listaSubgruposExistentes').html('<li class="list-group-item text-muted">Selecione um grupo acima.</li>');
        new bootstrap.Modal(document.getElementById('modalSubgrupos')).show();
    }

    function listarSubgruposNoModal() {
        const atividade = $('#selectGrupoPaiSubgrupo').val();
        const lista = $('#listaSubgruposExistentes');
        if(!atividade) { lista.html(''); return; }
        
        lista.html('<li class="list-group-item">Carregando...</li>');
        
        $.getJSON(`/api/subgrupos?atividade=${encodeURIComponent(atividade)}`, function(data) {
            lista.empty();
            if(data.length === 0) lista.html('<li class="list-group-item text-muted">Nenhum subgrupo cadastrado.</li>');
            
            data.forEach(sub => {
                lista.append(`
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${sub.nome}
                        <div>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="prepararEdicaoSubgrupo(${sub.id}, '${sub.nome}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirSubgrupo(${sub.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>
                `);
            });
        });
    }

    function salvarSubgrupo() {
        const nome = $('#inputNomeSubgrupo').val();
        const atividade = $('#selectGrupoPaiSubgrupo').val();
        const id = $('#idSubgrupoEdicao').val();
        
        if(!nome || !atividade) { alert("Selecione o grupo e digite um nome."); return; }

        const payload = {
            acao: id ? 'editar' : 'novo',
            id: id,
            nome: nome,
            atividade_pai: atividade
        };

        $.ajax({
            url: '/api/subgrupos', type: 'POST', contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(res) {
                limparFormSubgrupo();
                listarSubgruposNoModal();
            },
            error: function(xhr) { alert("Erro: " + (xhr.responseJSON?.erro || "Erro desconhecido")); }
        });
    }

    function prepararEdicaoSubgrupo(id, nome) {
        $('#idSubgrupoEdicao').val(id);
        $('#inputNomeSubgrupo').val(nome).focus();
        $('#btnCancelarEdicaoSub').show();
    }

    function limparFormSubgrupo() {
        $('#idSubgrupoEdicao').val('');
        $('#inputNomeSubgrupo').val('');
        $('#btnCancelarEdicaoSub').hide();
    }

    function excluirSubgrupo(id) {
        if(!confirm("Tem certeza? Isso apagará o subgrupo.")) return;
        $.ajax({
            url: '/api/subgrupos', type: 'POST', contentType: 'application/json',
            data: JSON.stringify({ acao: 'excluir', id: id }),
            success: function() { listarSubgruposNoModal(); },
            error: function(xhr) { alert(xhr.responseJSON?.erro || "Erro ao excluir. Verifique se não há produtos vinculados."); }
        });
    }

    // --- GESTÃO DE PRODUTOS (MODAL) ---
    function abrirModalProduto() {
        $('#idProdutoEdicao').val('');
        $('#tituloModalProduto').text('Novo Produto');
        preencherSelectGrupos('selectGrupoProduto');
        $('#selectSubgrupoProduto').empty().append('<option value="">Selecione Grupo Primeiro</option>');
        $('#inputNomeProduto').val('');
        new bootstrap.Modal(document.getElementById('modalProdutoEdicao')).show();
    }

    function carregarSubgruposParaProduto(subgrupoSelecionadoId = null) {
        const grupo = $('#selectGrupoProduto').val();
        const selectSub = $('#selectSubgrupoProduto');
        
        if(!grupo) { 
            selectSub.empty().append('<option value="">Selecione Grupo Primeiro</option>'); 
            return; 
        }

        $.getJSON(`/api/subgrupos?atividade=${encodeURIComponent(grupo)}`, function(data) {
            selectSub.empty().append('<option value="">(Sem Subgrupo)</option>');
            data.forEach(sub => {
                // --- CORREÇÃO AQUI ---
                // Usa 'nome' (novo padrão) OU 'nome_subgrupo' (caso venha legado)
                selectSub.append(`<option value="${sub.id}">${sub.nome || sub.nome_subgrupo}</option>`);
            });
            if(subgrupoSelecionadoId) selectSub.val(subgrupoSelecionadoId);
        });
    }

    function salvarProduto() {
        const grupo = $('#selectGrupoProduto').val();
        const nome = $('#inputNomeProduto').val();
        
        if(!grupo || !nome) { alert("Grupo e Nome do produto são obrigatórios."); return; }

        const payload = {
            id: $('#idProdutoEdicao').val(),
            grupo: grupo,
            id_subgrupo: $('#selectSubgrupoProduto').val() || null,
            item: nome
        };

        $.ajax({
            url: '/api/produtos_crud', type: 'POST', contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function() {
                bootstrap.Modal.getInstance(document.getElementById('modalProdutoEdicao')).hide();
                carregarTabelaProdutos(grupo); // Recarrega tabela filtrada pelo grupo salvo
                $('#filtroGrupoGestao').val(grupo); // Atualiza filtro da tela
            },
            error: function(xhr) { alert("Erro: " + (xhr.responseJSON?.erro || "Erro desconhecido")); }
        });
    }

    function editarProduto(id, item, idSubgrupo, grupo) {
        $('#idProdutoEdicao').val(id);
        $('#tituloModalProduto').text('Editar Produto');
        $('#inputNomeProduto').val(item);
        
        preencherSelectGrupos('selectGrupoProduto');
        $('#selectGrupoProduto').val(grupo);
        
        // Carrega subgrupos e seleciona o correto
        carregarSubgruposParaProduto(idSubgrupo);
        
        new bootstrap.Modal(document.getElementById('modalProdutoEdicao')).show();
    }

    function excluirProduto(id) {
        if(!confirm("Excluir este produto?")) return;
        $.ajax({
            url: `/api/produtos_crud?id=${id}`, type: 'DELETE',
            success: function() { 
                carregarTabelaProdutos($('#filtroGrupoGestao').val()); 
            },
            error: function(xhr) { alert(xhr.responseJSON?.erro || "Erro ao excluir."); }
        });
    }

// ==========================================
    // FUNÇÕES DE FOTO (ARQUIVO E WEBCAM) - VERSÃO OTIMIZADA E UNIFICADA
    // ==========================================

    let webcamTarget = ''; // Variável para saber o destino ('associado' ou 'patrimonio')
    let streamWebcam = null;

    // Função Genérica de Redimensionamento (Para evitar repetição de código)
    function processarImagem(file, callback) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                // Configuração de redimensionamento
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 800;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                } else {
                    if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                }

                var canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Retorna Base64 Otimizado (JPG 80%)
                callback(canvas.toDataURL('image/jpeg', 0.8));
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    // 1. Preview Arquivo - ASSOCIADO
    function previewImagemArquivo(input) {
        if (input.files && input.files[0]) {
            processarImagem(input.files[0], function(dataURL) {
                $('#previewFotoAssociado').attr('src', dataURL).show();
                $('#textoSemFoto').hide();
                $('#fotoWebcamBase64').val(dataURL); // Salva versão leve no hidden
                $('#fotoExistenteBase64').val('');   // Limpa flag de foto antiga
                input.value = ''; // Limpa input físico para evitar envio pesado
            });
        }
    }

    // 2. Preview Arquivo - PATRIMÔNIO (Novo)
    function previewImagemPatrimonio(input) {
        if (input.files && input.files[0]) {
            processarImagem(input.files[0], function(dataURL) {
                $('#previewFotoPatrimonio').attr('src', dataURL).show();
                $('#textoSemFotoPatrimonio').hide();
                $('#fotoPatrimonioWebcamBase64').val(dataURL); // Salva versão leve no hidden
                input.value = ''; // Limpa input físico
            });
        }
    }

    // 3. Abrir Webcam (Com Alvo)
    function abrirModalWebcam(target) {
        webcamTarget = target || 'associado'; // Padrão é associado
        const video = document.getElementById('videoWebcam');
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false }) // Tenta câmera traseira no celular
            .catch(() => navigator.mediaDevices.getUserMedia({ video: true, audio: false })) // Fallback para qualquer câmera
            .then(function(stream) {
                streamWebcam = stream;
                video.srcObject = stream;
                video.play();
                new bootstrap.Modal(document.getElementById('modalWebcam')).show();
            })
            .catch(function(err) {
                console.error("Erro câmera: ", err);
                alert("Não foi possível acessar a câmera. Verifique as permissões ou se está usando HTTPS.");
            });
    }

    // 4. Tirar Foto da Webcam (Redimensionada)
    function tirarFotoWebcam() {
        const video = document.getElementById('videoWebcam');
        const canvas = document.getElementById('canvasWebcam');
        const context = canvas.getContext('2d');

        // Lógica de redimensionamento para webcam
        const MAX_WIDTH = 800;
        const MAX_HEIGHT = 800;
        let width = video.videoWidth;
        let height = video.videoHeight;

        if (width > height) {
            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
        } else {
            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
        }

        canvas.width = width;
        canvas.height = height;
        context.drawImage(video, 0, 0, width, height);

        const dataURL = canvas.toDataURL('image/jpeg', 0.8);

        // Decide onde jogar a foto
        if (webcamTarget === 'patrimonio') {
            $('#previewFotoPatrimonio').attr('src', dataURL).show();
            $('#textoSemFotoPatrimonio').hide();
            $('#fotoPatrimonioWebcamBase64').val(dataURL);
            $('#inputFotoPatrimonioArquivo').val(''); // Limpa conflito de arquivo
        } else {
            // Associado
            $('#previewFotoAssociado').attr('src', dataURL).show();
            $('#textoSemFoto').hide();
            $('#fotoWebcamBase64').val(dataURL);
            $('#fotoExistenteBase64').val('');
            $('#inputFotoArquivo').val('');
        }

        // Fecha modal e para câmera
        var modalEl = document.getElementById('modalWebcam');
        var modal = bootstrap.Modal.getInstance(modalEl);
        if(modal) modal.hide();
        pararWebcam();
    }

    // 5. Parar Webcam
    function pararWebcam() {
        if (streamWebcam) {
            streamWebcam.getTracks().forEach(track => track.stop());
            streamWebcam = null;
        }
    }

    document.getElementById('modalWebcam').addEventListener('hidden.bs.modal', function () {
       pararWebcam();
    });

    // --- BUSCA AUTOMÁTICA DE CEP ---
    function configurarBuscaCep(seletorCep, prefixoId) {
        $(seletorCep).blur(function() {
            // 1. Limpa o CEP para envio
            var cep = $(this).val().replace(/\D/g, '');

            // 2. Define os IDs corretos baseado no formulário (CF ou Associado)
            var idLogradouro = (prefixoId === 'Associado') ? '#logAssociado' : '#logradouroCF';
            var idBairro = `#bairro${prefixoId}`;
            var idCidade = `#cidade${prefixoId}`;
            var idUf = `#uf${prefixoId}`;
            var idNumero = (prefixoId === 'Associado') ? '#endereco_numero' : '#numeroCF'; 
            
            // CORREÇÃO: No seu HTML o ID é numAssociado
            if (prefixoId === 'Associado') idNumero = '#numAssociado';

            // 3. Verifica se tem 8 dígitos
            if (cep.length === 8) {
                // Feedback visual ("...")
                $(idLogradouro).val('...');
                $(idBairro).val('...');
                $(idCidade).val('...');
                $(idUf).val('...');

                $.getJSON(`/buscar_cep/${cep}`, function(data) {
                    if (!("erro" in data)) {
                        $(idLogradouro).val(data.logradouro);
                        $(idBairro).val(data.bairro);
                        $(idCidade).val(data.cidade);
                        $(idUf).val(data.uf);
                        
                        // Foca no número
                        $(idNumero).focus();
                    } else {
                        alert("CEP não encontrado.");
                        // Limpa campos
                        $(idLogradouro).val(""); $(idBairro).val(""); 
                        $(idCidade).val(""); $(idUf).val("");
                    }
                }).fail(function() {
                    alert("Erro ao buscar CEP.");
                    $(idLogradouro).val(""); $(idBairro).val(""); 
                    $(idCidade).val(""); $(idUf).val("");
                });
            }
        });
    }

    // Ativa a função de CEP
    configurarBuscaCep('#cepCF', 'CF');
    configurarBuscaCep('#cepAssociado', 'Associado');

    // --- FUNÇÕES DE EDIÇÃO/EXCLUSÃO DE TRANSAÇÕES ---

    function normalizarNumero(valor) {
        if (valor === null || valor === undefined || valor === '') return null;
        if (typeof valor === 'number') return valor;
        if (typeof valor === 'string') {
            const normalizado = valor.replace(/\./g, '').replace(',', '.');
            const num = Number(normalizado);
            return Number.isNaN(num) ? null : num;
        }
        return null;
    }

    function formatarNumeroPtBr(valor, casas = 2, vazio = '') {
        const num = normalizarNumero(valor);
        if (num === null) return vazio;
        return num.toLocaleString('pt-BR', {minimumFractionDigits: casas, maximumFractionDigits: casas});
    }

    function renderizarItensTransacao(itens, valorTotalDocumento) {
        const container = $('#itensDocumentoContainer');
        container.empty();

        if (itens && itens.length > 0) {
            itens.forEach(item => {
                if (typeof window.adicionarItemLinha === "function") {
                    window.adicionarItemLinha(false);
                }

                const lastRow = $('#itensDocumentoContainer .item-row').last();

                const selGrupo = lastRow.find('.grupo-select');
                if (item.grupo) {
                    selGrupo.empty().append(`<option value="${item.grupo}" selected>${item.grupo}</option>`);
                } else {
                    selGrupo.empty().append(`<option value="" selected>Original</option>`);
                }

                const selSub = lastRow.find('.subgrupo-select');
                if (item.subgrupo) {
                    selSub.empty().append(`<option value="${item.subgrupo}" selected>${item.subgrupo}</option>`).prop('disabled', false);
                } else {
                    selSub.empty().append('<option value="" selected>(Nenhum)</option>').prop('disabled', false);
                }

                const selDesc = lastRow.find('.item-select');
                const descricao = item.descricao || '';
                selDesc.empty().append(`<option value="${descricao}" selected>${descricao || 'Sem descrição'}</option>`).prop('disabled', false);

                const unidadeSelect = lastRow.find('select[name="produto_servico_unidade[]"]');
                if (item.unidade && unidadeSelect.find(`option[value="${item.unidade}"]`).length === 0) {
                    unidadeSelect.append(`<option value="${item.unidade}">${item.unidade}</option>`);
                }
                unidadeSelect.val(item.unidade || '');

                const quantidade = normalizarNumero(item.quantidade);
                lastRow.find('input[name="produto_servico_quantidade[]"]').val(quantidade !== null ? quantidade : '');

                const valorFmt = formatarNumeroPtBr(item.valor_unitario);
                const totalFmt = formatarNumeroPtBr(item.valor_total);

                lastRow.find('input[name="produto_servico_valor_unitario[]"]').val(valorFmt);
                lastRow.find('input[name="produto_servico_valor_total_item[]"]').val(totalFmt);
            });
        } else {
            if (typeof window.adicionarItemLinha === "function") window.adicionarItemLinha(true);
        }

        if (valorTotalDocumento !== undefined && valorTotalDocumento !== null) {
            $('#valorTotalDocumentoCalculado').val(formatarNumeroPtBr(valorTotalDocumento));
        }
    }

    function iniciarEdicaoTransacao(id) {
        // 1. Busca os detalhes completos
        $.getJSON(`/get_transacao_detalhes/${id}`, function(data) {
            if(data.error) { alert(data.error); return; }

            // --- TRAVA DE SEGURANÇA (IMPORTANTE) ---
            // Impede edição se já houver pagamentos (status diferente de 'Aberto')
            if (data.status !== 'Aberto') {
                alert(`⚠️ AÇÃO BLOQUEADA

Esta transação está com status: ${data.status.toUpperCase()}.

Por segurança contábil, não é possível alterar uma nota que já possui movimentação financeira registrada.

SOLUÇÃO: Vá ao Fluxo de Caixa, exclua o(s) pagamento(s) referente(s) a esta nota para que ela volte ao status 'Aberto'. Em seguida, tente editar novamente.`);
                return; // Para tudo aqui.
            }

            // 2. Muda para a aba de Cadastro
            mostrarFormulario('receitaDespesaForm');
            
            // 3. Ajusta o formulário para modo "Edição"
            $('#transacaoForm').attr('action', '/editar_transacao');
            $('#idTransacaoHidden').val(data.id);
            $('#btnSalvarTransacao').text('SALVAR ALTERAÇÕES').removeClass('btn-success').addClass('btn-warning');
            $('#btnCancelarEdicaoTransacao').show();
            
            // 4. Preenche Cabeçalho (UVR e Tipo)
            $('#uvrSelectTransacao').val(data.uvr).trigger('change');
            $('#tipoTransacaoSelect').val(data.tipo).trigger('change');
            
            // Limpa os itens antes de começar qualquer coisa para evitar conflitos visual
            $('#itensDocumentoContainer').empty();

            // Delay para carregar dependentes (Atividade e Fornecedor)
            setTimeout(() => {
                // Define a atividade e dispara a mudança
                $('#tipoAtividadeTransacaoSelect').val(data.atividade).trigger('change');
                
                // Formata Data (yyyy-mm-dd)
                if(data.data && data.data.includes('/')) {
                    const partes = data.data.split('/');
                    $('#dataDocumentoTransacao').val(`${partes[2]}-${partes[1]}-${partes[0]}`);
                }
                
                $('input[name="numero_documento_transacao"]').val(data.doc === '-' ? '' : data.doc);

                // Seleciona Fornecedor/Cliente
                const origemRequest = window.ultimaCargaOrigemTransacao || $.Deferred().resolve().promise();
                origemRequest.always(() => {
                    var selectFornecedor = $('#fornecedorPrestadorTransacaoSelect');
                    let found = false;

                    if (data.id_origem) {
                        selectFornecedor.val(String(data.id_origem));
                        found = selectFornecedor.val() === String(data.id_origem);
                    }

                    if (!found) {
                        selectFornecedor.find('option').each(function() {
                            if ($(this).data('nome') === data.origem) {
                                $(this).prop('selected', true);
                                found = true;
                            }
                        });
                    }
                    
                    if(found) {
                        selectFornecedor.trigger('change');
                    } else if (data.origem) {
                        const valorOrigem = data.id_origem ? String(data.id_origem) : '';
                        selectFornecedor.append(`<option value="${valorOrigem}" data-nome="${data.origem}" selected>${data.origem}</option>`);
                        $('#nomeFornecedorPrestadorTransacaoInput').val(data.origem);
                        selectFornecedor.trigger('change');
                    }
                });

                if (data.id_patrimonio) {
                    $('#vincularPatrimonioTransacaoToggle').prop('checked', true);
                    atualizarVisibilidadePatrimonio();
                    const patrimonioSelect = $('#patrimonioTransacaoSelect');
                    const labelPatrimonio = formatarDescricaoPatrimonio({
                        descricao: data.patrimonio,
                        placa: data.patrimonio_placa,
                        codigo_patrimonio: data.patrimonio_codigo
                    });

                    if (patrimonioSelect.find(`option[value="${data.id_patrimonio}"]`).length === 0) {
                        const controle = data.patrimonio_controle || '';
                        const medidor = data.patrimonio_medidor != null ? data.patrimonio_medidor : '';
                        patrimonioSelect.append(`<option value="${data.id_patrimonio}" data-controle="${controle}" data-medidor="${medidor}">${labelPatrimonio}</option>`);
                    }
                    patrimonioSelect.val(data.id_patrimonio);
                    if (typeof atualizarCamposPatrimonioDespesa === 'function') {
                        atualizarCamposPatrimonioDespesa();
                    }
                } else {
                    $('#vincularPatrimonioTransacaoToggle').prop('checked', false);
                    atualizarVisibilidadePatrimonio();
                    $('#patrimonioTransacaoSelect').val('');
                }

                $('#categoriaDespesaPatrimonioSelect').val(data.categoria_despesa_patrimonio || '');
                $('#medidorAtualTransacaoInput').val(data.medidor_atual != null ? data.medidor_atual : '');
                $('#tipoMedidorTransacaoInput').val(data.tipo_medidor || '');
                if (data.id_motorista) {
                    const motoristaSelect = $('#motoristaTransacaoSelect');
                    const nomeMotorista = data.nome_motorista || 'Motorista';
                    if (motoristaSelect.find(`option[value="${data.id_motorista}"]`).length === 0) {
                        motoristaSelect.append(`<option value="${data.id_motorista}" data-nome="${nomeMotorista}">${nomeMotorista}</option>`);
                    }
                    motoristaSelect.val(data.id_motorista).trigger('change');
                } else {
                    $('#motoristaTransacaoSelect').val('');
                    $('#nomeMotoristaTransacaoInput').val('');
                }

                $('#litrosTransacaoInput').val(data.litros != null ? data.litros : '');
                $('#tipoCombustivelTransacaoSelect').val(data.tipo_combustivel || '');
                $('#tipoManutencaoTransacaoSelect').val(data.tipo_manutencao || '');
                $('#garantiaKmTransacaoInput').val(data.garantia_km || '');
                $('#garantiaDataTransacaoInput').val(data.garantia_data || '');
                $('#proximaRevisaoKmTransacaoInput').val(data.proxima_revisao_km || '');
                $('#proximaRevisaoDataTransacaoInput').val(data.proxima_revisao_data || '');
                if (typeof atualizarCamposCategoriaDespesa === 'function') {
                    atualizarCamposCategoriaDespesa();
                }

                // 5. Preenche Itens (MOVIDO PARA CÁ - Roda DEPOIS do cabeçalho)
                const itensFallback = (window.ultimaTransacaoDetalhe && window.ultimaTransacaoDetalhe.id === data.id)
                    ? window.ultimaTransacaoDetalhe.itens
                    : [];
                const itensParaCarregar = (data.itens && data.itens.length > 0) ? data.itens : itensFallback;
                renderizarItensTransacao(itensParaCarregar, data.valor_total);
                
                // Rola a tela
                $('html, body').animate({ scrollTop: $("#receitaDespesaForm").offset().top - 100 }, 500);

            }, 500); // Fim do setTimeout principal

        }).fail(function() { alert("Erro ao carregar dados para edição."); });
    }
    
    if (typeof window.formatarDescricaoPatrimonio !== 'function') {
        window.formatarDescricaoPatrimonio = function(item) {
            const descricao = item && item.descricao ? item.descricao : 'Sem descrição';
            const identificador = item && (item.placa || item.codigo_patrimonio) ? (item.placa || item.codigo_patrimonio) : '';
            return identificador ? `${descricao} (${identificador})` : descricao;
        };
    }
    
    // --- FUNÇÃO PARA VER DETALHES (E LISTAR ITENS) ---
    function verDetalhesTransacao(id) {
        // Busca dados no Python
        $.getJSON(`/get_transacao_detalhes/${id}`, function(data) {
            if(data.error) { alert(data.error); return; }

            // Preenche Cabeçalho
            $('#detalheTransacaoOrigem').text(data.origem);
            $('#detalheTransacaoId').text(data.id);
            $('#detalheTransacaoUvr').text(data.uvr);
            $('#detalheTransacaoDoc').text(data.doc);
            $('#detalheTransacaoData').text(data.data);
            $('#detalheTransacaoTipo').text(data.tipo);
            $('#detalheTransacaoAtividade').text(data.atividade);

            const patrimonioTexto = window.formatarDescricaoPatrimonio({
                descricao: data.patrimonio,
                placa: data.patrimonio_placa,
                codigo_patrimonio: data.patrimonio_codigo
            });
            if (data.id_patrimonio && patrimonioTexto) {
                $('#detalheTransacaoPatrimonio').text(patrimonioTexto);
                $('#detalheTransacaoPatrimonioContainer').show();
            } else {
                $('#detalheTransacaoPatrimonio').text('');
                $('#detalheTransacaoPatrimonioContainer').hide();
            }
            
            // Valor e Status
            const valorFmt = data.valor_total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            $('#detalheTransacaoValor').text(valorFmt);
            
            // Cor do valor
            if(data.tipo === 'Receita') $('#detalheTransacaoValor').removeClass('text-danger').addClass('text-success');
            else $('#detalheTransacaoValor').removeClass('text-success').addClass('text-danger');

            $('#detalheTransacaoStatus').text(data.status);

            window.ultimaTransacaoDetalhe = data;

            // Preenche Tabela de Itens
            const tbody = $('#tabelaItensDetalheBody');
            tbody.empty();
            
            if(data.itens && data.itens.length > 0) {
                data.itens.forEach(item => {
                    const vlrUnit = item.valor_unitario.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    const vlrTotal = item.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    
                    tbody.append(`
                        <tr>
                            <td>${item.descricao}</td>
                            <td class="text-center">${item.unidade}</td>
                            <td class="text-center">${item.quantidade}</td>
                            <td class="text-end">R$ ${vlrUnit}</td>
                            <td class="text-end fw-bold">R$ ${vlrTotal}</td>
                        </tr>
                    `);
                });
            } else {
                tbody.append('<tr><td colspan="5" class="text-center text-muted">Nenhum item detalhado.</td></tr>');
            }

            // Configura o botão de "Editar" para abrir o formulário principal com este ID
            $('#btnEditarNoModalTransacao').attr('onclick', `iniciarEdicaoTransacao(${data.id})`);

            // Abre o modal
            new bootstrap.Modal(document.getElementById('modalDetalhesTransacao')).show();

        }).fail(function() { alert("Erro ao carregar detalhes."); });
    }
    function cancelarEdicaoTransacao() {
        $('#transacaoForm')[0].reset();
        $('#transacaoForm').attr('action', '/registrar_transacao_financeira');
        $('#idTransacaoHidden').val('');
        $('#btnSalvarTransacao').text('REGISTRAR TRANSAÇÃO').removeClass('btn-warning').addClass('btn-success');
        $('#btnCancelarEdicaoTransacao').hide();
        atualizarPatrimonioTransacao();
        
        $('#itensDocumentoContainer').empty();
        adicionarItemLinha(); // Volta a ter 1 linha vazia
        
        mostrarFormulario('gestaoTransacoesContainer');
    }

    function solicitarExclusaoTransacao(id, docInfo) {
        if (confirm(`Tem certeza que deseja excluir a transação: ${docInfo}?

CUIDADO: Se houver pagamentos vinculados, a exclusão será bloqueada.`)) {
            $.ajax({
                url: `/excluir_transacao/${id}`,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'sucesso') {
                        alert(response.message);
                        buscarTransacoesGestao();
                    } else {
                        alert("Erro: " + (response.message || "Erro desconhecido."));
                    }
                },
                error: function(xhr) {
                    let msg = "Erro ao excluir.";
                    if (xhr.responseJSON && xhr.responseJSON.error) msg += "\n" + xhr.responseJSON.error;
                    alert(msg);
                }
            });
        }
    }
// --- FUNÇÕES DE CRUD DO FLUXO DE CAIXA (Adicione isto ao final do script) ---

function visualizarMovimentacao(id) {
        $.getJSON(`/get_movimentacao_detalhes/${id}`, function(data) {
            if(data.error) { alert(data.error); return; }
            
            // Preenche os novos campos
            $('#viewCaixaData').val(data.data);
            $('#viewCaixaDoc').val(data.documento_exibicao);
            $('#viewCaixaAtividade').val(data.atividade);
            
            const valorFmt = parseFloat(data.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            $('#viewCaixaValor').val(valorFmt);

            // Aviso visual de vínculo
            if(data.vinculado) {
                $('#viewCaixaInfoExtra').show();
            } else {
                $('#viewCaixaInfoExtra').hide();
            }

            new bootstrap.Modal(document.getElementById('modalVisualizarCaixa')).show();
        });
    }

    function excluirMovimentacao(id, desc) {
        if(confirm(`ATENÇÃO: Deseja realmente excluir/estornar este lançamento?\n\n"${desc}"\n\nSe ele estiver vinculado a uma Nota Fiscal, o status da nota voltará para "Aberto".`)) {
            $.ajax({
                url: `/excluir_movimentacao/${id}`,
                type: 'POST',
                success: function(res) {
                    if(res.status === 'sucesso') {
                        alert(res.message);
                        // Atualiza a tabela simulando um clique no botão de gerar
                        $('#btnGerarExtrato').click(); 
                    } else {
                        alert("Erro: " + res.error);
                    }
                },
                error: function(xhr) {
                    let msg = "Erro ao excluir.";
                    if (xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
                    else if (xhr.responseText) msg = xhr.responseText;
                    alert(msg);
                }
            });
        }
    }

// --- FUNÇÃO DE EXCLUSÃO DE TRANSAÇÃO ---
    function excluirTransacao(id, descricao) {
        if (confirm(`Tem certeza que deseja EXCLUIR permanentemente a transação:\n${descricao}?\n\nEssa ação não pode ser desfeita.`)) {
            
            $.post(`/excluir_transacao/${id}`, function(response) {
                if (response.message) {
                    alert(response.message);
                    buscarTransacoesGestao(); // Atualiza a tabela na hora
                } else {
                    alert("Erro desconhecido ao excluir.");
                }
            })
            .fail(function(xhr) {
                let msg = "Erro de comunicação.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                alert("Falha ao excluir: " + msg);
            });
        }
    }
// ==========================================
    // LÓGICA DE PATRIMÔNIO E FROTA (CRUD COMPLETO)
    // ==========================================

    // 1. Controle Visual (Show/Hide) dos Campos
    function ajustarCamposPatrimonio() {
        const cat = $('#categoriaBem').val();
        
        if (cat === 'Frota') {
            $('#divDadosVeiculo').show();
            // Pré-seleciona KM para frota se estiver vazio
            if (!$('select[name="controle_por"]').val()) $('select[name="controle_por"]').val('km');
        } else {
            $('#divDadosVeiculo').hide();
            // Limpa campos de veículo para não enviar lixo
            $('#divDadosVeiculo input').val('');
            // Sugere Horas se estiver vazio
            if (!$('select[name="controle_por"]').val()) $('select[name="controle_por"]').val('horas');
        }
    }

    function ajustarCamposPropriedade() {
        const sit = $('#situacaoPropriedade').val();
        if (sit === 'Comodato') {
            $('.div-comodato').show();
        } else {
            $('.div-comodato').hide();
            $('.div-comodato input').val('');
        }
    }

    // 2. Carregamento Dinâmico de Responsáveis por UVR
    function carregarAssociadosNaUvrPatrimonio(uvr) {
        const selects = $('.select-associado-uvr'); // Seleciona Resp e Operador
        selects.empty().append('<option value="">Carregando...</option>');

        if (!uvr) {
            selects.empty().append('<option value="">Selecione a UVR acima primeiro...</option>');
            return;
        }

        // Busca associados ATIVOS da UVR específica
        $.getJSON(`/buscar_associados?status=Ativo&uvr=${encodeURIComponent(uvr)}`, function(data) {
            selects.empty().append('<option value="">Selecione...</option>');
            if (data && data.length > 0) {
                data.forEach(assoc => {
                    selects.append(`<option value="${assoc.nome}">${assoc.nome}</option>`);
                });
            } else {
                selects.append('<option value="">Nenhum associado ativo encontrado nesta UVR.</option>');
            }
        }).fail(function() {
            selects.empty().append('<option value="">Erro ao carregar lista.</option>');
        });
    }

    // Evento: Quando muda a UVR, atualiza Associação e Lista de Pessoas
    $('#uvrPatrimonioSelect').change(function() {
        const uvr = $(this).val();
        
        // 1. Preenche visualmente a Associação
        const mapAssociacao = { "UVR 01": "ASCAMAR", "UVR 02": "ACAN" };
        $('#associacaoPatrimonioInput').val(mapAssociacao[uvr] || "");

        // 2. Recarrega os selects de responsáveis
        carregarAssociadosNaUvrPatrimonio(uvr);
    });

    // 3. Buscar e Listar Bens
    function buscarPatrimonio() {
        const q = $('#buscaPatrimonioInput').val();
        const cat = $('#filtroCategoriaPatrimonio').val();
        
        // Se usuário comum, filtra pela UVR dele. Se admin, pode ver tudo (se não filtrar).
        const uvr = (typeof usuarioLogadoUvr !== 'undefined' && usuarioLogadoUvr) ? usuarioLogadoUvr : '';

        $.getJSON('/buscar_patrimonio', { q: q, categoria: cat, uvr: uvr }, function(data) {
            const tbody = $('#tabelaPatrimonio tbody');
            tbody.empty();
            
            if (data.error) { alert(data.error); return; }
            if (data.length === 0) { tbody.append('<tr><td colspan="7" class="text-center">Nenhum bem encontrado.</td></tr>'); return; }

            data.forEach(item => {
                // Define o título do botão de excluir com base na permissão
                const tituloExcluir = usuarioIsAdmin ? 'Excluir' : 'Solicitar Exclusão';
                
                tbody.append(`
                    <tr>
                        <td><strong>${item.descricao}</strong><br><small class="text-muted">ID: ${item.id}</small></td>
                        <td>${item.categoria}<br><small>${item.tipo}</small></td>
                        <td>${item.placa}</td>
                        <td>${item.medidor} (${item.controle_por})</td>
                        <td>${item.responsavel}</td>
                        <td><span class="badge bg-${item.status === 'Ativo' ? 'success' : 'secondary'}">${item.status}</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info text-white me-1" onclick="visualizarPatrimonio(${item.id})" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning me-1" onclick="iniciarEdicaoPatrimonio(${item.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirPatrimonio(${item.id}, '${item.descricao}')" title="${tituloExcluir}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        });
    }

    // 4. Visualizar (Modal)
    function visualizarPatrimonio(id) {
        $.getJSON(`/get_patrimonio_detalhes/${id}`, function(data) {
            if(data.error) { alert(data.error); return; }

            // Preenche Geral
            $('#viewPatrimonioDescricao').text(data.descricao);
            $('#viewPatrimonioCodigo').text(data.codigo_patrimonio || '-');
            $('#viewPatrimonioStatus').text(data.status_bem)
                .removeClass('bg-success bg-secondary bg-warning bg-danger')
                .addClass('badge ' + (data.status_bem==='Ativo' ? 'bg-success' : 'bg-secondary'));
            
            // Foto
            if(data.foto_bem_base64 && data.foto_bem_base64.length > 100) {
                $('#viewPatrimonioFoto').attr('src', data.foto_bem_base64).show();
                $('#viewPatrimonioIcone').hide();
            } else {
                $('#viewPatrimonioFoto').hide();
                $('#viewPatrimonioIcone').show();
            }

            // Abas
            $('#viewPatrimonioUvr').text(data.uvr);
            $('#viewPatrimonioTipo').text(`${data.categoria} - ${data.tipo_bem}`);
            $('#viewPatrimonioPropriedade').text(`${data.situacao_propriedade} (${data.entidade_proprietaria})`);
            $('#viewPatrimonioPlaca').text(data.placa || (data.codigo_patrimonio ? 'Cód: '+data.codigo_patrimonio : '-'));

            $('#viewPatrimonioMarca').text(`${data.marca || ''} / ${data.modelo || ''}`);
            $('#viewPatrimonioAno').text(`Ano: ${data.ano_fabricacao || '-'} / Série: ${data.numero_serie_chassi || '-'}`);
            $('#viewPatrimonioCombustivel').text(data.combustivel || '-');
            $('#viewPatrimonioMedidor').text(`${data.medidor_atual || 0} ${data.controle_por}`);

            $('#viewPatrimonioResp').text(data.nome_responsavel || '-');
            $('#viewPatrimonioOp').text(data.nome_operador_principal || '-');
            $('#viewPatrimonioLocal').text(`${data.setor_uso || ''} - ${data.local_instalacao || ''}`);
            $('#viewPatrimonioObs').text(data.observacoes_gerais || 'Nenhuma observação registrada.');

            $('#btnEditarPatrimonioModal').attr('onclick', `iniciarEdicaoPatrimonio(${data.id})`);
            new bootstrap.Modal(document.getElementById('modalVisualizarPatrimonio')).show();
        });
    }

    // 5. Editar (Carregar no Form)
    function iniciarEdicaoPatrimonio(id) {
        var viewModalEl = document.getElementById('modalVisualizarPatrimonio');
        var viewModal = bootstrap.Modal.getInstance(viewModalEl);
        if(viewModal) viewModal.hide();

        $.getJSON(`/get_patrimonio_detalhes/${id}`, function(data) {
            if(data.error) { alert(data.error); return; }

            // Muda para a aba de cadastro
            var tabEl = document.querySelector('#tab-novo-patrimonio');
            var tab = new bootstrap.Tab(tabEl);
            tab.show();

            // Configura modo EDIÇÃO
            $('#formPatrimonio').attr('action', '/editar_patrimonio');
            
            // Cria input hidden para ID se não existir
            if ($('#idPatrimonioHidden').length === 0) {
                $('<input>').attr({type: 'hidden', id: 'idPatrimonioHidden', name: 'id_patrimonio'}).appendTo('#formPatrimonio');
            }
            $('#idPatrimonioHidden').val(data.id);

            // Muda botão e exibe se é Admin ou Usuário
            const textoBotao = usuarioIsAdmin ? 'SALVAR ALTERAÇÕES' : 'SOLICITAR ALTERAÇÃO';
            $('#formPatrimonio button[type="submit"]')
                .html(`<i class="fas fa-save"></i> ${textoBotao}`)
                .removeClass('btn-success').addClass('btn-warning');

            // Botão Cancelar
            if ($('#btnCancelarEdicaoPatrimonio').length === 0) {
                $('<button>').attr({type: 'button', id: 'btnCancelarEdicaoPatrimonio', class: 'btn btn-secondary ms-2'})
                             .html('<i class="fas fa-times"></i> CANCELAR')
                             .click(cancelarEdicaoPatrimonio)
                             .insertAfter('#formPatrimonio button[type="submit"]');
            }
            $('#btnCancelarEdicaoPatrimonio').show();

            // Preenche dados
            $('#uvrPatrimonioSelect').val(data.uvr).trigger('change');

            // Timeout para esperar o carregamento dos associados da UVR (via AJAX)
            setTimeout(() => {
                $('input[name="descricao_bem"]').val(data.descricao);
                $('#categoriaBem').val(data.categoria).trigger('change');
                $('select[name="tipo_bem"]').val(data.tipo_bem);
                
                $('input[name="marca_bem"]').val(data.marca);
                $('input[name="modelo_bem"]').val(data.modelo);
                $('input[name="ano_fabricacao"]').val(data.ano_fabricacao);
                $('input[name="serie_chassi"]').val(data.numero_serie_chassi);
                $('input[name="codigo_patrimonio"]').val(data.codigo_patrimonio);
                
                $('input[name="eh_bem_publico"]').prop('checked', data.eh_bem_publico);
                $('input[name="uso_compartilhado"]').prop('checked', data.uso_compartilhado);

                $('#situacaoPropriedade').val(data.situacao_propriedade).trigger('change');
                $('select[name="entidade_proprietaria"]').val(data.entidade_proprietaria);
                $('input[name="orgao_cedente"]').val(data.orgao_cedente);
                $('input[name="num_termo"]').val(data.numero_termo_comodato);
                $('input[name="data_inicio_comodato"]').val(data.data_inicio_comodato);
                $('input[name="data_fim_comodato"]').val(data.data_fim_comodato);

                $('input[name="placa"]').val(data.placa);
                $('input[name="renavam"]').val(data.renavam);
                $('select[name="combustivel"]').val(data.combustivel);
                $('input[name="capacidade_carga"]').val(data.capacidade_carga);

                $('select[name="controle_por"]').val(data.controle_por);
                $('input[name="medidor_inicial"]').val(data.medidor_inicial);
                
                $('select[name="local_instalacao"]').val(data.local_instalacao);
                $('select[name="setor_uso"]').val(data.setor_uso);

                $('select[name="nome_responsavel"]').val(data.nome_responsavel);
                $('select[name="nome_operador"]').val(data.nome_operador_principal);

                $('select[name="status_bem"]').val(data.status_bem);
                $('select[name="estado_conservacao"]').val(data.estado_conservacao);
                $('input[name="alerta_preventiva"]').val(data.alerta_preventiva);
                
                $('input[name="permite_abastecimento"]').prop('checked', data.permite_abastecimento);
                $('input[name="permite_manutencao"]').prop('checked', data.permite_manutencao);
                
                $('textarea[name="observacoes_gerais"]').val(data.observacoes_gerais);

                if (data.foto_bem_base64 && data.foto_bem_base64.length > 100) {
                    $('#previewFotoPatrimonio').attr('src', data.foto_bem_base64).show();
                    $('#textoSemFotoPatrimonio').hide();
                } else {
                    $('#previewFotoPatrimonio').hide();
                    $('#textoSemFotoPatrimonio').show();
                }

                $('html, body').animate({ scrollTop: $("#formPatrimonio").offset().top - 150 }, 500);

            }, 600);
        });
    }

    // 7. Cancelar Edição
    function cancelarEdicaoPatrimonio() {
        // Limpa form
        $('#formPatrimonio')[0].reset();
        
        // Restaura estado original (Modo Criação)
        $('#formPatrimonio').attr('action', '/cadastrar_patrimonio');
        $('#idPatrimonioHidden').val('');
        $('#formPatrimonio button[type="submit"]').html('<i class="fas fa-save"></i> SALVAR CADASTRO').removeClass('btn-warning').addClass('btn-success');
        $('#btnCancelarEdicaoPatrimonio').hide();
        
        // Limpa visualização da foto
        $('#previewFotoPatrimonio').hide().attr('src', '');
        $('#textoSemFotoPatrimonio').show();
        $('#fotoPatrimonioWebcamBase64').val('');
        
        // Retorna para a aba de lista
        var tabEl = document.querySelector('#tab-lista-patrimonio');
        var tab = new bootstrap.Tab(tabEl);
        tab.show();
    }

    // 6. Excluir (ou Solicitar Exclusão)
    function excluirPatrimonio(id, desc) {
        const msg = usuarioIsAdmin ? 
            `Tem certeza que deseja excluir o bem: ${desc}?\nEssa ação não pode ser desfeita.` : 
            `Deseja solicitar a exclusão do bem: ${desc}?\nO administrador precisará aprovar.`;

        if(confirm(msg)) {
            $.post(`/excluir_patrimonio/${id}`, function(res) {
                if(res.status === 'sucesso') {
                    // Exibe mensagem retornada pelo servidor (Excluído ou Solicitado)
                    alert(res.message);
                    buscarPatrimonio(); 
                } else {
                    alert('Erro: ' + res.error);
                }
            }).fail(function() { alert("Erro de comunicação com o servidor."); });
        }
    }

    // Inicialização da Tela
    $('#tab-novo-patrimonio').on('shown.bs.tab', function () {
        ajustarCamposPatrimonio(); ajustarCamposPropriedade();
    });
// --- FUNÇÃO RELÓGIO (Atualiza campos de data/hora - CORRIGIDA) ---
    function atualizarRelogio() {
        const d = new Date();
        // Monta a string manualmente para garantir formato dd/mm/aaaa HH:MM:SS
        const dia = String(d.getDate()).padStart(2, '0');
        const mes = String(d.getMonth() + 1).padStart(2, '0');
        const ano = d.getFullYear();
        const hora = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        const seg = String(d.getSeconds()).padStart(2, '0');
        
        const strDataHora = `${dia}/${mes}/${ano} ${hora}:${min}:${seg}`;
        
        // Atualiza campos do Cadastro de Cliente
        if($('#dataHoraCadastroCF').length) $('#dataHoraCadastroCF').val(strDataHora);
        
        // Atualiza campos do Fluxo de Caixa (Visual e Oculto)
        if($('#dataHoraFluxoVisual').length) $('#dataHoraFluxoVisual').val(strDataHora);
        if($('#dataHoraRegistroFluxo').length) $('#dataHoraRegistroFluxo').val(strDataHora);

        // Atualiza campos de Transação
        if($('#dataHoraCadastroTransacao').length) $('#dataHoraCadastroTransacao').val(strDataHora);
    }

    // Inicia o relógio a cada 1 segundo
    setInterval(atualizarRelogio, 1000);
    // Roda uma vez imediatamente ao carregar
    $(document).ready(function() {
        atualizarRelogio();
    });
// --- FUNÇÃO PARA BAIXAR RELATÓRIOS ---
    function baixarRelatorio(formato) {
        const uvr = $('#relUvr').val();
        const dataIni = $('#relDataInicial').val();
        const dataFim = $('#relDataFinal').val();
        const tipo = $('#relTipoTransacao').val();

        if (!dataIni || !dataFim) {
            alert("Gere o relatório na tela primeiro para validar as datas.");
            return;
        }

        // Redireciona o navegador para a rota de download
        const url = `/baixar_relatorio_financeiro?formato=${formato}&uvr=${uvr}&data_inicial=${dataIni}&data_final=${dataFim}&tipo=${tipo}`;
        window.location.href = url;
    }

    // Atualiza o botão Gerar para mostrar os botões de exportação após o sucesso
    $('#btnGerarRelatorio').click(function() {
        const dtIni = $('#relDataInicial').val();
        const dtFim = $('#relDataFinal').val();
        const tipo = $('#relTipoTransacao').val();
        const uvr = $('#relUvr').val(); 

        $('#botoesExportacaoRelatorio').hide(); // Esconde antes de carregar

        $.get(`/api/relatorio_financeiro_detalhado?data_inicial=${dtIni}&data_final=${dtFim}&tipo=${tipo}&uvr=${uvr}`, function(data) {
            
            let thead = $('#tabelaRelatorio thead');
            let tbody = $('#tabelaRelatorio tbody');
            thead.empty();
            tbody.empty();

            if(!data || data.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center">Nenhum dado encontrado.</td></tr>');
                return;
            }

            // Mostra os botões de exportação se houver dados
            $('#botoesExportacaoRelatorio').show();

            // ... (O restante do código de preencher a tabela continua igual ao anterior) ...
            let headers = `<tr><th>Data</th><th>UVR</th><th>Categoria</th><th>Descrição</th><th class="text-end">Valor (R$)</th></tr>`;
            thead.html(headers);
            let totalGeral = 0;
            data.forEach(item => {
                let valor = parseFloat(item.valor);
                totalGeral += valor;
                let cor = item.tipo === 'Receita' ? 'text-success' : 'text-danger';
                let row = `<tr><td>${item.data}</td><td>${item.uvr}</td><td><small class="fw-bold">${item.grupo}</small><br><small>${item.subgrupo}</small></td><td>${item.descricao}</td><td class="text-end ${cor} fw-bold">${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>`;
                tbody.append(row);
            });
            tbody.append(`<tr class="table-dark"><td colspan="4" class="text-end fw-bold">SALDO:</td><td class="text-end fw-bold">R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>`);
        });
    });
    function mostrarFormulario(idContainer) {
        $('.form-container').hide();
        $('#menuPrincipal').hide();
        if(idContainer === 'menuPrincipal') {
            $('#menuPrincipal').fadeIn();
        } else {
            $('#' + idContainer).fadeIn();
        }
    }
$(document).ready(function() {
        
        // ==========================================
        // 1. BUSCA AUTOMÁTICA DE CNPJ (BrasilAPI)
        // ==========================================
        $('#cnpjCliente').blur(function() {
            // Limpa a pontuação para pegar só os números
            var cnpj = $(this).val().replace(/\D/g, '');

            // Só pesquisa se tiver 14 dígitos
            if (cnpj.length === 14) {
                // Muda o cursor para "aguardando"
                $('body').css('cursor', 'wait');
                $('#cnpjCliente').addClass('is-valid'); // Fica verdinho visualmente

                // Consulta a API
                $.ajax({
                    url: 'https://brasilapi.com.br/api/cnpj/v1/' + cnpj,
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        // === Preenche os Dados da Empresa ===
                        $('input[name="razao_social"]').val(data.razao_social);
                        $('input[name="nome_fantasia"]').val(data.nome_fantasia); // Caso adicione este campo no futuro
                        $('input[name="tipo_atividade"]').val(data.cnae_fiscal_descricao);
                        $('input[name="telefone"]').val(data.ddd_telefone_1);

                        // === Preenche o Endereço Automaticamente também! ===
                        // A API do CNPJ já traz o endereço, então já preenchemos
                        $('#cepCliente').val(data.cep);
                        $('#logCliente').val(data.logradouro);
                        $('#bairroCliente').val(data.bairro);
                        $('input[name="numero"]').val(data.numero);
                        $('#cidadeCliente').val(data.municipio);
                        $('#ufCliente').val(data.uf);

                        // Restaura o cursor
                        $('body').css('cursor', 'default');
                    },
                    error: function() {
                        // Se der erro (CNPJ inválido ou fora do ar)
                        $('#cnpjCliente').removeClass('is-valid').addClass('is-invalid');
                        alert("CNPJ não encontrado ou inválido na Receita Federal.");
                        $('body').css('cursor', 'default');
                    }
                });
            }
        });

        // ==========================================
        // 2. BUSCA AUTOMÁTICA DE CEP (ViaCEP)
        // ==========================================
        // Caso o usuário digite o CEP manualmente ou seja Pessoa Física
        $('#cepCliente').blur(function() {
            var cep = $(this).val().replace(/\D/g, '');

            if (cep != "") {
                var validacep = /^[0-9]{8}$/;

                if(validacep.test(cep)) {
                    // Preenche com "..." enquanto carrega
                    $("#logCliente").val("...");
                    $("#bairroCliente").val("...");
                    $("#cidadeCliente").val("...");

                    $.getJSON("https://viacep.com.br/ws/"+ cep +"/json/?callback=?", function(dados) {
                        if (!("erro" in dados)) {
                            // Atualiza os campos com os valores da consulta
                            $("#logCliente").val(dados.logradouro);
                            $("#bairroCliente").val(dados.bairro);
                            $("#cidadeCliente").val(dados.localidade);
                            $("#ufCliente").val(dados.uf);
                            // Joga o foco para o número
                            $("input[name='numero']").focus();
                        } else {
                            alert("CEP não encontrado.");
                        }
                    });
                } else {
                    alert("Formato de CEP inválido.");
                }
            }
        });
    });
</script>
<div class="modal fade" id="modalPendencias" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-tasks"></i> Central de Aprovações</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="listaPendencias">
                <div class="text-center p-3"><div class="spinner-border text-primary"></div></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Função acionada pelo botão "Aprovações Pendentes"
function carregarPendenciasDoc() {
    var modal = new bootstrap.Modal(document.getElementById('modalPendencias'));
    modal.show();
    
    // Chama a API UNIFICADA que criamos no app.py
    $.get('/get_solicitacoes_pendentes', function(data) {
        var html = '';
        
        if (!data || data.length === 0) {
            html = '<div class="alert alert-success text-center m-3"><i class="fas fa-check-circle fa-2x mb-2"></i><br>Nenhuma pendência encontrada!</div>';
            $('#badgePendenciasDoc').hide();
        } else {
            $('#badgePendenciasDoc').text(data.length).show();
            
            data.forEach(function(item) {
                // Prepara dados
                var novos = item.dados_novos || {};
                // Verifica se é exclusão (converte para maiúsculo para garantir)
                var tipoUpper = (item.tipo || '').toString().toUpperCase();
                var isExclusao = tipoUpper === 'EXCLUSAO' || tipoUpper === 'EXCLUSÃO';
                var isDocumento = item.tabela === 'documentos';
                
                // Define cores e ícones do Cabeçalho
                var corHeader = isExclusao ? 'bg-danger' : (isDocumento ? 'bg-warning' : 'bg-secondary');
                var textoHeader = isDocumento ? 'DOCUMENTO: ' + (isExclusao ? 'EXCLUSÃO' : 'EDIÇÃO') : 'SOLICITAÇÃO: ' + item.tabela.toUpperCase();
                
                html += '<div class="card mb-3 shadow-sm border-0">';
                html += `<div class="card-header ${corHeader} text-white d-flex justify-content-between align-items-center">`;
                html += `<span><strong>${textoHeader}</strong></span>`;
                html += `<small>${item.solicitante} em ${item.data}</small></div>`;
                
                html += '<div class="card-body p-0">';
                
                // --- VISUALIZAÇÃO SE FOR DOCUMENTO ---
                if (isDocumento) {
                    if (isExclusao) {
                        html += '<div class="p-4 text-center text-danger bg-white">';
                        html += '<i class="fas fa-trash-alt fa-2x mb-2"></i>';
                        html += `<h5>Confirmar Exclusão do Arquivo?</h5>`;
                        html += `<p class="mb-0 text-muted">Arquivo: <strong>${item.nome_atual}</strong></p>`;
                        html += '</div>';
                    } else {
                        // Tabela de Dados Novos (Edição)
                        html += '<div class="p-3">';
                        html += '<div class="alert alert-warning py-1 mb-2"><small><i class="fas fa-info-circle"></i> O usuário propôs as seguintes alterações:</small></div>';
                        html += '<table class="table table-sm table-bordered mb-0">';
                        html += '<thead class="table-light"><tr><th>Campo</th><th>Novo Valor Proposto</th></tr></thead><tbody>';
                        
                        // Função interna para criar linhas da tabela
                        function row(label, val, isMoney) {
                            if (!val) return ''; // Só mostra o que foi preenchido
                            if (isMoney) val = 'R$ ' + val;
                            return `<tr><td class="text-muted fw-bold" width="40%">${label}</td><td class="fw-bold text-primary">${val}</td></tr>`;
                        }

                        html += row('Competência', novos.competencia);
                        html += row('Validade', novos.data_validade);
                        html += row('Valor', novos.valor, true);
                        html += row('Nº Referência', novos.numero_referencia);
                        html += row('Observações', novos.observacoes);
                        
                        html += '</tbody></table>';
                        html += `<div class="mt-2 text-muted small">Arquivo Original: ${item.nome_atual}</div>`;
                        html += '</div>';
                    }
                } 
                // --- VISUALIZAÇÃO PARA OUTROS TIPOS (Transações, Associados, etc) ---
                else {
                    html += `<div class="p-3">`;
                    html += `<p><strong>Item Atual:</strong> ${item.nome_atual}</p>`;
                    html += `<p><strong>Alteração Proposta:</strong> ${item.nome_novo}</p>`;
                    // Se quiser mostrar detalhes técnicos das transações, pode expandir aqui depois
                    html += `</div>`;
                }

                html += '</div>'; // fim card-body

                // --- RODAPÉ COM AÇÕES (Unificado para todos) ---
                html += '<div class="card-footer bg-white text-end">';
                html += `<form action="/processar_solicitacao_doc" method="POST" style="display:inline;">
                            <input type="hidden" name="id_solicitacao" value="${item.id}">
                            
                            <button type="submit" name="acao" value="rejeitar" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="fas fa-times"></i> Rejeitar
                            </button>
                            
                            <button type="submit" name="acao" value="aprovar" class="btn ${isExclusao ? 'btn-danger' : 'btn-success'} btn-sm">
                                <i class="fas fa-check"></i> ${isExclusao ? 'Confirmar Exclusão' : 'Aprovar'}
                            </button>
                         </form>`;
                html += '</div></div>';
            });
        }
        $('#listaPendencias').html(html);
    });
}

// Verifica pendências automaticamente ao carregar a página
$(document).ready(function(){
    // Garante que o badge comece oculto
    $('#badgePendenciasDoc').hide();
    
    $.get('/get_solicitacoes_pendentes', function(data) {
        if(data && data.length > 0) {
            $('#badgePendenciasDoc').text(data.length).show();
        }
    });
});
    // ==========================================
    // 1. FUNÇÕES GERAIS E UTILITÁRIAS
    // ==========================================
    
    // --- RELÓGIO AUTOMÁTICO PARA DATAS ---
    var intervaloRelogio;

    function iniciarRelogio() {
        if(intervaloRelogio) clearInterval(intervaloRelogio);
        
        function atualizar() {
            var now = new Date();
            
            // Construção manual para garantir formato DD/MM/YYYY HH:MM:SS
            var dia = String(now.getDate()).padStart(2, '0');
            var mes = String(now.getMonth() + 1).padStart(2, '0');
            var ano = now.getFullYear();
            var hora = String(now.getHours()).padStart(2, '0');
            var min = String(now.getMinutes()).padStart(2, '0');
            var seg = String(now.getSeconds()).padStart(2, '0');
            
            var dataFormatada = `${dia}/${mes}/${ano} ${hora}:${min}:${seg}`;

            // 1. Associado (Apenas se for Novo Cadastro)
            // Lógica: Se o ID estiver vazio, é novo, então atualiza o relógio.
            // Se tiver ID preenchido, significa que é EDIÇÃO, então para de atualizar para manter a data original.
            if($('#idAssociadoHidden').length > 0 && $('#idAssociadoHidden').val() === '') {
                if($('#visualDataCadastroAssociado').length) $('#visualDataCadastroAssociado').val(dataFormatada);
                if($('#inputDataCadastroAssociado').length) $('#inputDataCadastroAssociado').val(dataFormatada);
            }
            
            // 2. Fluxo de Caixa (Sempre atualiza para novo registro se existir na tela)
            if($('#dataHoraFluxoVisual').length) $('#dataHoraFluxoVisual').val(dataFormatada);
            if($('#dataHoraRegistroFluxo').length) $('#dataHoraRegistroFluxo').val(dataFormatada);
        }
        
        atualizar();
        intervaloRelogio = setInterval(atualizar, 1000);
    }
    
    // Inicia assim que a página carrega
    $(document).ready(function() {
        iniciarRelogio();
    });


/* =================================================================================
   1. CONTROLE DE NAVEGAÇÃO E FORMULÁRIOS
   ================================================================================= */

function mostrarFormulario(idForm, ignorarReset = false) {
    // Esconde tudo primeiro
    $('#menuPrincipal').hide();
    $('.form-container').hide();
    $('#' + idForm).fadeIn();

    // === LÓGICA PARA CLIENTE / FORNECEDOR ===
    if (idForm === 'clienteFornecedorForm' && !ignorarReset) {
        console.log("Abrindo formulário de Cliente (Novo)...");

        const form = $('#clienteFornecedorForm form');
        if (form.length > 0) {
            form[0].reset();
            $('#idClienteHidden').val(''); // Limpa ID para garantir que é um novo cadastro

            // Ajusta botão e ação para modo "Cadastrar"
            form.attr('action', '/cadastrar_cliente');
            form.find('button[type="submit"]').html('<i class="fas fa-save"></i> Salvar Cadastro').removeClass('btn-warning').addClass('btn-primary');

            // GERA A DATA E HORA ATUAL
            const now = new Date();
            const dia = String(now.getDate()).padStart(2, '0');
            const mes = String(now.getMonth() + 1).padStart(2, '0');
            const ano = now.getFullYear();
            const hora = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const dataFormatada = `${dia}/${mes}/${ano} ${hora}:${min}`;

            // Preenche os campos de data (visual e hidden)
            $('#visualDataCadastroCliente').val(dataFormatada);
            $('#inputDataCadastroCliente').val(dataFormatada);
        }
    }

    // === LÓGICA PARA ASSOCIADO ===
    if (idForm === 'associadoForm' && !ignorarReset) {
        console.log("Abrindo formulário de Associado (Novo)...");
        
        const form = $('#associadoForm form');
        if (form.length > 0) {
            form[0].reset();
            
            // Reseta área de foto
            $('#previewFoto').hide().attr('src', '');
            $('#fotoBase64').val('');
            $('#iconSemFotoAssociado').show();
            if (typeof fecharCamera === "function") fecharCamera();

            // Ajusta botão e ação para modo "Cadastrar"
            form.attr('action', '/cadastrar_associado');
            $('#idAssociadoHidden').val('');
            $('#btnSalvarAssociado').html('<i class="fas fa-save"></i> Salvar Associado').removeClass('btn-warning').addClass('btn-primary');
            $('#btnCancelarEdicaoAssociado').hide();

            // Preenche Associação se tiver UVR fixa
            setTimeout(function() {
                if (typeof atualizarAssociacaoAssociado === "function") atualizarAssociacaoAssociado();
            }, 100);
        }
    }
}

/* =================================================================================
   2. LÓGICA DE FOTO E CÂMERA (ASSOCIADO)
   ================================================================================= */

// 1. Processar Arquivo (Upload do Computador)
function processarArquivoFoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            redimensionarImagem(e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// 2. Abrir Câmera
function abrirCamera() {
    $('#areaCamera').slideDown();
    const video = document.getElementById('videoCamera');

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                video.srcObject = stream;
                window.localStream = stream; // Salva para fechar depois
            })
            .catch(function(err) {
                console.error("Erro Câmera:", err);
                alert("Erro ao abrir câmera. Verifique permissões ou HTTPS.");
                $('#areaCamera').hide();
            });
    } else {
        alert("Navegador sem suporte a câmera.");
    }
}

// 3. Tirar Foto
function tirarFoto() {
    const video = document.getElementById('videoCamera');
    const canvas = document.getElementById('canvasProcessamento');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    redimensionarImagem(dataUrl);
    fecharCamera();
}

// 4. Fechar Câmera
function fecharCamera() {
    $('#areaCamera').slideUp();
    if (window.localStream) {
        window.localStream.getTracks().forEach(track => track.stop());
        window.localStream = null;
    }
}

// 5. Remover Foto
function removerFoto() {
    $('#previewFoto').hide().attr('src', '');
    $('#iconSemFotoAssociado').show();
    $('#fotoBase64').val('');
    $('#inputFotoArquivo').val('');
}

// 6. Redimensionar Imagem (Otimização para Banco de Dados)
function redimensionarImagem(base64Str) {
    const img = new Image();
    img.src = base64Str;

    img.onload = function() {
        const canvas = document.getElementById('canvasProcessamento');
        const ctx = canvas.getContext('2d');

        const MAX_SIZE = 800; // Máximo 800px (leve e boa qualidade para crachá)
        let w = img.width;
        let h = img.height;

        if (w > h) {
            if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; }
        } else {
            if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; }
        }

        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);

        const novaBase64 = canvas.toDataURL('image/jpeg', 0.7); // Qualidade 70%

        $('#previewFoto').attr('src', novaBase64).show();
        $('#iconSemFotoAssociado').hide();
        $('#fotoBase64').val(novaBase64);
    };
}

/* =================================================================================
   3. AUTOMACÃO UVR -> ASSOCIAÇÃO
   ================================================================================= */

function getAssociacaoFromUVR(uvrValue) {
    if (!uvrValue) return '';
    let clean = uvrValue.toString().toUpperCase().replace(/\s+/g, '');
    if (clean === 'UVR01') return 'ASCAMAR';
    if (clean === 'UVR02') return 'ACAN';
    if (clean === 'UVR03') return 'COOPERLIN';
    return '';
}

function atualizarAssociacaoAssociado() {
    let $select = $('#uvrSelectAssociado');
    let $input = $('#uvrInputAssociado');
    let $alvo = $('#associacaoInput');
    let uvr = '';

    if ($select.length > 0 && $select.is(':visible')) {
        uvr = $select.val();
    } else if ($input.length > 0) {
        uvr = $input.val();
    }

    let assoc = getAssociacaoFromUVR(uvr);
    $alvo.val(assoc);
}

/* =================================================================================
   4. CEP E ENDEREÇO
   ================================================================================= */

// Busca CEP Específico para Associado
function setupBuscaCepAssociado() {
    $('#cepAssociado').blur(function() {
        var cep = $(this).val().replace(/\D/g, '');
        if (cep != "") {
            $.getJSON("https://viacep.com.br/ws/" + cep + "/json/?callback=?", function(dados) {
                if (!("erro" in dados)) {
                    $("#logradouroAssociado").val(dados.logradouro);
                    $("#bairroAssociado").val(dados.bairro);
                    $("#cidadeAssociado").val(dados.localidade);
                    $("#ufAssociado").val(dados.uf);
                    $("input[name='endereco_numero']").focus();
                } else {
                    alert("CEP não encontrado.");
                }
            });
        }
    });
}

// Busca CEP Genérica (Para Cliente/Fornecedor)
function buscarEndereco(idCep, idLog, idBairro, idCidade, idUf) {
    var cep = $('#' + idCep).val().replace(/\D/g, '');
    if (cep != "") {
        $.getJSON("https://viacep.com.br/ws/" + cep + "/json/?callback=?", function(dados) {
            if (!("erro" in dados)) {
                $('#' + idLog).val(dados.logradouro);
                $('#' + idBairro).val(dados.bairro);
                $('#' + idCidade).val(dados.localidade);
                $('#' + idUf).val(dados.uf);
            }
        });
    }
}

/* =================================================================================
   5. FUNÇÕES DO ASSOCIADO (Visualizar, Editar, Imprimir)
   ================================================================================= */

/* =================================================================================
   FUNÇÕES ESPECÍFICAS DE ASSOCIADOS (BUSCAR, VISUALIZAR, EDITAR, EXCLUIR)
   ================================================================================= */

/* =================================================================================
   GERENCIAMENTO DE ASSOCIADOS (BUSCA, VISUALIZAÇÃO, EDIÇÃO E EXCLUSÃO)
   ================================================================================= */

function buscarAssociados() {
    const termo = $('#inputBuscaAssociado').val();
    const status = $('#filtroStatusAssociado').val();
    const uvr = $('#filtroUvrAssociado').length ? $('#filtroUvrAssociado').val() : '';
    
    // --- NOVO: Captura o valor do filtro de função ---
    const funcao = $('#filtroFuncaoAssociado').val(); 

    // Ajustado colspan para 7 colunas (para cobrir a nova coluna Função)
    $('#tabelaAssociadosBody').html('<tr><td colspan="7" class="text-center">Buscando...</td></tr>');

    // --- NOVO: Envia &funcao=${funcao} para o servidor ---
    $.getJSON(`/buscar_associados?q=${termo}&status=${status}&uvr=${uvr}&funcao=${funcao}`, function(data) {
        const tbody = $('#tabelaAssociadosBody');
        tbody.empty();
        
        if (!data || data.length === 0) {
            tbody.html('<tr><td colspan="7" class="text-center">Nenhum associado encontrado.</td></tr>');
            return;
        }
        
        data.forEach(assoc => {
            let badgeClass = 'bg-secondary';
            if (assoc.status === 'Ativo') badgeClass = 'bg-success';
            else if (assoc.status === 'Inativo') badgeClass = 'bg-danger';
            else if (assoc.status === 'Suspenso') badgeClass = 'bg-warning text-dark';
            else if (assoc.status === 'Afastado') badgeClass = 'bg-info text-white';

            tbody.append(`
                <tr>
                    <td>${assoc.nome}</td>
                    <td>${assoc.cpf}</td>
                    <td><span class="badge ${badgeClass}">${assoc.status}</span></td>
                    <td>${assoc.funcao || '<small class="text-muted">-</small>'}</td> <td>${assoc.uvr}</td>
                    <td>${assoc.data_admissao || '-'}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-info text-white" title="Ver" onclick="visualizarAssociado(${assoc.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-warning text-white" title="Editar" onclick="iniciarEdicaoAssociado(${assoc.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" title="Excluir" onclick="confirmarExclusaoAssociado(${assoc.id}, '${assoc.nome.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `);
        });
    }).fail(function() {
        $('#tabelaAssociadosBody').html('<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados.</td></tr>');
    });
}

function visualizarAssociado(id) {
    // --- DEBUG: Mostra no console qual ID está chegando ---
    console.log("Tentando buscar associado com ID:", id);
    
    if (!id) {
        alert("Erro: ID do associado inválido ou vazio!");
        return;
    }

    // 1. Limpeza visual imediata antes de carregar
    $('#verAssocFoto').hide().attr('src', '');
    $('#verAssocIcone').show();
    $('#verAssocFuncao').text('Carregando...'); 

    // 2. Busca os dados no servidor
    $.getJSON(`/get_associado/${id}`, function(data) {
        
        if (data.error) { alert("Erro: " + data.error); return; }

        // 3. Preenchimento dos textos
        $('#verAssocNome').text(data.nome || '---');
        $('#verAssocUvr').text(data.uvr || '---');
        $('#verAssocCpf').text(data.cpf || '---');
        $('#verAssocRg').text(data.rg || '---');
        
        // Formata data de YYYY-MM-DD para DD/MM/YYYY
        let nasc = data.data_nascimento ? data.data_nascimento.split('-').reverse().join('/') : '---';
        $('#verAssocNasc').text(nasc);
        
        let adm = data.data_admissao ? data.data_admissao.split('-').reverse().join('/') : '---';
        $('#verAssocAdm').text(adm);

        $('#verAssocTel').text(data.telefone || '---');
        $('#verAssocStatus').text(data.status || '---');
        
        // --- Preenche a Função ---
        $('#verAssocFuncao').text(data.funcao || 'Não informada'); 

        const endereco = `${data.logradouro || ''}, ${data.numero || 'S/N'} - ${data.bairro || ''}`;
        $('#verAssocEndereco').text(endereco);

        // 4. Lógica da Foto
        if (data.foto_base64 && data.foto_base64.length > 50) {
            let src = data.foto_base64;
            if (!src.startsWith('data:image') && !src.startsWith('http')) src = 'data:image/jpeg;base64,' + src;
            $('#verAssocFoto').attr('src', src).show();
            $('#verAssocIcone').hide();
        } else {
            $('#verAssocFoto').hide();
            $('#verAssocIcone').show();
        }

        // 5. Configura botões de ação do Modal
        $('#btnImprimirNoModal').attr('onclick', `imprimirFichaAssociado(${data.id})`);
        $('#btnEditarNoModal').attr('onclick', `iniciarEdicaoAssociado(${data.id})`);

        // 6. Abre o Modal (Bootstrap 5)
        var modalElement = document.getElementById('modalVisualizarAssociado');
        var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        modal.show();

    }).fail(function() { 
        alert("Erro ao carregar dados do servidor (Verifique se o servidor está rodando)."); 
    });
}

function iniciarEdicaoAssociado(id) {
    $.getJSON(`/get_associado/${id}`, function(data) {
        if (data.error) { alert(data.error); return; }

        mostrarFormulario('associadoForm', true); // true para não resetar campos (mantém visibilidade)
        const form = $('#associadoForm form');

        // Garante input hidden com ID correto
        form.find('input[name="id_associado"]').remove();
        form.append(`<input type="hidden" name="id_associado" value="${id}">`);
        $('#idAssociadoHidden').val(id);
        
        form.attr('action', '/editar_associado');

        // Preenche os campos
        form.find('input[name="nome"]').val(data.nome);
        form.find('input[name="cpf"]').val(data.cpf);
        form.find('input[name="rg"]').val(data.rg);
        form.find('input[name="uvr"]').val(data.uvr);
        form.find('input[name="data_nascimento"]').val(data.data_nascimento); // Input type=date espera YYYY-MM-DD
        form.find('input[name="data_admissao"]').val(data.data_admissao);
        
        form.find('input[name="cep"]').val(data.cep);
        form.find('input[name="logradouro"]').val(data.logradouro);
        form.find('input[name="endereco_numero"]').val(data.numero);
        form.find('input[name="bairro"]').val(data.bairro);
        form.find('input[name="cidade"]').val(data.cidade);
        form.find('input[name="uf"]').val(data.uf);
        form.find('input[name="telefone"]').val(data.telefone);
        form.find('select[name="status"]').val(data.status);
        
        // --- Preenche o Campo Função ---
        form.find('select[name="funcao"]').val(data.funcao); 

        if (data.data_cadastro) {
            $('#visualDataCadastroAssociado').val(data.data_cadastro);
            $('#inputDataCadastroAssociado').val(data.data_cadastro);
        }

        // Tenta atualizar a lista de Associações baseada na UVR
        setTimeout(atualizarAssociacaoAssociado, 200);

        // Carrega Foto
        if (data.foto_base64 && data.foto_base64.length > 50) {
            let src = data.foto_base64;
            if (!src.startsWith('data:image') && !src.startsWith('http')) src = 'data:image/jpeg;base64,' + src;
            $('#previewFoto').attr('src', src).show();
            $('#iconSemFotoAssociado').hide();
            $('#fotoBase64').val(src);
        } else {
            removerFoto();
        }

        // Muda visual do botão salvar
        $('#btnSalvarAssociado').html('<i class="fas fa-sync-alt"></i> Salvar Alterações').removeClass('btn-primary').addClass('btn-warning');
        
        // Fecha modal de visualização se estiver aberto
        var modalElement = document.getElementById('modalVisualizarAssociado');
        var modal = bootstrap.Modal.getInstance(modalElement);
        if(modal) modal.hide();

    }).fail(function() { alert("Erro ao buscar dados para edição."); });
}

function imprimirFichaAssociado(id) {
    if (!id) return;
    window.open(`/imprimir_ficha_associado/${id}`, '_blank');
}

// Botão de Excluir Associado (Inteligente)
function confirmarExclusaoAssociado(id, nome) {
    // 1. Pergunta de segurança
    if (!confirm(`Tem certeza que deseja excluir (ou solicitar exclusão) do associado: ${nome}?`)) {
        return;
    }

    // 2. Chama a rota correta do Python
    $.post(`/excluir_associado/${id}`, function(resposta) {
        
        // Pode ser 'sucesso' (string simples) ou um JSON {status: 'sucesso', message: '...'}
        // O código Python antigo retornava string em alguns casos, vamos garantir.
        
        if (resposta && (resposta.status === 'sucesso' || resposta.message)) {
            let msg = resposta.message || resposta; // fallback se for string
            alert("✅ " + msg);
            buscarAssociados(); // Atualiza a tabela
        } else {
            alert("ℹ️ Solicitação enviada ou erro desconhecido.");
            buscarAssociados();
        }

    }).fail(function(xhr) {
        // Tenta pegar a mensagem de erro específica do Python, se houver
        let msg = "Erro de comunicação com o servidor.";
        if(xhr.responseJSON && xhr.responseJSON.error) {
            msg = "Erro: " + xhr.responseJSON.error;
        } else if (xhr.responseText) {
             // As vezes o servidor devolve erro em texto puro
             msg = "Erro: " + xhr.responseText;
        }
        alert(msg);
    });
}

/* =================================================================================
   6. FUNÇÕES DO CLIENTE/FORNECEDOR (Visualizar, Editar, Excluir)
   ================================================================================= */

function visualizarCadastro(id) {
    $.getJSON(`/get_cliente/${id}`, function(data) {
        if (data.error) { alert("Erro: " + data.error); return; }

        $('#verCadRazao').text(data.razao_social || 'Sem Nome');
        $('#verCadTipo').text(data.tipo_cadastro || 'Geral');
        $('#verCadCnpj').text(data.cnpj || '-');
        $('#verCadTel').text(data.telefone || '-');
        $('#verCadData').text(data.data_hora_cadastro || '-');
        $('#verCadUvr').text(data.uvr || 'Todas');

        const numero = data.numero ? `, Nº ${data.numero}` : '';
        $('#verCadLogradouro').text((data.logradouro || '') + numero);
        $('#verCadBairro').text(data.bairro || '');
        $('#verCadCidadeUF').text(`${data.cidade || ''} - ${data.uf || ''}`);
        $('#verCadCep').text(data.cep || '');

        var modalElement = document.getElementById('modalVisualizarCadastro');
        var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        modal.show();
    }).fail(function() { alert("Erro de conexão com o servidor."); });
}

function iniciarEdicaoCadastro(id) {
    $.getJSON(`/get_cliente/${id}`, function(data) {
        if (data.error) { alert(data.error); return; }

        mostrarFormulario('clienteFornecedorForm', true);
        const form = $('#clienteFornecedorForm form');

        $('#idClienteHidden').val(data.id);
        
        form.find('select[name="uvr"]').val(data.uvr);
        form.find('select[name="tipo_cadastro"]').val(data.tipo_cadastro);
        form.find('input[name="razao_social"]').val(data.razao_social);
        form.find('input[name="cnpj"]').val(data.cnpj);
        form.find('input[name="telefone"]').val(data.telefone);
        
        form.find('input[name="cep"]').val(data.cep);
        form.find('input[name="logradouro"]').val(data.logradouro);
        form.find('input[name="numero"]').val(data.numero);
        form.find('input[name="bairro"]').val(data.bairro);
        form.find('input[name="cidade"]').val(data.cidade);
        form.find('input[name="uf"]').val(data.uf);

        form.attr('action', '/editar_cliente');
        form.find('button[type="submit"]').html('<i class="fas fa-sync-alt"></i> Salvar Alterações (Solicitar)');
        
        var modalElement = document.getElementById('modalVisualizarCadastro');
        var modal = bootstrap.Modal.getInstance(modalElement);
        if(modal) modal.hide();

    }).fail(function() { alert("Erro ao buscar dados para edição."); });
}

function solicitarExclusaoCadastro(id, nome) {
    if (confirm(`ATENÇÃO:\n\nDeseja excluir (ou solicitar exclusão) de:\n"${nome}"?`)) {
        $.post(`/excluir_cadastro/${id}`, function(response) {
            alert(response.message);
            if (typeof buscarCadastros === "function") buscarCadastros(); // Atualiza tabela se existir a função
            else location.reload();
        }).fail(function(xhr) {
            let msg = xhr.responseJSON ? xhr.responseJSON.error : "Erro desconhecido";
            alert("Erro: " + msg);
        });
    }
}

function imprimirFichaCadastro(id) {
    if (!id) return;
    window.open(`/imprimir_ficha_cliente/${id}`, '_blank');
}

/* =================================================================================
   7. INICIALIZAÇÃO GLOBAL (DOCUMENT READY)
   ================================================================================= */
$(document).ready(function() {
    
    // 1. Aplica Máscaras (jQuery Mask Plugin)
    if ($.fn.mask) {
        $('.cpf-mask').mask('000.000.000-00');
        $('.cep-mask').mask('00000-000');
        $('.phone-mask').mask('(00) 00000-0000');
        $('.cnpj-mask').mask('00.000.000/0000-00');
    }

    // 2. Eventos de UVR
    $(document).on('change', '#uvrSelectAssociado', function() {
        atualizarAssociacaoAssociado();
    });
    atualizarAssociacaoAssociado(); // Executa ao carregar

    // 3. Inicializa Busca de CEP do Associado
    setupBuscaCepAssociado();

});
</script>
</body>
</html>